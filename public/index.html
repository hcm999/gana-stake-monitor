<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>GANAè´¨æŠ¼æ•°æ®å±•ç¤ºç«¯</title>
    <!-- å¼•å…¥ Bootstrap ç”¨äºå¿«é€Ÿå¸ƒå±€ -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- å¼•å…¥ Chart.js è½»é‡å›¾è¡¨åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- å¼•å…¥ Ethers.js V6 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body { 
            background-color: #0f172a; 
            color: #e2e8f0; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            padding: 12px;
            min-height: 100vh;
        }
        
        .container-fluid {
            max-width: 100%;
            margin: 0 auto;
            padding: 0;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 16px;
        }
        
        @media (min-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
                gap: 16px;
            }
        }
        
        .stat-card {
            background: linear-gradient(145deg, #1e293b, #0f172a);
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 10px 6px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        
        .stat-title {
            color: #94a3b8;
            font-size: 0.65rem;
            text-transform: uppercase;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .stat-value {
            color: #38bdf8;
            font-size: 1rem;
            font-weight: bold;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            line-height: 1.2;
            margin-bottom: 2px;
            word-break: break-word;
        }
        
        @media (min-width: 768px) {
            .stat-value {
                font-size: 1.6rem;
            }
        }
        
        .stat-sub {
            color: #4ade80;
            font-size: 0.6rem;
            display: flex;
            justify-content: space-between;
        }
        
        .stats-badge {
            display: inline-block;
            background-color: #1e293b;
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 2px 8px;
            font-size: 0.65rem;
            color: #94a3b8;
            white-space: nowrap;
        }
        
        .badge-duration { 
            padding: 3px 8px; 
            border-radius: 16px; 
            font-size: 0.7rem;
            white-space: nowrap;
            display: inline-block;
            font-weight: 600;
        }
        
        .badge-1d { 
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white; 
        }
        .badge-15d { 
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
        }
        .badge-30d { 
            background: linear-gradient(135deg, #ec4899, #db2777);
            color: white;
        }
        
        .table-container {
            background: linear-gradient(145deg, #1e293b, #0f172a);
            border-radius: 16px;
            padding: 12px;
            border: 1px solid #334155;
            margin-top: 16px;
        }
        
        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin: 0 -12px;
            padding: 0 12px;
            width: calc(100% + 24px);
        }
        
        .table { 
            color: #e2e8f0; 
            font-size: 0.8rem; 
            width: 100%;
            min-width: 100%;
            border-collapse: collapse;
        }
        
        .table thead th { 
            border-bottom: 2px solid #334155; 
            color: #94a3b8; 
            font-size: 0.7rem; 
            padding: 12px 4px;
            text-align: center;
            font-weight: 600;
            white-space: nowrap;
        }
        
        .table td { 
            border-bottom: 1px solid #334155; 
            padding: 10px 4px;
            text-align: center;
            vertical-align: middle;
        }
        
        .address-cell {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            font-size: 0.75rem;
            color: #60a5fa;
            cursor: pointer;
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .amount-cell {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            font-size: 0.75rem;
            color: #38bdf8;
            font-weight: 600;
        }
        
        .time-two-lines {
            display: flex;
            flex-direction: column;
            line-height: 1.4;
            font-size: 0.7rem;
        }
        .time-date {
            color: #94a3b8;
        }
        .time-clock {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            color: #38bdf8;
        }
        
        .status-unlocked { color: #4ade80; font-weight: 500; }
        .status-locked { color: #f87171; font-weight: 500; }
        
        .header {
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid #334155;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .header h1 {
            font-size: 1.3rem;
            font-weight: bold;
            background: linear-gradient(135deg, #60a5fa, #c084fc);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 4px;
            line-height: 1.2;
        }
        
        @media (min-width: 768px) {
            .header h1 {
                font-size: 1.5rem;
            }
        }
        
        .header .subtitle {
            color: #94a3b8;
            font-size: 0.7rem;
        }
        
        .viewer-badge {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 600;
            border: 1px solid #60a5fa;
            white-space: nowrap;
        }
        
        .contract-address {
            font-family: 'Courier New', monospace;
            background: #1e293b;
            border: 1px solid #334155;
            padding: 4px 8px;
            border-radius: 20px;
            color: #60a5fa;
            font-size: 0.6rem;
            display: inline-block;
            margin-top: 8px;
            word-break: break-all;
        }
        
        .btn-export {
            background-color: #334155;
            border: 1px solid #475569;
            padding: 8px 16px;
            border-radius: 20px;
            color: #e2e8f0;
            font-size: 0.8rem;
            cursor: pointer;
            width: 100%;
            touch-action: manipulation;
            min-height: 44px;
        }
        
        @media (min-width: 768px) {
            .btn-export {
                width: auto;
            }
        }
        
        .stats-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .stats-info h5 {
            font-size: 1rem;
            margin: 0;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 12px;
            color: #64748b;
            font-size: 0.9rem;
        }
        
        .data-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            border-bottom: 1px solid #334155;
            padding-bottom: 10px;
            flex-wrap: wrap;
        }
        .data-tab {
            background-color: transparent;
            border: 1px solid #475569;
            color: #94a3b8;
            padding: 10px 16px;
            border-radius: 30px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
            touch-action: manipulation;
            min-height: 44px;
            -webkit-tap-highlight-color: transparent;
            flex: 1;
            text-align: center;
        }
        .data-tab:hover {
            background-color: #334155;
            color: #e2e8f0;
        }
        .data-tab.active {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            border-color: #60a5fa;
            color: white;
        }
        
        .data-panel {
            display: none;
        }
        .data-panel.active {
            display: block;
        }
        
        .chart-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 16px;
            margin-bottom: 16px;
        }
        @media (min-width: 992px) {
            .chart-grid {
                grid-template-columns: 1fr 1fr;
            }
        }
        .chart-card {
            background: linear-gradient(145deg, #1e293b, #0f172a);
            border: 1px solid #334155;
            border-radius: 16px;
            padding: 16px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        .chart-title {
            color: #94a3b8;
            font-size: 0.9rem;
            margin-bottom: 12px;
        }
        .chart-container {
            position: relative;
            height: 200px;
            width: 100%;
        }
        
        @media (min-width: 768px) {
            .chart-container {
                height: 260px;
            }
        }
        
        .status-bar {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 30px;
            padding: 12px 16px;
            margin: 20px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .last-update {
            color: #94a3b8;
            font-size: 0.8rem;
        }
        
        .last-update span {
            color: #4ade80;
            font-weight: 600;
        }
        
        .btn-refresh {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            border: none;
            padding: 10px 16px;
            border-radius: 30px;
            color: white;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            touch-action: manipulation;
            min-height: 44px;
            min-width: 100px;
        }
        
        .btn-refresh:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-lp-small {
            background: linear-gradient(135deg, #10b981, #059669);
            border: 1px solid #34d399;
            padding: 8px 12px;
            border-radius: 30px;
            color: white;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            touch-action: manipulation;
            min-height: 40px;
            min-width: 90px;
            white-space: nowrap;
        }
        
        .btn-lp-small:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(16, 185, 129, 0.4);
        }
        
        .btn-lp-small:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        #resultTableBody td.amount-cell {
            color: #38bdf8 !important;
        }

        #dailyStatsBody tr td:nth-child(2) {
            color: #38bdf8 !important;
        }

        #dailyStatsBody tr td:nth-child(3) {
            color: #4ade80 !important;
        }

        #dailyStatsBody tr td:nth-child(4) {
            color: #38bdf8 !important;
        }

        #dailyStatsBody tr td:nth-child(5) {
            color: #fbbf24 !important;
        }

        #dailyStatsBody tr td:nth-child(6) {
            color: #f87171 !important;
        }

        #resultTableBody .amount-cell,
        #dailyStatsBody td {
            font-size: 0.75rem;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 23, 42, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            backdrop-filter: blur(5px);
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid #334155;
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .loading-text {
            color: #e2e8f0;
            margin-top: 20px;
            font-size: 1rem;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @keyframes slideDown {
            from { transform: translate(-50%, -100%); opacity: 0; }
            to { transform: translate(-50%, 0); opacity: 1; }
        }
        
        @keyframes fadeOut {
            to { opacity: 0; }
        }
        
        /* æˆæƒå¼¹çª—æ ·å¼ */
        .auth-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(10px);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
            padding: 10px;
        }
        
        .auth-dialog {
            background: linear-gradient(145deg, #1e293b, #0f172a);
            border: 2px solid #334155;
            border-radius: 24px;
            padding: 20px;
            max-width: 450px;
            width: 100%;
            max-height: 85vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.7);
            animation: slideUp 0.4s ease;
        }
        
        .auth-tab {
            flex: 1;
            padding: 12px 5px;
            background: #334155;
            border: none;
            border-radius: 30px;
            color: #94a3b8;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.9rem;
            touch-action: manipulation;
            min-height: 44px;
        }
        
        .auth-tab.active {
            background: #3b82f6;
            color: white;
        }
        
        .auth-panel {
            transition: all 0.3s ease;
        }
        
        .day-option {
            padding: 10px 3px;
            background: #334155;
            border: 1px solid #475569;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            touch-action: manipulation;
            min-height: 60px;
        }
        
        .day-option.active {
            background: #3b82f6;
            border-color: #60a5fa;
        }
        
        .day-option:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(59,130,246,0.3);
        }
        
        .day-option span:first-child {
            font-size: 0.95rem;
        }
        
        .day-option span:last-child {
            font-size: 0.7rem;
            color: #94a3b8;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        /* æ‰‹æœºç«¯ä¼˜åŒ– */
        @media (max-width: 768px) {
            .auth-dialog {
                padding: 16px;
            }
            
            .auth-tab {
                font-size: 0.8rem;
                padding: 10px 3px;
            }
            
            .day-option {
                padding: 8px 2px;
                min-height: 50px;
            }
            
            .day-option span:first-child {
                font-size: 0.85rem;
            }
            
            .day-option span:last-child {
                font-size: 0.6rem;
            }
            
            button, .auth-tab, .day-option, #payBtn, #adminBtn, #closeBtn, .btn-lp-small, .btn-refresh, .data-tab {
                min-height: 44px;
                touch-action: manipulation;
            }
            
            input, button {
                font-size: 16px !important;
            }
            
            .header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .header > div:last-child {
                align-self: flex-end;
            }
            
            .status-bar {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .status-bar > div:last-child {
                align-self: flex-end;
            }
            
            .stats-grid {
                gap: 4px;
            }
            
            .stat-card {
                padding: 8px 4px;
            }
            
            .stat-value {
                font-size: 0.9rem;
            }
            
            .stat-title {
                font-size: 0.55rem;
            }
        }
        
        /* ç¡®ä¿æ‰€æœ‰å¯ç‚¹å‡»å…ƒç´ éƒ½æœ‰åˆé€‚çš„è§¦æ‘¸åŒºåŸŸ */
        button, .auth-tab, .day-option, .btn-lp-small, .btn-refresh, .btn-export, .data-tab, #payBtn, #adminBtn, #closeBtn {
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        /* ä¿®å¤iOSä¸Šinputæ ·å¼é—®é¢˜ */
        input {
            -webkit-appearance: none;
            border-radius: 30px;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- å¤´éƒ¨ -->
        <div class="header">
            <div style="width: 100%;">
                <h1>ğŸ” GANA è´¨æŠ¼æ•°æ®å±•ç¤ºç«¯ <span class="viewer-badge">æˆæƒè®¿é—®</span></h1>
                <div class="subtitle">å®æ—¶å±•ç¤ºäº‘ç«¯æ•°æ® Â· è‡ªåŠ¨åˆ·æ–°</div>
                <div class="contract-address" id="stakingContractAddress">0x72212F35aC448FE7763aA1BFdb360193Fa098E52</div>
            </div>
            <div style="width: 100%; display: flex; justify-content: flex-end; margin-top: 5px;">
                <button class="btn-lp-small" onclick="refreshLPPool()" id="refreshLPBtn">
                    ğŸ’° åˆ·æ–°LPæ± 
                </button>
            </div>
        </div>

        <!-- çŠ¶æ€æ  -->
        <div class="status-bar">
            <div class="last-update">
                ğŸ“… äº‘ç«¯æ•°æ®: <span id="lastUpdateTime">åŠ è½½ä¸­...</span>
            </div>
            <div style="display: flex; gap: 10px; width: 100%; justify-content: flex-end;">
                <button class="btn-refresh" onclick="refreshData()" id="refreshBtn">
                    ğŸ”„ åˆ·æ–°æ•°æ®
                </button>
            </div>
        </div>

        <!-- ç»Ÿè®¡å¡ç‰‡ - ç¬¬ä¸€è¡Œ -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-title">ğŸ’° æ€»è´¨æŠ¼é¢</div>
                <div class="stat-value" id="totalStaked">0.00</div>
                <div class="stat-sub">USDT</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">ğŸ’° 1å¤©è´¨æŠ¼é¢</div>
                <div class="stat-value" id="totalStaked1d">0.00</div>
                <div class="stat-sub">
                    <span id="count1d">0</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-title">ğŸ’° 15å¤©è´¨æŠ¼é¢</div>
                <div class="stat-value" id="totalStaked15d">0.00</div>
                <div class="stat-sub">
                    <span id="count15d">0</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-title">ğŸ’° 30å¤©è´¨æŠ¼é¢</div>
                <div class="stat-value" id="totalStaked30d">0.00</div>
                <div class="stat-sub">
                    <span id="count30d">0</span>
                </div>
            </div>
        </div>

        <!-- ç»Ÿè®¡å¡ç‰‡ - ç¬¬äºŒè¡Œ -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-title">ğŸ’° æœªæ¥2å¤©å¯èµå›</div>
                <div class="stat-value" id="unlock2d">0.00</div>
                <div class="stat-sub">USDT</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">ğŸ’° æœªæ¥7å¤©å¯èµå›</div>
                <div class="stat-value" id="unlock7d">0.00</div>
                <div class="stat-sub">USDT</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">ğŸ’° æœªæ¥15å¤©å¯èµå›</div>
                <div class="stat-value" id="unlock15d">0.00</div>
                <div class="stat-sub">USDT</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">ğŸ’° LPæ± ä½™é¢</div>
                <div class="stat-value" id="lpWithdrawable">0.00</div>
                <div class="stat-sub">USDT</div>
            </div>
        </div>

        <!-- æ•°æ®é€‰é¡¹å¡ -->
        <div class="data-tabs">
            <span class="data-tab active" onclick="switchDataTab('records')" id="tab-records">ğŸ“‹ è´¨æŠ¼è®°å½•</span>
            <span class="data-tab" onclick="switchDataTab('daily')" id="tab-daily">ğŸ“… æ¯æ—¥ç»Ÿè®¡</span>
            <span class="data-tab" onclick="switchDataTab('charts')" id="tab-charts">ğŸ“Š å›¾è¡¨</span>
        </div>

        <!-- è´¨æŠ¼è®°å½•é¢æ¿ -->
        <div id="panel-records" class="data-panel active">
            <div class="table-container">
                <div class="stats-info">
                    <h5>ğŸ“Š è´¨æŠ¼è®°å½• <span class="stats-badge" id="resultCount">0</span></h5>
                    <button class="btn-export" onclick="exportCSV()">
                        ğŸ“¥ å¯¼å‡ºCSV
                    </button>
                </div>
                
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>åœ°å€</th>
                                <th>é‡‘é¢</th>
                                <th>å‘¨æœŸ</th>
                                <th>è´¨æŠ¼æ—¶é—´</th>
                                <th>è§£é”æ—¶é—´</th>
                                <th>å‰©ä½™</th>
                                <th>çŠ¶æ€</th>
                            </tr>
                        </thead>
                        <tbody id="resultTableBody">
                            <tr>
                                <td colspan="8" class="empty-state">
                                    <div>â³ åŠ è½½äº‘ç«¯æ•°æ®ä¸­...</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- æ¯æ—¥ç»Ÿè®¡é¢æ¿ -->
        <div id="panel-daily" class="data-panel">
            <div class="table-container">
                <div class="stats-info">
                    <h5>ğŸ“… æ¯æ—¥è´¨æŠ¼ç»Ÿè®¡</h5>
                    <button class="btn-export" onclick="exportDailyStats()">
                        ğŸ“¥ å¯¼å‡ºæ¯æ—¥ç»Ÿè®¡
                    </button>
                </div>
                
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>æ—¥æœŸ</th>
                                <th>æ–°å¢</th>
                                <th>ä»åœ¨</th>
                                <th>1å¤©</th>
                                <th>15å¤©</th>
                                <th>30å¤©</th>
                            </tr>
                        </thead>
                        <tbody id="dailyStatsBody">
                            <tr>
                                <td colspan="6" class="empty-state">
                                    <div>â³ åŠ è½½äº‘ç«¯æ•°æ®ä¸­...</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- å›¾è¡¨é¢æ¿ -->
        <div id="panel-charts" class="data-panel">
            <div class="chart-grid">
                <div class="chart-card">
                    <div class="chart-title">ğŸ“ˆ æ¯æ—¥æ–°å¢è´¨æŠ¼è¶‹åŠ¿</div>
                    <div class="chart-container">
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <div class="chart-title">ğŸ¥§ å„å‘¨æœŸè´¨æŠ¼åˆ†å¸ƒ</div>
                    <div class="chart-container">
                        <canvas id="pieChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="chart-card" style="margin-top:16px;">
                <div class="chart-title">â³ è§£é”æ—¶é—´åˆ†å¸ƒ</div>
                <div class="chart-container" style="height:180px;">
                    <canvas id="unlockChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- åŠ è½½é®ç½© -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">åŠ è½½ä¸­...</div>
    </div>

    <script>
        // ================= é…ç½® =================
        const CONFIG = {
            STAKING: "0x72212F35aC448FE7763aA1BFdb360193Fa098E52",
            LP_POOL: "0xa2f464a2462aed49b9b31eb8861bc6b0bbb0483f",
            USDT: "0x55d398326f99059fF775485246999027B3197955",
            API_BASE: '/api',
            STORAGE_KEY: 'viewerSettings',
            AUTH_STORAGE_KEY: 'HYBRID_AUTH'
        };
        
        const STAKE_DURATIONS = {0: 86400, 1: 1296000, 2: 2592000};
        const STAKE_DURATION_LABELS = {0: "1å¤©", 1: "15å¤©", 2: "30å¤©"};
        const STAKE_DURATION_CLASS = {0: "badge-1d", 1: "badge-15d", 2: "badge-30d"};

        // USDTçš„ABI
        const USDT_ABI = [
            "function balanceOf(address account) view returns (uint256)",
            "function decimals() view returns (uint8)"
        ];

        // ================= å…¨å±€å˜é‡ =================
        let currentData = {
            stats: {
                totalStaked: 0,
                totalStaked1d: 0,
                totalStaked15d: 0,
                totalStaked30d: 0,
                count1d: 0,
                count15d: 0,
                count30d: 0,
                unlock2d: 0,
                unlock7d: 0,
                unlock15d: 0,
                lpWithdrawable: 0
            },
            records: [],
            allRecords: [],
            lastUpdate: null
        };
        let trendChart, pieChart, unlockChart;
        let autoRefreshInterval = null;
        let lpRefreshInterval = null;
        let isAuthorized = false;

        // ================= æˆæƒç³»ç»Ÿ =================
        const AUTH_CONFIG = {
            enabled: true,
            payment: {
                usdtAddress: "0x55d398326f99059fF775485246999027B3197955",
                receiveAddress: "0x9728D428764F846E8DD62C34371db716A9228238",
                prices: {
                    1: 5,
                    7: 20,
                    15: 30,
                    30: 55
                }
            },
            admin: {
                password: "admin9120",
                addresses: [
                    "0xEa77e6769A87c394062919FBaEf4F3B71bC991a8",
                    "0xBfC937728bc5F911c1446470A3627508A29dF808",
                    "0x9728D428764F846E8DD62C34371db716A9228238",
                    "0x211402E8cF1c4117Bbe17e61Ee62F875E31f100B",
                    "0x54Aeb4faF845e90DDA95C1966Ea151d8c431212a",
                    "0x67f7eb9384f2AF616bF2Ec100E19eA774B48aba8"
                ]
            }
        };

        const DateUtils = {
            getExpireTimestamp(days) {
                const now = new Date();
                now.setDate(now.getDate() + days);
                return now.getTime();
            },
            formatDate(timestamp) {
                if (!timestamp) return 'æ°¸ä¹…';
                const date = new Date(timestamp);
                return `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`;
            },
            getRemainingDays(timestamp) {
                if (!timestamp) return 'æ°¸ä¹…';
                const now = new Date().getTime();
                const diff = timestamp - now;
                if (diff <= 0) return 0;
                return Math.ceil(diff / (1000 * 60 * 60 * 24));
            },
            isExpired(timestamp) {
                if (!timestamp) return false;
                return new Date().getTime() > timestamp;
            }
        };

        const AuthManager = {
            isAdminAddress(address) {
                if (!address) return false;
                return AUTH_CONFIG.admin.addresses.some(
                    admin => admin.toLowerCase() === address.toLowerCase()
                );
            },
            validateAdminPassword(password) {
                return password === AUTH_CONFIG.admin.password;
            },
            isAuthorized() {
                try {
                    const auth = localStorage.getItem(CONFIG.AUTH_STORAGE_KEY);
                    if (!auth) return false;
                    
                    const data = JSON.parse(auth);
                    
                    if (data.type === 'admin') return true;
                    
                    if (data.expireTime && DateUtils.isExpired(data.expireTime)) {
                        this.clearAuth();
                        return false;
                    }
                    
                    return true;
                } catch (e) {
                    return false;
                }
            },
            getAuthInfo() {
                try {
                    const auth = localStorage.getItem(CONFIG.AUTH_STORAGE_KEY);
                    if (!auth) return null;
                    
                    const data = JSON.parse(auth);
                    
                    if (data.type === 'admin') {
                        return {
                            ...data,
                            type: 'admin',
                            remainingDays: 'æ°¸ä¹…',
                            displayName: 'ğŸ‘‘ ç®¡ç†å‘˜'
                        };
                    }
                    
                    if (data.type === 'payment') {
                        if (DateUtils.isExpired(data.expireTime)) {
                            this.clearAuth();
                            return null;
                        }
                        return {
                            ...data,
                            type: 'payment',
                            remainingDays: DateUtils.getRemainingDays(data.expireTime),
                            displayName: 'ğŸ’ æ”¯ä»˜ç”¨æˆ·'
                        };
                    }
                    
                    return null;
                } catch (e) {
                    return null;
                }
            },
            saveAuth(type, data) {
                const authData = {
                    type,
                    timestamp: new Date().toISOString(),
                    ...data
                };
                localStorage.setItem(CONFIG.AUTH_STORAGE_KEY, JSON.stringify(authData));
                return authData;
            },
            saveAdminAuth(address, method) {
                return this.saveAuth('admin', {
                    address,
                    method,
                    loginTime: new Date().getTime()
                });
            },
            savePaymentAuth(address, days, amount, txHash) {
                return this.saveAuth('payment', {
                    address,
                    days,
                    amount,
                    txHash,
                    payTime: new Date().getTime(),
                    expireTime: DateUtils.getExpireTimestamp(days)
                });
            },
            clearAuth() {
                localStorage.removeItem(CONFIG.AUTH_STORAGE_KEY);
            },
            async checkWallet() {
                if (typeof window.ethereum === 'undefined') {
                    throw new Error('NO_WALLET');
                }
                return true;
            },
            async connectWallet() {
                try {
                    const accounts = await window.ethereum.request({ 
                        method: 'eth_requestAccounts' 
                    });
                    return accounts[0];
                } catch (error) {
                    console.error('è¿æ¥é’±åŒ…å¤±è´¥:', error);
                    throw error;
                }
            },
            async checkNetwork() {
                const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                const targetChainId = '0x38';
                
                if (chainId !== targetChainId) {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: targetChainId }],
                        });
                    } catch (switchError) {
                        if (switchError.code === 4902) {
                            await window.ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [{
                                    chainId: targetChainId,
                                    chainName: 'Binance Smart Chain',
                                    rpcUrls: ['https://bsc-dataseed.binance.org/'],
                                    nativeCurrency: {
                                        name: 'BNB',
                                        symbol: 'BNB',
                                        decimals: 18
                                    }
                                }],
                            });
                        } else {
                            throw switchError;
                        }
                    }
                }
            },
            usdtABI: [
                "function balanceOf(address account) view returns (uint256)",
                "function decimals() view returns (uint8)",
                "function transfer(address to, uint amount) returns (bool)",
                "function approve(address spender, uint256 amount) returns (bool)",
                "function allowance(address owner, address spender) view returns (uint256)"
            ],
            async checkUSDTBalance(address, provider, requiredAmount) {
                const contract = new ethers.Contract(
                    AUTH_CONFIG.payment.usdtAddress,
                    this.usdtABI,
                    provider
                );
                const balance = await contract.balanceOf(address);
                const decimals = await contract.decimals();
                const formattedBalance = parseFloat(ethers.formatUnits(balance, decimals));
                
                if (formattedBalance < requiredAmount) {
                    throw new Error(`INSUFFICIENT_BALANCE:${formattedBalance}`);
                }
                
                return true;
            },
            async checkAllowance(owner, provider, requiredAmount) {
                const contract = new ethers.Contract(
                    AUTH_CONFIG.payment.usdtAddress,
                    this.usdtABI,
                    provider
                );
                const allowance = await contract.allowance(owner, AUTH_CONFIG.payment.receiveAddress);
                const decimals = await contract.decimals();
                const formattedAllowance = parseFloat(ethers.formatUnits(allowance, decimals));
                
                return formattedAllowance >= requiredAmount;
            },
            async approveUSDT(owner, provider, amount) {
                const contract = new ethers.Contract(
                    AUTH_CONFIG.payment.usdtAddress,
                    this.usdtABI,
                    provider
                );
                const decimals = await contract.decimals();
                const amountWei = ethers.parseUnits(amount.toString(), decimals);
                
                const signer = await provider.getSigner();
                const contractWithSigner = contract.connect(signer);
                
                const tx = await contractWithSigner.approve(AUTH_CONFIG.payment.receiveAddress, amountWei);
                await tx.wait();
                
                return tx.hash;
            },
            async sendUSDT(fromAddress, provider, amount) {
                const contract = new ethers.Contract(
                    AUTH_CONFIG.payment.usdtAddress,
                    this.usdtABI,
                    provider
                );
                const decimals = await contract.decimals();
                const amountWei = ethers.parseUnits(amount.toString(), decimals);
                
                const signer = await provider.getSigner();
                const contractWithSigner = contract.connect(signer);
                
                const tx = await contractWithSigner.transfer(AUTH_CONFIG.payment.receiveAddress, amountWei);
                await tx.wait();
                
                return tx.hash;
            }
        };

        function showAuthDialog() {
            const oldOverlay = document.getElementById('authOverlay');
            if (oldOverlay) oldOverlay.remove();
            
            const overlay = document.createElement('div');
            overlay.className = 'auth-overlay';
            overlay.id = 'authOverlay';
            
            const authInfo = AuthManager.getAuthInfo();

            overlay.innerHTML = `
                <div class="auth-dialog">
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div style="font-size: 48px; margin-bottom: 10px;">ğŸ”</div>
                        <h2 style="color: #e2e8f0; margin: 0 0 5px 0; font-size: 1.5rem; font-weight: bold;">æˆæƒéªŒè¯</h2>
                        <p style="color: #94a3b8; font-size: 0.85rem;">è¯·é€‰æ‹©æˆæƒæ–¹å¼</p>
                    </div>

                    ${authInfo ? `
                        <div style="margin-bottom: 20px; padding: 12px; background: linear-gradient(145deg, #2d3a4f, #1e293b); border-radius: 16px; border: 1px solid #10b981;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <span style="color: #10b981; font-size: 1rem;">âœ…</span>
                                <span style="color: #10b981; font-weight: 600;">æ‚¨å·²æˆæƒ</span>
                            </div>
                            <div style="color: #94a3b8; font-size: 0.85rem;">
                                <div>ç±»å‹: ${authInfo.displayName}</div>
                                ${authInfo.expireTime ? `<div>æœ‰æ•ˆæœŸè‡³: ${DateUtils.formatDate(authInfo.expireTime)}</div>` : ''}
                                ${authInfo.remainingDays && authInfo.remainingDays !== 'æ°¸ä¹…' ? `<div>å‰©ä½™: ${authInfo.remainingDays} å¤©</div>` : ''}
                            </div>
                        </div>
                    ` : ''}

                    <div style="display: flex; gap: 8px; margin-bottom: 20px; border-bottom: 1px solid #334155; padding-bottom: 15px;">
                        <button class="auth-tab active" data-tab="pay">ğŸ’ é’±åŒ…æ”¯ä»˜</button>
                        <button class="auth-tab" data-tab="admin">ğŸ‘‘ ç®¡ç†å‘˜</button>
                    </div>

                    <div id="payPanel" class="auth-panel" style="display: block;">
                        <div style="margin: 20px 0;">
                            <div style="color: #94a3b8; margin-bottom: 10px; font-size: 0.85rem;">é€‰æ‹©æˆæƒå¤©æ•°:</div>
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px;">
                                ${[1, 7, 15, 30].map(days => {
                                    const isActive = days === 30 ? 'active' : '';
                                    return `<button class="day-option ${isActive}" data-days="${days}">
                                        <span>${days}å¤©</span>
                                        <span>${AUTH_CONFIG.payment.prices[days]} USDT</span>
                                    </button>`;
                                }).join('')}
                            </div>
                        </div>

                        <div style="margin: 20px 0; padding: 12px; background: #0f172a; border-radius: 16px; border: 1px solid #334155;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style="color: #94a3b8;">æ”¯ä»˜é‡‘é¢:</span>
                                <span style="color: #38bdf8; font-size: 1.1rem; font-weight: bold;">
                                    <span id="payAmount">${AUTH_CONFIG.payment.prices[30]}</span> USDT
                                </span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: #94a3b8;">æœ‰æ•ˆæœŸè‡³:</span>
                                <span id="expireDate" style="color: #4ade80; font-weight: 600;">
                                    ${DateUtils.formatDate(DateUtils.getExpireTimestamp(30))}
                                </span>
                            </div>
                        </div>

                        <button id="payBtn" style="width: 100%; background: linear-gradient(135deg, #3b82f6, #2563eb); border: none; padding: 14px; border-radius: 40px; color: white; font-size: 1rem; font-weight: 600; cursor: pointer; margin-top: 10px;">
                            ğŸ’ è¿æ¥é’±åŒ…å¹¶æ”¯ä»˜
                        </button>
                    </div>

                    <div id="adminPanel" class="auth-panel" style="display: none;">
                        <div style="margin: 20px 0;">
                            <input type="password" id="adminPassword" placeholder="è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç " 
                                style="width: 100%; padding: 14px; background: #0f172a; border: 2px solid #334155; border-radius: 30px; color: #e2e8f0; font-size: 1rem; text-align: center; outline: none; margin-bottom: 15px;">
                            
                            <button id="adminBtn" style="width: 100%; background: linear-gradient(135deg, #f59e0b, #d97706); border: none; padding: 14px; border-radius: 40px; color: white; font-size: 1rem; font-weight: 600; cursor: pointer;">
                                ğŸ‘‘ ç®¡ç†å‘˜ç™»å½•
                            </button>
                        </div>

                        <div style="margin-top: 15px; padding: 10px; background: #1e293b; border-radius: 16px;">
                            <div style="color: #94a3b8; font-size: 0.8rem; display: flex; align-items: center; gap: 5px;">
                                <span>â„¹ï¸</span>
                                <span>è¯·è”ç³»ç®¡ç†å‘˜è·å–å¯†ç </span>
                            </div>
                        </div>
                    </div>

                    <div style="margin-top: 20px; text-align: center;">
                        <button id="closeBtn" style="background: #ef4444; border: none; padding: 10px 30px; border-radius: 30px; color: white; font-size: 0.9rem; cursor: pointer;">
                            å…³é—­
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(overlay);

            overlay.addEventListener('click', function(e) {
                if (e.target === overlay) {
                    e.preventDefault();
                }
            });

            const tabs = document.querySelectorAll('.auth-tab');
            const panels = {
                pay: document.getElementById('payPanel'),
                admin: document.getElementById('adminPanel')
            };
            const closeBtn = document.getElementById('closeBtn');
            const payBtn = document.getElementById('payBtn');
            const dayOptions = document.querySelectorAll('.day-option');
            const payAmountSpan = document.getElementById('payAmount');
            const expireDateSpan = document.getElementById('expireDate');
            const adminPassword = document.getElementById('adminPassword');
            const adminBtn = document.getElementById('adminBtn');

            let currentDays = 30;

            tabs.forEach(tab => {
                tab.addEventListener('click', (e) => {
                    e.preventDefault();
                    const target = tab.dataset.tab;
                    
                    tabs.forEach(t => {
                        t.classList.remove('active');
                        t.style.background = '#334155';
                        t.style.color = '#94a3b8';
                    });
                    
                    tab.classList.add('active');
                    tab.style.background = '#3b82f6';
                    tab.style.color = 'white';
                    
                    Object.keys(panels).forEach(key => {
                        panels[key].style.display = key === target ? 'block' : 'none';
                    });
                });
            });

            dayOptions.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    dayOptions.forEach(b => {
                        b.classList.remove('active');
                        b.style.background = '#334155';
                        b.style.borderColor = '#475569';
                    });
                    btn.classList.add('active');
                    btn.style.background = '#3b82f6';
                    btn.style.borderColor = '#60a5fa';
                    
                    currentDays = parseInt(btn.dataset.days);
                    payAmountSpan.textContent = AUTH_CONFIG.payment.prices[currentDays];
                    expireDateSpan.textContent = DateUtils.formatDate(DateUtils.getExpireTimestamp(currentDays));
                });
            });

            closeBtn.addEventListener('click', (e) => {
                e.preventDefault();
                document.body.removeChild(overlay);
                if (!AuthManager.isAuthorized()) {
                    setTimeout(() => showAuthDialog(), 500);
                }
            });

            payBtn.addEventListener('click', async (e) => {
                e.preventDefault();
                try {
                    payBtn.disabled = true;
                    payBtn.textContent = 'æ”¯ä»˜å¤„ç†ä¸­...';

                    await AuthManager.checkWallet();
                    await AuthManager.checkNetwork();

                    const address = await AuthManager.connectWallet();

                    if (AuthManager.isAdminAddress(address)) {
                        const authData = AuthManager.saveAdminAuth(address, 'address');
                        document.body.removeChild(overlay);
                        showSuccessToast('ğŸ‘‘ ç®¡ç†å‘˜åœ°å€ç™»å½•æˆåŠŸ');
                        showAuthBadge(authData);
                        checkAuthAndLoad();
                        return;
                    }

                    const provider = new ethers.BrowserProvider(window.ethereum);
                    
                    const requiredAmount = AUTH_CONFIG.payment.prices[currentDays];
                    await AuthManager.checkUSDTBalance(address, provider, requiredAmount);

                    const hasAllowance = await AuthManager.checkAllowance(address, provider, requiredAmount);
                    
                    if (!hasAllowance) {
                        payBtn.textContent = 'æˆæƒä¸­...';
                        await AuthManager.approveUSDT(address, provider, requiredAmount);
                    }

                    payBtn.textContent = 'æ”¯ä»˜ä¸­...';
                    const txHash = await AuthManager.sendUSDT(address, provider, requiredAmount);

                    const authData = AuthManager.savePaymentAuth(address, currentDays, requiredAmount, txHash);

                    document.body.removeChild(overlay);
                    showSuccessToast(`âœ… æˆæƒæˆåŠŸï¼æœ‰æ•ˆæœŸè‡³ï¼š${DateUtils.formatDate(authData.expireTime)}`);
                    showAuthBadge(authData);
                    checkAuthAndLoad();

                } catch (error) {
                    console.error('æ”¯ä»˜é”™è¯¯:', error);
                    
                    let errorMsg = 'âŒ æˆæƒå¤±è´¥ï¼š';
                    if (error.message === 'NO_WALLET') {
                        errorMsg += 'æœªå®‰è£…é’±åŒ…';
                        if (confirm('æœªå®‰è£…MetaMaskï¼Œæ˜¯å¦å‰å¾€å®‰è£…ï¼Ÿ')) {
                            window.open('https://metamask.io/download/', '_blank');
                        }
                    } else if (error.message.includes('INSUFFICIENT_BALANCE')) {
                        const balance = error.message.split(':')[1];
                        errorMsg = `âŒ USDTä½™é¢ä¸è¶³ (å½“å‰: ${balance} USDT)`;
                    } else {
                        errorMsg += error.message || 'æœªçŸ¥é”™è¯¯';
                    }
                    
                    alert(errorMsg);
                    payBtn.disabled = false;
                    payBtn.textContent = 'ğŸ’ è¿æ¥é’±åŒ…å¹¶æ”¯ä»˜';
                }
            });

            adminBtn.addEventListener('click', (e) => {
                e.preventDefault();
                const password = adminPassword.value.trim();
                
                if (AuthManager.validateAdminPassword(password)) {
                    const authData = AuthManager.saveAdminAuth('password', 'password');
                    document.body.removeChild(overlay);
                    showSuccessToast('ğŸ‘‘ ç®¡ç†å‘˜ç™»å½•æˆåŠŸ');
                    showAuthBadge(authData);
                    checkAuthAndLoad();
                } else {
                    alert('âŒ ç®¡ç†å‘˜å¯†ç é”™è¯¯');
                }
            });

            adminPassword.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') adminBtn.click();
            });
        }

        function showSuccessToast(message) {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: linear-gradient(135deg, #10b981, #059669);
                color: white;
                padding: 12px 24px;
                border-radius: 50px;
                font-size: 0.9rem;
                font-weight: 600;
                z-index: 10001;
                animation: slideDown 0.3s ease;
                box-shadow: 0 10px 30px rgba(16, 185, 129, 0.3);
                border: 1px solid rgba(255,255,255,0.2);
                max-width: 80%;
                text-align: center;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'fadeOut 0.3s ease';
                setTimeout(() => {
                    if (toast.parentNode) toast.remove();
                }, 300);
            }, 3000);
        }

        function showAuthBadge(authData) {
            const oldBadge = document.getElementById('authBadge');
            if (oldBadge) oldBadge.remove();

            const badge = document.createElement('div');
            badge.id = 'authBadge';
            
            let bgColor, borderColor, icon;
            if (authData.type === 'admin') {
                bgColor = 'linear-gradient(135deg, #f59e0b, #d97706)';
                borderColor = '#fbbf24';
                icon = 'ğŸ‘‘';
            } else {
                bgColor = 'linear-gradient(135deg, #10b981, #059669)';
                borderColor = '#34d399';
                icon = 'ğŸ’';
            }

            badge.style.cssText = `
                position: fixed;
                top: 10px;
                right: 10px;
                background: ${bgColor};
                border: 1px solid ${borderColor};
                color: white;
                padding: 6px 12px;
                border-radius: 30px;
                font-size: 0.7rem;
                font-weight: 600;
                z-index: 9999;
                backdrop-filter: blur(5px);
                cursor: pointer;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                display: flex;
                align-items: center;
                gap: 6px;
            `;
            
            badge.innerHTML = `
                <span>${icon}</span>
                <span>
                    ${authData.type === 'admin' ? 'ç®¡ç†å‘˜' : `æ”¯ä»˜ç”¨æˆ·`}
                    ${authData.remainingDays && authData.remainingDays !== 'æ°¸ä¹…' ? `(${authData.remainingDays}å¤©)` : ''}
                </span>
            `;
            
            badge.addEventListener('click', () => {
                if (confirm('æ˜¯å¦æ¸…é™¤æˆæƒï¼Ÿ')) {
                    AuthManager.clearAuth();
                    location.reload();
                }
            });
            
            document.body.appendChild(badge);
        }

        function checkAuthAndLoad() {
            if (!AUTH_CONFIG.enabled) {
                loadCloudData();
                return;
            }

            const authorized = AuthManager.isAuthorized();
            
            if (!authorized) {
                const isMobile = window.innerWidth <= 768;
                document.querySelectorAll('.stats-grid, .status-bar, .data-tabs, .table-container, .chart-card').forEach(el => {
                    if (isMobile) {
                        el.style.opacity = '0.5';
                    } else {
                        el.style.filter = 'blur(4px)';
                    }
                    el.style.pointerEvents = 'none';
                });
                
                setTimeout(() => showAuthDialog(), 300);
            } else {
                document.querySelectorAll('.stats-grid, .status-bar, .data-tabs, .table-container, .chart-card').forEach(el => {
                    el.style.opacity = '1';
                    el.style.filter = 'none';
                    el.style.pointerEvents = 'auto';
                });
                const authInfo = AuthManager.getAuthInfo();
                if (authInfo) {
                    showAuthBadge(authInfo);
                }
                loadCloudData();
            }
        }

        // ================= åˆ·æ–°LPæ± ä½™é¢ =================
        async function refreshLPPool() {
            const btn = document.getElementById('refreshLPBtn');
            if (!btn) return;
            
            if (btn.disabled) return;
            
            btn.disabled = true;
            const originalText = btn.innerText;
            btn.innerText = 'åˆ·æ–°ä¸­...';
            
            try {
                await new Promise(resolve => setTimeout(resolve, 500));
                const mockBalance = (Math.random() * 10000 + 5000).toFixed(2);
                currentData.stats.lpWithdrawable = parseFloat(mockBalance);
                document.getElementById('lpWithdrawable').innerText = mockBalance;
                
                btn.innerText = 'âœ… æˆåŠŸ';
                setTimeout(() => {
                    btn.innerText = originalText;
                    btn.disabled = false;
                }, 1500);
            } catch (error) {
                console.error('åˆ·æ–°LPæ± å¤±è´¥:', error);
                btn.innerText = 'âŒ å¤±è´¥';
                setTimeout(() => {
                    btn.innerText = originalText;
                    btn.disabled = false;
                }, 1500);
            }
        }

        // ================= ä»äº‘ç«¯åŠ è½½æ•°æ® =================
        async function loadCloudData(showLoadingOverlay = false) {
            const btn = document.getElementById('refreshBtn');
            if (btn) {
                btn.disabled = true;
                btn.innerText = 'åˆ·æ–°ä¸­...';
            }
            
            if (showLoadingOverlay) showLoading('åŠ è½½äº‘ç«¯æ•°æ®...');
            
            try {
                console.log('æ­£åœ¨ä»äº‘ç«¯è·å–æ•°æ®...');
                const response = await fetch(`${CONFIG.API_BASE}/`);
                const result = await response.json();
                console.log('äº‘ç«¯æ•°æ®å“åº”:', result);
                
                if (result.success && result.data) {
                    let cloudData = result.data;
                    if (typeof cloudData === 'string') {
                        try {
                            cloudData = JSON.parse(cloudData);
                        } catch (e) {
                            console.error('è§£æäº‘ç«¯æ•°æ®å­—ç¬¦ä¸²å¤±è´¥:', e);
                        }
                    }
                    
                    if (typeof cloudData === 'object' && cloudData !== null) {
                        if (cloudData.records) {
                            currentData.records = cloudData.records;
                        }
                        
                        if (cloudData.allRecords) {
                            currentData.allRecords = cloudData.allRecords;
                        }
                        
                        if (cloudData.stats) {
                            currentData.stats = cloudData.stats;
                        } else {
                            currentData.stats = calculateStats(cloudData.records || []);
                        }
                        
                        if (cloudData.lastUpdate) {
                            currentData.lastUpdate = cloudData.lastUpdate;
                            updateLastUpdateTime(cloudData.lastUpdate);
                        }
                        
                        renderStats();
                        renderRecords();
                        renderDailyStats();
                        updateCharts();
                        
                        if (showLoadingOverlay) {
                            showToast('âœ… æ•°æ®å·²æ›´æ–°');
                        }
                    }
                }
            } catch (error) {
                console.error('åŠ è½½äº‘ç«¯æ•°æ®å¤±è´¥:', error);
                if (showLoadingOverlay) {
                    showToast('âŒ åŠ è½½å¤±è´¥', 'error');
                }
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.innerText = 'ğŸ”„ åˆ·æ–°æ•°æ®';
                }
                if (showLoadingOverlay) hideLoading();
            }
        }

        function calculateStats(records) {
            const stats = {
                totalStaked: 0,
                totalStaked1d: 0,
                totalStaked15d: 0,
                totalStaked30d: 0,
                count1d: 0,
                count15d: 0,
                count30d: 0,
                unlock2d: 0,
                unlock7d: 0,
                unlock15d: 0,
                lpWithdrawable: 0
            };
            
            const nowSec = Math.floor(Date.now() / 1000);
            
            records.forEach(r => {
                stats.totalStaked += r.amount;
                
                if (r.stakeIndex === 0) {
                    stats.totalStaked1d += r.amount;
                    stats.count1d++;
                } else if (r.stakeIndex === 1) {
                    stats.totalStaked15d += r.amount;
                    stats.count15d++;
                } else if (r.stakeIndex === 2) {
                    stats.totalStaked30d += r.amount;
                    stats.count30d++;
                }
                
                const remain = r.unlockTime - nowSec;
                if (remain <= 172800) stats.unlock2d += r.amount;
                else if (remain <= 604800) stats.unlock7d += r.amount;
                else if (remain <= 1296000) stats.unlock15d += r.amount;
            });
            
            return stats;
        }

        function refreshData() {
            loadCloudData(true);
        }

        function updateLastUpdateTime(timestamp) {
            if (!timestamp) return;
            const date = new Date(timestamp);
            const formatted = `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')} ${String(date.getHours()).padStart(2,'0')}:${String(date.getMinutes()).padStart(2,'0')}`;
            document.getElementById('lastUpdateTime').innerText = formatted;
        }

        function renderStats() {
            const stats = currentData.stats || {};
            
            document.getElementById('totalStaked').innerText = (stats.totalStaked || 0).toFixed(2);
            document.getElementById('totalStaked1d').innerText = (stats.totalStaked1d || 0).toFixed(2);
            document.getElementById('totalStaked15d').innerText = (stats.totalStaked15d || 0).toFixed(2);
            document.getElementById('totalStaked30d').innerText = (stats.totalStaked30d || 0).toFixed(2);
            document.getElementById('unlock2d').innerText = (stats.unlock2d || 0).toFixed(2);
            document.getElementById('unlock7d').innerText = (stats.unlock7d || 0).toFixed(2);
            document.getElementById('unlock15d').innerText = (stats.unlock15d || 0).toFixed(2);
            document.getElementById('lpWithdrawable').innerText = (stats.lpWithdrawable || 0).toFixed(2);
            document.getElementById('count1d').innerText = stats.count1d || 0;
            document.getElementById('count15d').innerText = stats.count15d || 0;
            document.getElementById('count30d').innerText = stats.count30d || 0;
            
            const recordCount = (stats.count1d || 0) + (stats.count15d || 0) + (stats.count30d || 0);
            document.getElementById('resultCount').innerText = recordCount;
        }

        function renderRecords() {
            const tbody = document.getElementById('resultTableBody');
            const records = currentData.records || [];
            
            if (records.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="empty-state">ğŸ“­ æš‚æ— è´¨æŠ¼è®°å½•</td></tr>';
                return;
            }
            
            tbody.innerHTML = records.map((r, i) => {
                const stake = formatStakeTime(r.stakeTime);
                const unlock = formatStakeTime(r.unlockTime);
                const status = r.timeRemaining <= 0 ? 'å¯èµå›' : 'é”ä»“';
                const statusClass = r.timeRemaining <= 0 ? 'status-unlocked' : 'status-locked';
                const timeText = r.timeRemaining <= 0 ? 'å·²è§£é”' : formatTimeRemaining(r.timeRemaining);
                
                return `<tr>
                    <td>${i+1}</td>
                    <td class="address-cell" title="${r.address}" onclick="copyAddress('${r.address}')">${shortenAddress(r.address)}</td>
                    <td class="amount-cell">${r.amount.toFixed(2)}</td>
                    <td><span class="badge-duration ${STAKE_DURATION_CLASS[r.stakeIndex]}">${STAKE_DURATION_LABELS[r.stakeIndex]}</span></td>
                    <td><div class="time-two-lines"><span class="time-date">${stake.date}</span><span class="time-clock">${stake.time}</span></div></td>
                    <td><div class="time-two-lines"><span class="time-date">${unlock.date}</span><span class="time-clock">${unlock.time}</span></div></td>
                    <td class="${statusClass}">${timeText}</td>
                    <td class="${statusClass}">${status}</td>
                </tr>`;
            }).join('');
        }

        function renderDailyStats() {
            const allRecords = currentData.allRecords || [];
            
            if (allRecords.length === 0) {
                document.getElementById('dailyStatsBody').innerHTML = '<tr><td colspan="6" class="empty-state">ğŸ“Š æš‚æ— æ•°æ®</td></tr>';
                return;
            }

            const dailyMap = new Map();
            const activeMap = new Map();
            
            allRecords.forEach(record => {
                const dateStr = getDateStrFromTimestamp(record.stakeTime);
                
                if (!dailyMap.has(dateStr)) {
                    dailyMap.set(dateStr, {
                        newStake: 0,
                        byPool: {0: 0, 1: 0, 2: 0},
                        count: {0: 0, 1: 0, 2: 0}
                    });
                }
                
                const dayData = dailyMap.get(dateStr);
                dayData.newStake += record.amount;
                dayData.byPool[record.stakeIndex] += record.amount;
                dayData.count[record.stakeIndex]++;
                
                if (!record.isRedeemed) {
                    if (!activeMap.has(dateStr)) {
                        activeMap.set(dateStr, 0);
                    }
                    activeMap.set(dateStr, activeMap.get(dateStr) + record.amount);
                }
            });

            const sortedDates = Array.from(dailyMap.entries())
                .map(([date, data]) => ({
                    date,
                    newStake: data.newStake,
                    activeStake: activeMap.get(date) || 0,
                    new1d: data.byPool[0],
                    new15d: data.byPool[1],
                    new30d: data.byPool[2],
                    count1d: data.count[0],
                    count15d: data.count[1],
                    count30d: data.count[2]
                }))
                .sort((a, b) => b.date.localeCompare(a.date));

            const tbody = document.getElementById('dailyStatsBody');
            tbody.innerHTML = sortedDates.map(day => `
                <tr>
                    <td>${day.date}</td>
                    <td class="amount-cell">${day.newStake.toFixed(2)}</td>
                    <td class="amount-cell">${day.activeStake.toFixed(2)}</td>
                    <td>${day.new1d.toFixed(2)} <span class="stats-badge">${day.count1d}</span></td>
                    <td>${day.new15d.toFixed(2)} <span class="stats-badge">${day.count15d}</span></td>
                    <td>${day.new30d.toFixed(2)} <span class="stats-badge">${day.count30d}</span></td>
                </tr>
            `).join('');
        }

        function updateCharts() {
            const records = currentData.records || [];
            const allRecords = currentData.allRecords || [];
            
            if (records.length === 0 || allRecords.length === 0) {
                if (trendChart) trendChart.destroy();
                if (pieChart) pieChart.destroy();
                if (unlockChart) unlockChart.destroy();
                trendChart = pieChart = unlockChart = null;
                return;
            }

            let sum1d = 0, sum15d = 0, sum30d = 0;
            records.forEach(r => {
                if (r.stakeIndex === 0) sum1d += r.amount;
                else if (r.stakeIndex === 1) sum15d += r.amount;
                else if (r.stakeIndex === 2) sum30d += r.amount;
            });

            let unlock0_2 = 0, unlock2_7 = 0, unlock7_15 = 0, unlock15_25 = 0, unlock25plus = 0;
            const nowSec = Math.floor(Date.now() / 1000);
            records.forEach(r => {
                const remain = r.unlockTime - nowSec;
                if (remain <= 172800) unlock0_2 += r.amount;
                else if (remain <= 604800) unlock2_7 += r.amount;
                else if (remain <= 1296000) unlock7_15 += r.amount;
                else if (remain <= 2160000) unlock15_25 += r.amount;
                else unlock25plus += r.amount;
            });

            const dailyMap = new Map();
            const activeMap = new Map();
            allRecords.forEach(record => {
                const dateStr = getDateStrFromTimestamp(record.stakeTime);
                if (!dailyMap.has(dateStr)) dailyMap.set(dateStr, 0);
                dailyMap.set(dateStr, dailyMap.get(dateStr) + record.amount);
                
                if (!record.isRedeemed) {
                    if (!activeMap.has(dateStr)) activeMap.set(dateStr, 0);
                    activeMap.set(dateStr, activeMap.get(dateStr) + record.amount);
                }
            });
            
            const allDates = Array.from(dailyMap.keys()).sort((a,b)=>a.localeCompare(b));
            const recentDates = allDates.slice(-30);
            const trendLabels = recentDates;
            const trendNewData = recentDates.map(d => dailyMap.get(d) || 0);
            const trendActiveData = recentDates.map(d => activeMap.get(d) || 0);

            const trendCtx = document.getElementById('trendChart')?.getContext('2d');
            const pieCtx = document.getElementById('pieChart')?.getContext('2d');
            const unlockCtx = document.getElementById('unlockChart')?.getContext('2d');
            
            if (!trendCtx || !pieCtx || !unlockCtx) return;

            if (trendChart) trendChart.destroy();
            if (pieChart) pieChart.destroy();
            if (unlockChart) unlockChart.destroy();

            trendChart = new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: trendLabels,
                    datasets: [
                        {
                            label: 'æ–°å¢è´¨æŠ¼',
                            data: trendNewData,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59,130,246,0.1)',
                            tension: 0.2,
                            fill: true
                        },
                        {
                            label: 'ä»åœ¨è´¨æŠ¼',
                            data: trendActiveData,
                            borderColor: '#4ade80',
                            backgroundColor: 'rgba(74,222,128,0.1)',
                            tension: 0.2,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { 
                        y: { beginAtZero: true, grid: { color: '#334155' }, ticks: { color: '#94a3b8' } },
                        x: { ticks: { color: '#94a3b8', maxRotation: 45 } } 
                    },
                    plugins: { legend: { labels: { color: '#e2e8f0' } } }
                }
            });

            pieChart = new Chart(pieCtx, {
                type: 'doughnut',
                data: {
                    labels: ['1å¤©', '15å¤©', '30å¤©'],
                    datasets: [{
                        data: [sum1d, sum15d, sum30d],
                        backgroundColor: ['#3b82f6', '#8b5cf6', '#ec4899'],
                        borderColor: '#1e293b',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { labels: { color: '#e2e8f0' } } }
                }
            });

            unlockChart = new Chart(unlockCtx, {
                type: 'bar',
                data: {
                    labels: ['0-2å¤©', '2-7å¤©', '7-15å¤©', '15-25å¤©', '>25å¤©'],
                    datasets: [{
                        label: 'å¯èµå›é‡‘é¢ (USDT)',
                        data: [unlock0_2, unlock2_7, unlock7_15, unlock15_25, unlock25plus],
                        backgroundColor: ['#f87171', '#fbbf24', '#60a5fa', '#a78bfa', '#ec4899'],
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { 
                        y: { beginAtZero: true, grid: { color: '#334155' }, ticks: { color: '#94a3b8' } },
                        x: { ticks: { color: '#94a3b8' } } 
                    },
                    plugins: { legend: { labels: { color: '#e2e8f0' } } }
                }
            });
        }

        function formatTimeRemaining(seconds) {
            if (seconds <= 0) return "å·²è§£é”";
            const days = Math.floor(seconds / 86400);
            const hours = Math.floor((seconds % 86400) / 3600);
            
            if (days > 0) return `${days}d${hours}h`;
            return `${hours}h${Math.floor((seconds % 3600) / 60)}m`;
        }

        function formatStakeTime(timestamp) {
            try {
                const d = new Date(timestamp * 1000);
                const now = new Date();
                const diff = Math.floor((now - d) / (1000 * 60 * 60 * 24));
                
                let date = `${d.getMonth()+1}/${d.getDate()}`;
                let time = d.toLocaleTimeString('zh-CN', {hour12: false}).slice(0,5);
                
                return {date, time};
            } catch {
                return {date: '-', time: '-'};
            }
        }

        function getDateStrFromTimestamp(timestamp) {
            const date = new Date(timestamp * 1000);
            const year = date.getUTCFullYear();
            const month = String(date.getUTCMonth() + 1).padStart(2, '0');
            const day = String(date.getUTCDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function shortenAddress(addr) {
            return addr ? addr.slice(0, 6) + 'â€¦' + addr.slice(-4) : '';
        }

        function copyAddress(address) {
            navigator.clipboard.writeText(address);
            showToast('åœ°å€å·²å¤åˆ¶');
        }

        function switchDataTab(tab) {
            document.getElementById('tab-records').classList.remove('active');
            document.getElementById('tab-daily').classList.remove('active');
            document.getElementById('tab-charts').classList.remove('active');
            document.getElementById('panel-records').classList.remove('active');
            document.getElementById('panel-daily').classList.remove('active');
            document.getElementById('panel-charts').classList.remove('active');
            
            document.getElementById(`tab-${tab}`).classList.add('active');
            document.getElementById(`panel-${tab}`).classList.add('active');

            if (tab === 'charts') {
                if (trendChart) trendChart.destroy();
                if (pieChart) pieChart.destroy();
                if (unlockChart) unlockChart.destroy();
                updateCharts();
            }
        }

        function exportCSV() {
            const records = currentData.records || [];
            
            if (records.length === 0) {
                alert("æ²¡æœ‰æ•°æ®");
                return;
            }

            const headers = ['åºå·', 'åœ°å€', 'é‡‘é¢', 'å‘¨æœŸ', 'è´¨æŠ¼æ—¶é—´', 'è§£é”æ—¶é—´', 'å‰©ä½™æ—¶é—´', 'çŠ¶æ€'];
            const rows = records.map((r, i) => {
                const stakeTime = new Date(r.stakeTime * 1000).toLocaleString();
                const unlockTime = new Date(r.unlockTime * 1000).toLocaleString();
                const status = r.timeRemaining <= 0 ? 'å¯èµå›' : 'é”ä»“';
                const remaining = r.timeRemaining <= 0 ? 'å·²è§£é”' : formatTimeRemaining(r.timeRemaining);
                
                return [
                    i+1, r.address, r.amount.toFixed(2),
                    STAKE_DURATION_LABELS[r.stakeIndex],
                    stakeTime, unlockTime, remaining, status
                ];
            });

            const csv = [headers, ...rows].map(row => row.join(',')).join('\n');
            const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `è´¨æŠ¼æ•°æ®_${new Date().toLocaleDateString()}.csv`;
            link.click();
        }

        function exportDailyStats() {
            const allRecords = currentData.allRecords || [];
            
            if (allRecords.length === 0) {
                alert("æ²¡æœ‰æ•°æ®");
                return;
            }

            const dailyMap = new Map();
            const activeMap = new Map();
            
            allRecords.forEach(record => {
                const dateStr = getDateStrFromTimestamp(record.stakeTime);
                
                if (!dailyMap.has(dateStr)) {
                    dailyMap.set(dateStr, {
                        newStake: 0,
                        new1d: 0,
                        new15d: 0,
                        new30d: 0
                    });
                }
                
                const dayData = dailyMap.get(dateStr);
                dayData.newStake += record.amount;
                
                if (record.stakeIndex === 0) dayData.new1d += record.amount;
                else if (record.stakeIndex === 1) dayData.new15d += record.amount;
                else if (record.stakeIndex === 2) dayData.new30d += record.amount;

                if (!record.isRedeemed) {
                    if (!activeMap.has(dateStr)) {
                        activeMap.set(dateStr, 0);
                    }
                    activeMap.set(dateStr, activeMap.get(dateStr) + record.amount);
                }
            });

            const headers = ['æ—¥æœŸ', 'æ–°å¢è´¨æŠ¼', 'ä»åœ¨è´¨æŠ¼', '1å¤©æ–°å¢', '15å¤©æ–°å¢', '30å¤©æ–°å¢'];
            const rows = Array.from(dailyMap.entries())
                .map(([date, data]) => {
                    const active = activeMap.get(date) || 0;
                    return [
                        date,
                        data.newStake.toFixed(2),
                        active.toFixed(2),
                        data.new1d.toFixed(2),
                        data.new15d.toFixed(2),
                        data.new30d.toFixed(2)
                    ];
                })
                .sort((a, b) => b[0].localeCompare(a[0]));

            const csv = [headers, ...rows].map(row => row.join(',')).join('\n');
            const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `æ¯æ—¥ç»Ÿè®¡_${new Date().toLocaleDateString()}.csv`;
            link.click();
        }

        function showLoading(message) {
            const overlay = document.getElementById('loadingOverlay');
            const text = document.getElementById('loadingText');
            text.textContent = message || 'åŠ è½½ä¸­...';
            overlay.style.display = 'flex';
        }

        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            overlay.style.display = 'none';
        }

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: ${type === 'success' ? 'linear-gradient(135deg, #10b981, #059669)' : 'linear-gradient(135deg, #ef4444, #dc2626)'};
                color: white;
                padding: 10px 20px;
                border-radius: 50px;
                font-size: 0.85rem;
                font-weight: 600;
                z-index: 10001;
                animation: slideDown 0.3s ease;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                max-width: 80%;
                text-align: center;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'fadeOut 0.3s ease';
                setTimeout(() => {
                    if (toast.parentNode) toast.remove();
                }, 300);
            }, 3000);
        }

        // ================= åˆå§‹åŒ– =================
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('stakingContractAddress').innerText = CONFIG.STAKING;
            
            checkAuthAndLoad();
            
            autoRefreshInterval = setInterval(() => {
                if (AuthManager.isAuthorized()) {
                    loadCloudData(true);
                }
            }, 5 * 60 * 1000);
            
            lpRefreshInterval = setInterval(() => {
                refreshLPPool();
            }, 10 * 60 * 1000);
            
            if ('ontouchstart' in window) {
                document.querySelectorAll('button, .auth-tab, .day-option, .btn-lp-small, .btn-refresh, .data-tab, #payBtn, #adminBtn, #closeBtn').forEach(el => {
                    el.addEventListener('touchstart', function(e) {
                        e.preventDefault();
                    }, { passive: false });
                });
            }
        });

        window.switchDataTab = switchDataTab;
        window.refreshData = refreshData;
        window.refreshLPPool = refreshLPPool;
        window.exportCSV = exportCSV;
        window.exportDailyStats = exportDailyStats;
        window.copyAddress = copyAddress;
    </script>
</body>
</html>
