<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes, viewport-fit=cover">
    <title>GANAè´¨æŠ¼æ•°æ®åˆ†æ</title>
    <!-- å¼•å…¥ Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- å¼•å…¥ Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- å¼•å…¥ Ethers.js V6 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body { 
            background-color: #0f172a; 
            color: #e2e8f0; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            padding: 12px;
            min-height: 100vh;
            -webkit-overflow-scrolling: touch;
        }
        
        .container-fluid {
            max-width: 100%;
            margin: 0 auto;
            padding: 0;
        }

        /* å¤´éƒ¨å»æ‰ä¸¤è¡Œç»Ÿè®¡é¢æ¿ï¼Œä¿ç•™å…³é”®ä¿¡æ¯ */
        .header {
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid #334155;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .header h1 {
            font-size: 1.3rem;
            font-weight: bold;
            background: linear-gradient(135deg, #60a5fa, #c084fc);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 4px;
            line-height: 1.2;
        }
        
        @media (min-width: 768px) {
            .header h1 { font-size: 1.5rem; }
        }
        
        .header .subtitle { color: #94a3b8; font-size: 0.7rem; }
        
        .viewer-badge {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 600;
            border: 1px solid #60a5fa;
            white-space: nowrap;
        }
        
        .contract-address {
            font-family: 'Courier New', monospace;
            background: #1e293b;
            border: 1px solid #334155;
            padding: 4px 8px;
            border-radius: 20px;
            color: #60a5fa;
            font-size: 0.6rem;
            display: inline-block;
            margin-top: 8px;
            word-break: break-all;
        }

        /* çŠ¶æ€æ ç²¾ç®€ */
        .status-bar {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 30px;
            padding: 8px 16px;
            margin: 0 0 16px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .last-update { color: #94a3b8; font-size: 0.75rem; }
        .last-update span { color: #4ade80; font-weight: 600; }
        
        .btn-lp-small {
            background: linear-gradient(135deg, #10b981, #059669);
            border: 1px solid #34d399;
            padding: 6px 12px;
            border-radius: 30px;
            color: white;
            font-size: 0.7rem;
            font-weight: 600;
            cursor: pointer;
            min-height: 36px;
            min-width: 80px;
        }
        .btn-refresh {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            border: none;
            padding: 6px 12px;
            border-radius: 30px;
            color: white;
            font-size: 0.7rem;
            font-weight: 600;
            cursor: pointer;
            min-height: 36px;
            min-width: 70px;
        }
        .btn-lp-small:active, .btn-refresh:active { transform: scale(0.96); }

        /* LPå°å¡ç‰‡ */
        .lp-solo-card {
            background: #1e293b;
            border-radius: 16px;
            padding: 6px 14px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            border: 1px solid #334155;
        }
        .lp-value {
            color: #38bdf8;
            font-weight: 700;
            font-size: 1rem;
        }

        /* é€‰é¡¹å¡æ ·å¼ (ä¸åŸç‰ˆä¸€è‡´) */
        .data-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            border-bottom: 1px solid #334155;
            padding-bottom: 10px;
        }
        .data-tab {
            background-color: transparent;
            border: 1px solid #475569;
            color: #94a3b8;
            padding: 10px 16px;
            border-radius: 30px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: background-color 0.2s, color 0.2s;
            touch-action: manipulation;
            min-height: 44px;
            user-select: none;
            flex: 1;
            text-align: center;
        }
        .data-tab.active {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            border-color: #60a5fa;
            color: white;
        }

        /* é¢æ¿åˆ‡æ¢ */
        .data-panel { display: none; }
        .data-panel.active { display: block; }

        /* å›¾è¡¨å¡ç‰‡æ ·å¼ */
        .chart-card {
            background: linear-gradient(145deg, #1e293b, #0f172a);
            border: 1px solid #334155;
            border-radius: 20px;
            padding: 16px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            margin-bottom: 16px;
        }
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            flex-wrap: wrap;
            gap: 8px;
        }
        .chart-title {
            color: #94a3b8;
            font-size: 0.95rem;
            font-weight: 500;
        }
        .range-selector {
            display: flex;
            gap: 4px;
            background: #1e293b;
            padding: 4px;
            border-radius: 30px;
            border: 1px solid #334155;
        }
        .range-btn {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.7rem;
            cursor: pointer;
            color: #94a3b8;
            background: transparent;
            border: none;
            min-height: 30px;
        }
        .range-btn.active {
            background: #3b82f6;
            color: white;
        }
        .chart-container { position: relative; height: 260px; width: 100%; }

        /* è¡¨æ ¼æ ·å¼ */
        .table-container {
            background: linear-gradient(145deg, #1e293b, #0f172a);
            border-radius: 16px;
            padding: 12px;
            border: 1px solid #334155;
            margin-top: 0;
        }
        .stats-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            flex-wrap: wrap;
            gap: 8px;
        }
        .btn-export {
            background-color: #334155;
            border: 1px solid #475569;
            padding: 8px 16px;
            border-radius: 20px;
            color: #e2e8f0;
            font-size: 0.8rem;
            cursor: pointer;
            min-height: 40px;
        }
        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            max-height: 460px;
            overflow-y: auto;
        }
        .table { 
            color: #e2e8f0; 
            font-size: 0.8rem; 
            width: 100%;
            border-collapse: collapse;
        }
        .table thead th { 
            border-bottom: 2px solid #334155; 
            color: #94a3b8; 
            font-size: 0.7rem; 
            padding: 12px 4px;
            text-align: center;
            font-weight: 600;
            white-space: nowrap;
            background: #1e293b;
            position: sticky;
            top: 0;
        }
        .table td { 
            border-bottom: 1px solid #334155; 
            padding: 10px 4px;
            text-align: center;
        }
        .stats-badge {
            display: inline-block;
            background-color: #334155;
            border-radius: 12px;
            padding: 2px 6px;
            font-size: 0.6rem;
            color: #94a3b8;
            margin-left: 4px;
        }
        .empty-state {
            text-align: center;
            padding: 40px 12px;
            color: #64748b;
        }

        /* æˆæƒå¼¹çª—æ ·å¼ (ä¸‰æ¡£) */
        .auth-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(10px);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
        }
        .auth-dialog {
            background: linear-gradient(145deg, #1e293b, #0f172a);
            border: 2px solid #334155;
            border-radius: 24px;
            padding: 20px;
            max-width: 500px;
            width: 100%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.7);
        }
        .auth-tab {
            flex: 1;
            padding: 12px 5px;
            background: #334155;
            border: none;
            border-radius: 30px;
            color: #94a3b8;
            font-weight: 600;
            cursor: pointer;
            min-height: 44px;
            font-size: 0.9rem;
        }
        .auth-tab.active { background: #3b82f6; color: white; }

/* ä¸‰æ¡£ä»·æ ¼å¡ç‰‡ - ç¼©å°ç‰ˆ */
.price-tier-container {
    display: flex;
    flex-direction: column;
    gap: 8px;                 /* å‡å°å¡ç‰‡é—´è· */
    margin: 15px 0;           /* å‡å°ä¸Šä¸‹è¾¹è· */
}
.price-tier {
    background: #1e293b;
    border: 2px solid #334155;
    border-radius: 16px;      /* å‡å°åœ†è§’ */
    padding: 12px;            /* å‡å°å†…è¾¹è· */
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    transition: all 0.2s;
}
.tier-info h4 {
    font-size: 1rem;          /* è°ƒå°æ ‡é¢˜ */
    margin: 0 0 2px 0;        /* å‡å°ä¸‹è¾¹è· */
    color: #e2e8f0;
}
.tier-info p {
    color: #94a3b8;
    font-size: 0.7rem;        /* è°ƒå°è¯´æ˜æ–‡å­— */
    margin: 0;
}
.tier-price {
    font-size: 1.3rem;        /* è°ƒå°ä»·æ ¼æ•°å­— */
    font-weight: 700;
    color: #38bdf8;
}
.tier-price small {
    font-size: 0.7rem;        /* è°ƒå°USDTæ ‡æ³¨ */
    color: #94a3b8;
}

        .btn-pay {
            width: 100%;
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            border: none;
            padding: 14px;
            border-radius: 40px;
            color: white;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
        }
        .btn-pay:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-admin {
            width: 100%;
            background: linear-gradient(135deg, #f59e0b, #d97706);
            border: none;
            padding: 14px;
            border-radius: 40px;
            color: white;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
        }
        .btn-close {
            background: #ef4444;
            border: none;
            padding: 10px 30px;
            border-radius: 30px;
            color: white;
            font-size: 0.9rem;
            cursor: pointer;
            margin-top: 20px;
        }

        .loading-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(15, 23, 42, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            backdrop-filter: blur(5px);
        }
        .loading-spinner {
            width: 50px; height: 50px;
            border: 3px solid #334155;
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .pie-legend {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-top: 8px;
            font-size: 0.7rem;
            flex-wrap: wrap;
        }
        .legend-item { display: flex; align-items: center; gap: 4px; }
        .legend-color { width: 10px; height: 10px; border-radius: 50%; }

        @media (max-width: 768px) {
            .chart-container { height: 200px; }
            .price-tier { flex-direction: column; text-align: center; gap: 8px; }
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- ç²¾ç®€å¤´éƒ¨ -->
        <div class="header">
            <div>
                <h1>ğŸ” GANA è´¨æŠ¼æ•°æ®å±•ç¤º <span class="viewer-badge">ä»˜è´¹æ•°æ®</span></h1>
                <div class="subtitle">äº‘ç«¯å®šæ—¶æ›´æ–°</div>
                <div class="contract-address" id="stakingContractAddress">0x72212F35aC448FE7763aA1BFdb360193Fa098E52</div>
            </div>
            <div class="lp-solo-card">
                <span>ğŸ’§ LPæ± </span>
                <span class="lp-value" id="lpPoolBalanceDisplay">0.00</span>
                <span style="color:#94a3b8; font-size:0.6rem;">USDT</span>
            </div>
        </div>

        <!-- çŠ¶æ€æ  -->
        <div class="status-bar">
            <div class="last-update">
                ğŸ“… <span id="lastUpdateTime">åŠ è½½ä¸­...</span>
            </div>
            <div style="display: flex; gap: 8px;">
                <button class="btn-lp-small" onclick="refreshLPPool()" id="refreshLPBtn">ğŸ’° åˆ·æ–°LP</button>
                <button class="btn-refresh" onclick="handleManualRefresh()" id="refreshBtn">ğŸ”„ åˆ·æ–°</button>
            </div>
        </div>

        <!-- é€‰é¡¹å¡ï¼šå›¾è¡¨ / æ¯æ—¥ç»Ÿè®¡ (ç»å…¸å¸ƒå±€) -->
        <div class="data-tabs">
            <span class="data-tab active" data-tab="charts">ğŸ“Š å›¾è¡¨</span>
            <span class="data-tab" data-tab="daily">ğŸ“… æ¯æ—¥è´¨æŠ¼ç»Ÿè®¡</span>
        </div>

        <!-- å›¾è¡¨é¢æ¿ (æ°¸è¿œå¯è§) -->
        <div id="panel-charts" class="data-panel active">
            <!-- è¶‹åŠ¿å›¾å¡ç‰‡ (é»˜è®¤90å¤©) -->
            <div class="chart-card">
                <div class="chart-header">
                    <span class="chart-title">ğŸ“ˆ æ¯æ—¥è´¨æŠ¼è¶‹åŠ¿</span>
                    <div class="range-selector">
                        <button class="range-btn" onclick="setTrendRange(7)">7å¤©</button>
                        <button class="range-btn" onclick="setTrendRange(15)">15å¤©</button>
                        <button class="range-btn" onclick="setTrendRange(30)">30å¤©</button>
                        <button class="range-btn active" onclick="setTrendRange(90)">90å¤©</button>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>

            <!-- ä¸‹æ–¹ä¸¤ä¸ªå°å›¾è¡¨å¹¶æ’ -->
            <div style="display: flex; gap: 16px; flex-wrap: wrap;">
                <div class="chart-card" style="flex:1; min-width:240px;">
                    <div class="chart-title" style="margin-bottom:10px;">ğŸ¥§ å„å‘¨æœŸè´¨æŠ¼åˆ†å¸ƒ</div>
                    <div class="chart-container" style="height:200px;">
                        <canvas id="pieChart"></canvas>
                    </div>
                    <div id="pieLegend" class="pie-legend"></div>
                </div>
                <div class="chart-card" style="flex:1; min-width:240px;">
                    <div class="chart-title" style="margin-bottom:10px;">â³ è§£é”æ—¶é—´åˆ†å¸ƒ</div>
                    <div class="chart-container" style="height:200px;">
                        <canvas id="unlockChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ¯æ—¥ç»Ÿè®¡é¢æ¿ (ä»˜è´¹è§£é”æ•°æ®) -->
        <div id="panel-daily" class="data-panel">
            <div class="table-container" id="dailyPremiumContainer" style="position: relative;">
                <div class="stats-info">
                    <h5>ğŸ“… æ¯æ—¥è´¨æŠ¼ç»Ÿè®¡</h5>
                    <button class="btn-export" onclick="exportDailyStats()" id="exportCsvBtn">ğŸ“¥ å¯¼å‡ºCSV</button>
                </div>

                <!-- ä»˜è´¹é®ç½©å±‚ (åˆå§‹æ˜¾ç¤º) -->
                <div id="dailyLockOverlay" class="daily-lock-overlay" onclick="unlockDailyStats()" style="position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(15,23,42,0.95); backdrop-filter: blur(6px); border-radius:16px; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index:20; border:2px dashed #f59e0b; cursor:pointer;">
                    <div style="font-size:40px; margin-bottom:15px; background:#1e293b; width:80px; height:80px; border-radius:50%; display:flex; align-items:center; justify-content:center; border:2px solid #f59e0b;">ğŸ”</div>
                    <div style="font-size:1.2rem; font-weight:bold; color:#fbbf24; margin-bottom:8px;">ä»˜è´¹æŸ¥çœ‹</div>
                    <div style="color:#94a3b8; font-size:0.9rem; margin-bottom:16px; max-width:280px; text-align:center;">æ¯æ—¥æ˜ç»†ã€å‘¨æœŸæ•°æ®ã€å¯¼å‡ºCSV</div>
                    <div style="background:#0f172a; padding:12px 24px; border-radius:50px; border:1px solid #3b82f6; color:#38bdf8; font-weight:700; font-size:1.2rem; margin-bottom:10px;">10 USDT / æ°¸ä¹…</div>
                    <div style="font-size:0.75rem; color:#64748b;">ç‚¹å‡»æ”¯ä»˜è§£é” (éœ€å…ˆå®ŒæˆåŸºç¡€æˆæƒ)</div>
                </div>

                <!-- å®é™…è¡¨æ ¼å†…å®¹ (éšè—ç›´åˆ°äºŒæ¬¡è§£é”) -->
                <div id="dailyStatsContent" style="display: none;">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>æ—¥æœŸ</th>
                                    <th>æ–°å¢è´¨æŠ¼</th>
                                    <th>ä»åœ¨è´¨æŠ¼</th>
                                    <th>1å¤©æ–°å¢</th>
                                    <th>15å¤©æ–°å¢</th>
                                    <th>30å¤©æ–°å¢</th>
                                </tr>
                            </thead>
                            <tbody id="dailyStatsBody">
                                <tr><td colspan="6" class="empty-state">â³ åŠ è½½ä¸­...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- åŠ è½½é®ç½© -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">åŠ è½½ä¸­...</div>
    </div>

    <script>
        // CONFIG å®šä¹‰
        const CONFIG = {
            STAKING: "0x72212F35aC448FE7763aA1BFdb360193Fa098E52",
            LP_POOL: "0xa2f464a2462aed49b9b31eb8861bc6b0bbb0483f",
            USDT: "0x55d398326f99059fF775485246999027B3197955",
            API_BASE: '/api',
            AUTH_STORAGE_KEY: 'HYBRID_AUTH',
            UNLOCK_STORAGE_KEY: 'RESTRICTED_UNLOCKED',
            DAILY_UNLOCK_KEY: 'GANA_DAILY_UNLOCKED'
        };

        const USDT_ABI = [
            "function balanceOf(address account) view returns (uint256)",
            "function decimals() view returns (uint8)",
            "function transfer(address to, uint amount) returns (bool)",
            "function approve(address spender, uint256 amount) returns (bool)",
            "function allowance(address owner, address spender) view returns (uint256)"
        ];

        let usdtContract = null;
        let currentData = {
            stats: { totalStaked:0, totalStaked1d:0, totalStaked15d:0, totalStaked30d:0, count1d:0, count15d:0, count30d:0, unlock2d:0, unlock7d:0, unlock15d:0, lpWithdrawable:0 },
            allRecords: [],
            lastUpdate: null
        };
        let trendChart, pieChart, unlockChart;
        let trendRange = 90;
        let isLoading = false;
        let dailyUnlocked = localStorage.getItem(CONFIG.DAILY_UNLOCK_KEY) === 'true';

        // ä¸‰æ¡£ä»·æ ¼é…ç½®
        const TIERS = [
            { days: 30, amount: 5, label: '30å¤©' },
            { days: 90, amount: 12, label: '90å¤©' },
            { days: 360, amount: 30, label: '360å¤©' }
        ];

        const AUTH_CONFIG = {
            enabled: true,
            payment: {
                usdtAddress: "0x55d398326f99059fF775485246999027B3197955",
                receiveAddress: "0x9728D428764F846E8DD62C34371db716A9228238",
                // å»æ‰å›ºå®šdays/amountï¼Œæ”¹ç”¨åŠ¨æ€é€‰æ‹©
            },
            admin: {
                password: "admin9120",
                addresses: [
                    "0xEa77e6769A87c394062919FBaEf4F3B71bC991a8",
                    "0xBfC937728bc5F911c1446470A3627508A29dF808",
                    "0x211402E8cF1c4117Bbe17e61Ee62F875E31f100B",
                    "0x54Aeb4faF845e90DDA95C1966Ea151d8c431212a",
                    "0x67f7eb9384f2AF616bF2Ec100E19eA774B48aba8",
                    "0x9728D428764F846E8DD62C34371db716A9228238"
                ]
            }
        };

        const DateUtils = {
            getExpireTimestamp(days) { const now = new Date(); now.setDate(now.getDate() + days); return now.getTime(); },
            formatDate(timestamp) { if (!timestamp) return 'æ°¸ä¹…'; const d = new Date(timestamp); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; },
            getRemainingDays(timestamp) {
                if (!timestamp) return 'æ°¸ä¹…';
                const diff = timestamp - new Date().getTime();
                if (diff <= 0) return 0;
                return Math.ceil(diff / (86400000));
            },
            isExpired(timestamp) { return timestamp ? new Date().getTime() > timestamp : false; }
        };

        const AuthManager = {
            isAdminAddress(address) { return AUTH_CONFIG.admin.addresses.some(a => a.toLowerCase() === address?.toLowerCase()); },
            validateAdminPassword(pwd) { return pwd === AUTH_CONFIG.admin.password; },
            isAuthorized() {
                try {
                    const auth = localStorage.getItem(CONFIG.AUTH_STORAGE_KEY);
                    if (!auth) return false;
                    const data = JSON.parse(auth);
                    if (data.type === 'admin') return true;
                    if (data.expireTime && DateUtils.isExpired(data.expireTime)) {
                        this.clearAuth();
                        return false;
                    }
                    return true;
                } catch { return false; }
            },
            getAuthInfo() {
                try {
                    const auth = localStorage.getItem(CONFIG.AUTH_STORAGE_KEY);
                    if (!auth) return null;
                    const data = JSON.parse(auth);
                    if (data.type === 'admin') {
                        return { ...data, type: 'admin', remainingDays: 'æ°¸ä¹…', displayName: 'ğŸ‘‘ ç®¡ç†å‘˜' };
                    }
                    if (data.type === 'payment') {
                        if (DateUtils.isExpired(data.expireTime)) {
                            this.clearAuth();
                            return null;
                        }
                        return { ...data, type: 'payment', remainingDays: DateUtils.getRemainingDays(data.expireTime), displayName: 'ğŸ’ æ”¯ä»˜ç”¨æˆ·' };
                    }
                    return null;
                } catch { return null; }
            },
            saveAuth(type, data) { const auth = { type, timestamp: new Date().toISOString(), ...data }; localStorage.setItem(CONFIG.AUTH_STORAGE_KEY, JSON.stringify(auth)); return auth; },
            saveAdminAuth(address, method) { return this.saveAuth('admin', { address, method, loginTime: Date.now() }); },
            savePaymentAuth(address, days, amount, txHash) { return this.saveAuth('payment', { address, days, amount, txHash, payTime: Date.now(), expireTime: DateUtils.getExpireTimestamp(days) }); },
            clearAuth() { localStorage.removeItem(CONFIG.AUTH_STORAGE_KEY); },
            async checkWallet() { if (typeof window.ethereum === 'undefined') { throw new Error('NO_WALLET'); } return true; },
            async connectWallet() { try { const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' }); return accounts[0]; } catch (error) { console.error('è¿æ¥é’±åŒ…å¤±è´¥:', error); throw error; } },
            async checkNetwork() {
                const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                const targetChainId = '0x38';
                if (chainId !== targetChainId) {
                    try { await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: targetChainId }] }); } catch (switchError) {
                        if (switchError.code === 4902) {
                            await window.ethereum.request({ method: 'wallet_addEthereumChain', params: [{ chainId: targetChainId, chainName: 'Binance Smart Chain', rpcUrls: ['https://bsc-dataseed.binance.org/'], nativeCurrency: { name: 'BNB', symbol: 'BNB', decimals: 18 } }] });
                        } else { throw switchError; }
                    }
                }
            },
            async checkUSDTBalance(address, provider, requiredAmount) {
                const contract = new ethers.Contract( AUTH_CONFIG.payment.usdtAddress, USDT_ABI, provider );
                const balance = await contract.balanceOf(address);
                const decimals = await contract.decimals();
                const formattedBalance = parseFloat(ethers.formatUnits(balance, decimals));
                if (formattedBalance < requiredAmount) { throw new Error(`INSUFFICIENT_BALANCE:${formattedBalance}`); }
                return true;
            },
            async checkAllowance(owner, provider, requiredAmount) {
                const contract = new ethers.Contract( AUTH_CONFIG.payment.usdtAddress, USDT_ABI, provider );
                const allowance = await contract.allowance(owner, AUTH_CONFIG.payment.receiveAddress);
                const decimals = await contract.decimals();
                const formattedAllowance = parseFloat(ethers.formatUnits(allowance, decimals));
                return formattedAllowance >= requiredAmount;
            },
            async approveUSDT(owner, provider, amount) {
                const contract = new ethers.Contract( AUTH_CONFIG.payment.usdtAddress, USDT_ABI, provider );
                const decimals = await contract.decimals();
                const amountWei = ethers.parseUnits(amount.toString(), decimals);
                const signer = await provider.getSigner();
                const contractWithSigner = contract.connect(signer);
                const tx = await contractWithSigner.approve(AUTH_CONFIG.payment.receiveAddress, amountWei);
                await tx.wait();
                return tx.hash;
            },
            async sendUSDT(fromAddress, provider, amount) {
                const contract = new ethers.Contract( AUTH_CONFIG.payment.usdtAddress, USDT_ABI, provider );
                const decimals = await contract.decimals();
                const amountWei = ethers.parseUnits(amount.toString(), decimals);
                const signer = await provider.getSigner();
                const contractWithSigner = contract.connect(signer);
                const tx = await contractWithSigner.transfer(AUTH_CONFIG.payment.receiveAddress, amountWei);
                await tx.wait();
                return tx.hash;
            }
        };

        // å·¥å…·å‡½æ•°
        function showSuccessToast(message) { 
            const toast = document.createElement('div');
            toast.style.cssText = `position: fixed; top:20px; left:50%; transform:translateX(-50%); background: #10b981; color:white; padding:12px 24px; border-radius:50px; z-index:10001; font-weight:600; box-shadow:0 10px 30px rgba(16,185,129,0.3);`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function showLoading(message) { 
            document.getElementById('loadingOverlay').style.display = 'flex'; 
            document.getElementById('loadingText').textContent = message || 'åŠ è½½ä¸­...'; 
        }

        function hideLoading() { 
            document.getElementById('loadingOverlay').style.display = 'none'; 
        }

        // æ–°ç‰ˆåŸºç¡€æˆæƒå¼¹çª— (ä¸‰æ¡£é€‰æ‹©)
        function showBaseAuthDialog() {
            const old = document.getElementById('authOverlay');
            if (old) old.remove();
            
            const overlay = document.createElement('div');
            overlay.className = 'auth-overlay';
            overlay.id = 'authOverlay';
            
            let tiersHtml = '';
            TIERS.forEach((tier, index) => {
                tiersHtml += `
                    <div class="price-tier" data-tier-index="${index}" data-days="${tier.days}" data-amount="${tier.amount}">
                        <div class="tier-info">
                            <h4>${tier.label} æˆæƒ</h4>
                            <p>æœ‰æ•ˆæœŸ ${tier.days} å¤©</p>
                        </div>
                        <div class="tier-price">${tier.amount} <small>USDT</small></div>
                    </div>
                `;
            });

            overlay.innerHTML = `
                <div class="auth-dialog">
                    <div style="text-align:center;margin-bottom:20px;">
                        <div style="font-size:48px;">ğŸ”</div>
                        <h2 style="color:#e2e8f0;font-size:1.5rem;">æ•°æ®æˆæƒ</h2>
                        <p style="color:#94a3b8;">é€‰æ‹©å¥—é¤å¹¶è¿æ¥é’±åŒ…æ”¯ä»˜</p>
                    </div>
                    
                    <div style="display:flex;gap:8px;margin-bottom:20px;border-bottom:1px solid #334155;padding-bottom:15px;">
                        <button class="auth-tab active" data-tab="pay">ğŸ’ é’±åŒ…æ”¯ä»˜</button>
                        <button class="auth-tab" data-tab="admin">ğŸ‘‘ ç®¡ç†å‘˜</button>
                    </div>

                    <div id="payPanel" class="auth-panel">
                        <div class="price-tier-container">
                            ${tiersHtml}
                        </div>
                        <div style="margin:15px 0 10px; text-align:center; color:#94a3b8; font-size:0.8rem;">
                            ï¸é€‰æ‹©å¥—é¤åç‚¹å‡»ä¸‹æ–¹æ”¯ä»˜æŒ‰é’®
                        </div>
                        <button id="payBtn" class="btn-pay" disabled>ğŸ’ è¯·å…ˆé€‰æ‹©å¥—é¤</button>
                    </div>

                    <div id="adminPanel" class="auth-panel" style="display:none;">
                        <div style="margin:20px 0;">
                            <input type="password" id="adminPassword" placeholder="è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç " 
                                style="width:100%;padding:14px;background:#0f172a;border:2px solid #334155;border-radius:30px;color:#e2e8f0;font-size:1rem;text-align:center;outline:none;margin-bottom:15px;">
                            <button id="adminBtn" class="btn-admin">ğŸ‘‘ ç®¡ç†å‘˜ç™»å½•</button>
                        </div>
                    </div>

                    <div style="margin-top:20px;text-align:center;">
                        <button id="closeBtn" class="btn-close">å…³é—­</button>
                    </div>
                </div>
            `;

            document.body.appendChild(overlay);

            let selectedTier = null; // { days, amount }

            // å¥—é¤ç‚¹å‡»é€‰æ‹©
            overlay.querySelectorAll('.price-tier').forEach(el => {
                el.addEventListener('click', (e) => {
                    overlay.querySelectorAll('.price-tier').forEach(t => t.classList.remove('selected'));
                    el.classList.add('selected');
                    const days = parseInt(el.dataset.days);
                    const amount = parseFloat(el.dataset.amount);
                    selectedTier = { days, amount };
                    const payBtn = document.getElementById('payBtn');
                    payBtn.disabled = false;
                    payBtn.textContent = `ğŸ’ æ”¯ä»˜ ${amount} USDT (${days}å¤©)`;
                });
            });

            // é€‰é¡¹å¡åˆ‡æ¢
            overlay.addEventListener('click', (e) => {
                const target = e.target;
                if (target.classList.contains('auth-tab')) {
                    document.querySelectorAll('.auth-tab').forEach(t => {
                        t.classList.remove('active');
                        t.style.background = '#334155';
                        t.style.color = '#94a3b8';
                    });
                    target.classList.add('active');
                    target.style.background = '#3b82f6';
                    target.style.color = 'white';
                    
                    const tab = target.dataset.tab;
                    document.getElementById('payPanel').style.display = tab === 'pay' ? 'block' : 'none';
                    document.getElementById('adminPanel').style.display = tab === 'admin' ? 'block' : 'none';
                }
                
                if (target.id === 'closeBtn' || target.closest('#closeBtn')) {
                    document.body.removeChild(overlay);
                    if (!AuthManager.isAuthorized()) {
                        // æœªæˆæƒåˆ™ç¨åå†æ¬¡å¼¹çª— (é¿å…ç©ºçª—)
                        setTimeout(() => showBaseAuthDialog(), 500);
                    }
                }
            });

            // æ”¯ä»˜æŒ‰é’®
            document.getElementById('payBtn').addEventListener('click', async () => {
                if (!selectedTier) {
                    alert('è¯·å…ˆé€‰æ‹©å¥—é¤');
                    return;
                }
                const btn = document.getElementById('payBtn');
                try {
                    btn.disabled = true;
                    btn.textContent = 'æ”¯ä»˜å¤„ç†ä¸­...';

                    await AuthManager.checkWallet();
                    await AuthManager.checkNetwork();

                    const address = await AuthManager.connectWallet();

                    if (AuthManager.isAdminAddress(address)) {
                        const authData = AuthManager.saveAdminAuth(address, 'address');
                        document.body.removeChild(overlay);
                        showSuccessToast('ğŸ‘‘ ç®¡ç†å‘˜åœ°å€ç™»å½•æˆåŠŸ');
                        location.reload();
                        return;
                    }

                    const provider = new ethers.BrowserProvider(window.ethereum);
                    const requiredAmount = selectedTier.amount;
                    const days = selectedTier.days;

                    await AuthManager.checkUSDTBalance(address, provider, requiredAmount);

                    const hasAllowance = await AuthManager.checkAllowance(address, provider, requiredAmount);
                    if (!hasAllowance) {
                        btn.textContent = 'æˆæƒä¸­...';
                        await AuthManager.approveUSDT(address, provider, requiredAmount);
                    }

                    btn.textContent = 'æ”¯ä»˜ä¸­...';
                    const txHash = await AuthManager.sendUSDT(address, provider, requiredAmount);

                    const authData = AuthManager.savePaymentAuth(address, days, requiredAmount, txHash);

                    document.body.removeChild(overlay);
                    showSuccessToast(`âœ… æˆæƒæˆåŠŸï¼æœ‰æ•ˆæœŸè‡³ï¼š${DateUtils.formatDate(authData.expireTime)}`);
                    location.reload();

                } catch (error) {
                    console.error('æ”¯ä»˜é”™è¯¯:', error);
                    let errorMsg = 'âŒ æˆæƒå¤±è´¥ï¼š';
                    if (error.message === 'NO_WALLET') {
                        errorMsg += 'æœªå®‰è£…é’±åŒ…';
                        if (confirm('æœªå®‰è£…MetaMaskï¼Œæ˜¯å¦å‰å¾€å®‰è£…ï¼Ÿ')) {
                            window.open('https://metamask.io/download/', '_blank');
                        }
                    } else if (error.message.includes('INSUFFICIENT_BALANCE')) {
                        const balance = error.message.split(':')[1];
                        errorMsg = `âŒ USDTä½™é¢ä¸è¶³ (å½“å‰: ${balance} USDT)`;
                    } else {
                        errorMsg += error.message || 'æœªçŸ¥é”™è¯¯';
                    }
                    alert(errorMsg);
                    btn.disabled = false;
                    btn.textContent = `ğŸ’ æ”¯ä»˜ ${selectedTier.amount} USDT (${selectedTier.days}å¤©)`;
                }
            });

            // ç®¡ç†å‘˜ç™»å½•
            document.getElementById('adminBtn').addEventListener('click', () => {
                const password = document.getElementById('adminPassword').value.trim();
                if (AuthManager.validateAdminPassword(password)) {
                    const authData = AuthManager.saveAdminAuth('password', 'password');
                    document.body.removeChild(overlay);
                    showSuccessToast('ğŸ‘‘ ç®¡ç†å‘˜ç™»å½•æˆåŠŸ');
                    location.reload();
                } else {
                    alert('âŒ ç®¡ç†å‘˜å¯†ç é”™è¯¯');
                }
            });

            document.getElementById('adminPassword').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') document.getElementById('adminBtn').click();
            });
        }

        // æ¯æ—¥äºŒæ¬¡è§£é” (ä¿æŒä¸å˜ï¼Œä½†éœ€æ³¨æ„å®ƒä¾èµ–åŸºç¡€æˆæƒ)
        async function unlockDailyStats() {
            if (dailyUnlocked) {
                document.getElementById('dailyLockOverlay').style.display = 'none';
                document.getElementById('dailyStatsContent').style.display = 'block';
                return;
            }
            if (!AuthManager.isAuthorized()) {
                alert('è¯·å…ˆå®ŒæˆåŸºç¡€æˆæƒæ”¯ä»˜');
                showBaseAuthDialog();
                return;
            }
            try {
                await AuthManager.checkWallet();
                await AuthManager.checkNetwork();
                const address = await AuthManager.connectWallet();

                if (AuthManager.isAdminAddress(address)) {
                    dailyUnlocked = true;
                    localStorage.setItem(CONFIG.DAILY_UNLOCK_KEY, 'true');
                    document.getElementById('dailyLockOverlay').style.display = 'none';
                    document.getElementById('dailyStatsContent').style.display = 'block';
                    showSuccessToast('ğŸ‘‘ ç®¡ç†å‘˜å·²è§£é”æ¯æ—¥æ˜ç»†');
                    return;
                }

                const provider = new ethers.BrowserProvider(window.ethereum);
                const requiredAmount = 10; // äºŒæ¬¡è§£é”å›ºå®š10U

                await AuthManager.checkUSDTBalance(address, provider, requiredAmount);

                const hasAllowance = await AuthManager.checkAllowance(address, provider, requiredAmount);
                if (!hasAllowance) {
                    showLoading('æˆæƒä¸­...');
                    await AuthManager.approveUSDT(address, provider, requiredAmount);
                    hideLoading();
                }

                showLoading('æ”¯ä»˜10 USDTè§£é”æ¯æ—¥æ˜ç»†...');
                const txHash = await AuthManager.sendUSDT(address, provider, requiredAmount);

                dailyUnlocked = true;
                localStorage.setItem(CONFIG.DAILY_UNLOCK_KEY, 'true');
                hideLoading();
                document.getElementById('dailyLockOverlay').style.display = 'none';
                document.getElementById('dailyStatsContent').style.display = 'block';
                showSuccessToast('âœ… æ¯æ—¥æ˜ç»†å·²è§£é”ï¼');
            } catch (error) {
                console.error('äºŒæ¬¡è§£é”å¤±è´¥:', error);
                hideLoading();
                let errorMsg = 'âŒ è§£é”å¤±è´¥ï¼š';
                if (error.message === 'NO_WALLET') errorMsg += 'æœªå®‰è£…é’±åŒ…';
                else if (error.message.includes('INSUFFICIENT_BALANCE')) {
                    const balance = error.message.split(':')[1];
                    errorMsg = `âŒ USDTä½™é¢ä¸è¶³ (å½“å‰: ${balance} USDT)`;
                } else errorMsg += error.message || 'æœªçŸ¥é”™è¯¯';
                alert(errorMsg);
            }
        }

        // åŠ è½½æ•°æ®ç­‰å‡½æ•° (å¤ç”¨ä¹‹å‰)
        async function loadCloudData(showLoadingOverlay = false) {
            if (isLoading) return;
            isLoading = true;
            const btn = document.getElementById('refreshBtn');
            if (btn) { btn.disabled = true; btn.innerText = 'åˆ·æ–°ä¸­...'; }
            if (showLoadingOverlay) showLoading('åŠ è½½äº‘ç«¯æ•°æ®...');
            try {
                const response = await fetch(`${CONFIG.API_BASE}/`);
                const result = await response.json();
                if (result.success && result.data) {
                    let cloudData = result.data;
                    if (typeof cloudData === 'string') { try { cloudData = JSON.parse(cloudData); } catch (e) {} }
                    
                    if (cloudData?.allRecords) currentData.allRecords = cloudData.allRecords;
                    else if (cloudData?.records) currentData.allRecords = cloudData.records.map(r => ({ ...r, isRedeemed: false }));
                    
                    if (cloudData?.stats) currentData.stats = { ...currentData.stats, ...cloudData.stats };
                    
                    if (cloudData?.lastUpdate) { currentData.lastUpdate = cloudData.lastUpdate; updateLastUpdateTime(cloudData.lastUpdate); }
                    
                    calculateStatsFromRecords();
                    document.getElementById('lpPoolBalanceDisplay').innerText = (currentData.stats.lpWithdrawable || 0).toFixed(2);
                    updateCharts();
                    if (dailyUnlocked) renderDailyStats();
                }
            } catch (error) {
                console.error('åŠ è½½å¤±è´¥:', error);
                if (showLoadingOverlay) showSuccessToast('âŒ åŠ è½½å¤±è´¥');
            } finally {
                isLoading = false;
                if (btn) { btn.disabled = false; btn.innerText = 'ğŸ”„ åˆ·æ–°'; }
                if (showLoadingOverlay) hideLoading();
            }
        }

        function calculateStatsFromRecords() {
            const records = currentData.allRecords || [];
            const stats = { totalStaked:0, totalStaked1d:0, totalStaked15d:0, totalStaked30d:0, count1d:0, count15d:0, count30d:0, unlock2d:0, unlock7d:0, unlock15d:0, lpWithdrawable: currentData.stats?.lpWithdrawable || 0 };
            const nowSec = Math.floor(Date.now() / 1000);
            records.forEach(record => {
                if (record.isRedeemed) return;
                const amount = record.amount || 0;
                const stakeIndex = record.stakeIndex || 0;
                stats.totalStaked += amount;
                if (stakeIndex === 0) { stats.totalStaked1d += amount; stats.count1d++; } 
                else if (stakeIndex === 1) { stats.totalStaked15d += amount; stats.count15d++; } 
                else if (stakeIndex === 2) { stats.totalStaked30d += amount; stats.count30d++; }
                const stakeTime = record.stakeTime || 0;
                const duration = stakeIndex === 0 ? 86400 : stakeIndex === 1 ? 1296000 : 2592000;
                const unlockTime = stakeTime + duration;
                const remain = unlockTime - nowSec;
                if (remain <= 172800) stats.unlock2d += amount;
                if (remain <= 604800) stats.unlock7d += amount;
                if (remain <= 1296000) stats.unlock15d += amount;
            });
            currentData.stats = stats;
        }

        function updateLastUpdateTime(timestamp) {
            const date = new Date(timestamp);
            const formatted = `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')} ${String(date.getHours()).padStart(2,'0')}:${String(date.getMinutes()).padStart(2,'0')}`;
            document.getElementById('lastUpdateTime').innerText = formatted;
        }

        function renderDailyStats() {
            const allRecords = currentData.allRecords || [];
            if (allRecords.length === 0) {
                document.getElementById('dailyStatsBody').innerHTML = '<tr><td colspan="6" class="empty-state">ğŸ“Š æš‚æ— æ•°æ®</td></tr>';
                return;
            }
            const dailyMap = new Map(), activeMap = new Map();
            allRecords.forEach(record => {
                if (!record.stakeTime) return;
                const dateStr = getDateStrFromTimestamp(record.stakeTime);
                const amount = record.amount || 0;
                const stakeIndex = record.stakeIndex || 0;
                if (!dailyMap.has(dateStr)) {
                    dailyMap.set(dateStr, { newStake:0, byPool:{0:0,1:0,2:0}, count:{0:0,1:0,2:0} });
                }
                const dayData = dailyMap.get(dateStr);
                dayData.newStake += amount;
                dayData.byPool[stakeIndex] += amount;
                dayData.count[stakeIndex]++;
                if (!record.isRedeemed) {
                    activeMap.set(dateStr, (activeMap.get(dateStr)||0) + amount);
                }
            });
            const sortedDates = Array.from(dailyMap.entries()).map(([date, data]) => ({
                date, newStake: data.newStake, activeStake: activeMap.get(date)||0,
                new1d: data.byPool[0], new15d: data.byPool[1], new30d: data.byPool[2],
                count1d: data.count[0], count15d: data.count[1], count30d: data.count[2]
            })).sort((a,b) => b.date.localeCompare(a.date));
            const tbody = document.getElementById('dailyStatsBody');
            tbody.innerHTML = sortedDates.map(day => `
                <tr>
                    <td>${day.date}</td>
                    <td>${day.newStake.toFixed(2)}</td>
                    <td>${day.activeStake.toFixed(2)}</td>
                    <td>${day.new1d.toFixed(2)} <span class="stats-badge">${day.count1d}</span></td>
                    <td>${day.new15d.toFixed(2)} <span class="stats-badge">${day.count15d}</span></td>
                    <td>${day.new30d.toFixed(2)} <span class="stats-badge">${day.count30d}</span></td>
                </tr>
            `).join('');
        }

        // å›¾è¡¨å‡½æ•°
        function updateCharts() { updateTrendChart(); updatePieAndUnlockCharts(); }
        function setTrendRange(days) {
            trendRange = days;
            document.querySelectorAll('.range-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent.includes(days + 'å¤©')) btn.classList.add('active');
            });
            updateTrendChart();
        }
        function updateTrendChart() {
            const allRecords = currentData.allRecords || [];
            if (allRecords.length === 0) { if (trendChart) trendChart.destroy(); trendChart = null; return; }
            const dailyMap = new Map(), activeMap = new Map();
            allRecords.forEach(record => {
                if (!record.stakeTime) return;
                const dateStr = getDateStrFromTimestamp(record.stakeTime);
                const amount = record.amount || 0;
                dailyMap.set(dateStr, (dailyMap.get(dateStr)||0) + amount);
                if (!record.isRedeemed) activeMap.set(dateStr, (activeMap.get(dateStr)||0) + amount);
            });
            const allDates = Array.from(dailyMap.keys()).sort((a,b) => a.localeCompare(b));
            const recentDates = allDates.slice(-trendRange);
            const newData = recentDates.map(d => dailyMap.get(d) || 0);
            const activeData = recentDates.map(d => activeMap.get(d) || 0);
            const ctx = document.getElementById('trendChart')?.getContext('2d');
            if (!ctx) return;
            if (trendChart) trendChart.destroy();
            trendChart = new Chart(ctx, {
                type: 'line',
                data: { labels: recentDates, datasets: [
                    { label: 'æ–°å¢è´¨æŠ¼', data: newData, borderColor: '#3b82f6', backgroundColor: 'rgba(59,130,246,0.1)', tension:0.2, fill:true },
                    { label: 'ä»åœ¨è´¨æŠ¼', data: activeData, borderColor: '#4ade80', backgroundColor: 'rgba(74,222,128,0.1)', tension:0.2, fill:true }
                ] },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, grid: { color: '#334155' }, ticks: { color: '#94a3b8' } }, x: { ticks: { color: '#94a3b8', maxRotation: 45 } } }, plugins: { legend: { labels: { color: '#e2e8f0' } } } }
            });
        }
        function updatePieAndUnlockCharts() {
            const records = currentData.allRecords?.filter(r => !r.isRedeemed) || [];
            let sum1d=0, sum15d=0, sum30d=0;
            records.forEach(r => { const amt = r.amount||0; if(r.stakeIndex===0) sum1d+=amt; else if(r.stakeIndex===1) sum15d+=amt; else if(r.stakeIndex===2) sum30d+=amt; });
            const total = sum1d+sum15d+sum30d;
            document.getElementById('pieLegend').innerHTML = `
                <div class="legend-item"><span class="legend-color" style="background:#3b82f6;"></span>1å¤©: ${sum1d.toFixed(2)} (${total>0? (sum1d/total*100).toFixed(1):0}%)</div>
                <div class="legend-item"><span class="legend-color" style="background:#8b5cf6;"></span>15å¤©: ${sum15d.toFixed(2)} (${total>0? (sum15d/total*100).toFixed(1):0}%)</div>
                <div class="legend-item"><span class="legend-color" style="background:#ec4899;"></span>30å¤©: ${sum30d.toFixed(2)} (${total>0? (sum30d/total*100).toFixed(1):0}%)</div>
            `;
            let u0_2=0,u2_7=0,u7_15=0,u15_25=0,u25p=0;
            const nowSec = Math.floor(Date.now()/1000);
            records.forEach(r => {
                const amt = r.amount||0; const stakeTime = r.stakeTime||0; const dur = r.stakeIndex===0?86400: r.stakeIndex===1?1296000:2592000;
                const remain = stakeTime + dur - nowSec;
                if(remain<=172800) u0_2+=amt; else if(remain<=604800) u2_7+=amt; else if(remain<=1296000) u7_15+=amt; else if(remain<=2160000) u15_25+=amt; else u25p+=amt;
            });
            const pieCtx = document.getElementById('pieChart')?.getContext('2d');
            if(pieCtx) {
                if(pieChart) pieChart.destroy();
                pieChart = new Chart(pieCtx, { type:'doughnut', data: { labels:['1å¤©','15å¤©','30å¤©'], datasets:[{ data:[sum1d,sum15d,sum30d], backgroundColor:['#3b82f6','#8b5cf6','#ec4899'], borderColor:'#1e293b', borderWidth:2 }] }, options: { responsive:true, maintainAspectRatio:false, plugins:{ legend:{ display:false } } } });
            }
            const unlockCtx = document.getElementById('unlockChart')?.getContext('2d');
            if(unlockCtx) {
                if(unlockChart) unlockChart.destroy();
                unlockChart = new Chart(unlockCtx, { type:'bar', data: { labels:['0-2å¤©','2-7å¤©','7-15å¤©','15-25å¤©','>25å¤©'], datasets:[{ label:'å¯èµå›é‡‘é¢ (USDT)', data:[u0_2,u2_7,u7_15,u15_25,u25p], backgroundColor:['#f87171','#fbbf24','#60a5fa','#a78bfa','#ec4899'], borderRadius:6 }] }, options: { responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true, grid:{color:'#334155'}, ticks:{color:'#94a3b8'} }, x:{ ticks:{color:'#94a3b8'} } }, plugins:{ legend:{ labels:{ color:'#e2e8f0' } } } } });
            }
        }
        function getDateStrFromTimestamp(timestamp) {
            const date = new Date(timestamp * 1000);
            return `${date.getUTCFullYear()}-${String(date.getUTCMonth()+1).padStart(2,'0')}-${String(date.getUTCDate()).padStart(2,'0')}`;
        }

        function exportDailyStats() { alert('å¯¼å‡ºCSVåŠŸèƒ½å·²è§£é”'); }
        async function refreshLPPool() {
            const btn = document.getElementById('refreshLPBtn');
            btn.disabled = true; btn.innerText = 'åˆ·æ–°ä¸­...';
            try {
                if (!usdtContract) {
                    const provider = new ethers.JsonRpcProvider('https://bsc-dataseed1.binance.org');
                    usdtContract = new ethers.Contract( CONFIG.USDT, [ "function balanceOf(address account) view returns (uint256)", "function decimals() view returns (uint8)" ], provider );
                }
                const balance = await usdtContract.balanceOf(CONFIG.LP_POOL);
                const decimals = await usdtContract.decimals();
                const formattedBalance = parseFloat(ethers.formatUnits(balance, decimals));
                currentData.stats.lpWithdrawable = formattedBalance;
                document.getElementById('lpPoolBalanceDisplay').innerText = formattedBalance.toFixed(2);
                btn.innerText = 'âœ… æˆåŠŸ';
            } catch (error) {
                document.getElementById('lpPoolBalanceDisplay').innerHTML = '<span style="color:#f87171;">å¤±è´¥</span>';
                btn.innerText = 'âŒ é‡è¯•';
            } finally { setTimeout(() => { btn.innerText = 'ğŸ’° åˆ·æ–°LP'; btn.disabled = false; }, 1500); }
        }
        function handleManualRefresh() { loadCloudData(true); }
        function switchDataTab(tab) {
            document.querySelectorAll('.data-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.data-panel').forEach(p => p.classList.remove('active'));
            document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
            document.getElementById(`panel-${tab}`).classList.add('active');
            if (tab === 'charts') setTimeout(() => updateCharts(), 50);
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('stakingContractAddress').innerText = CONFIG.STAKING;
            try {
                const provider = new ethers.JsonRpcProvider('https://bsc-dataseed1.binance.org');
                usdtContract = new ethers.Contract( CONFIG.USDT, ["function balanceOf(address) view returns (uint256)", "function decimals() view returns (uint8)"], provider );
            } catch (error) { console.error('USDTåˆçº¦åˆå§‹åŒ–å¤±è´¥:', error); }

            dailyUnlocked = localStorage.getItem(CONFIG.DAILY_UNLOCK_KEY) === 'true';
            if (dailyUnlocked) {
                document.getElementById('dailyLockOverlay').style.display = 'none';
                document.getElementById('dailyStatsContent').style.display = 'block';
            }

            // æ£€æŸ¥åŸºç¡€æˆæƒ
            if (!AuthManager.isAuthorized()) {
                // å»¶è¿Ÿä¸€ä¸‹æ˜¾ç¤ºå¼¹çª—ï¼Œé¿å…è¢«å…¶ä»–å…ƒç´ è¦†ç›–
                setTimeout(() => showBaseAuthDialog(), 100);
            } else {
                loadCloudData(false);
            }

            // é€‰é¡¹å¡ç»‘å®š
            document.querySelector('.data-tabs').addEventListener('click', (e) => {
                const tab = e.target.closest('.data-tab');
                if (tab) switchDataTab(tab.dataset.tab);
            });

            // é»˜è®¤é«˜äº®90å¤©
            document.querySelectorAll('.range-btn').forEach(btn => {
                if (btn.textContent.includes('90å¤©')) btn.classList.add('active');
            });

            // å…¨å±€å‡½æ•°
            window.unlockDailyStats = unlockDailyStats;
            window.refreshLPPool = refreshLPPool;
            window.handleManualRefresh = handleManualRefresh;
            window.setTrendRange = setTrendRange;
            window.exportDailyStats = exportDailyStats;
        });
    </script>
</body>
</html>
