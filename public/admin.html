<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GANAæ•°æ®ç®¡ç†åå° Â· ç®¡ç†å‘˜</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body { 
            background-color: #0f172a; 
            color: #e2e8f0; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .login-panel {
            background: linear-gradient(145deg, #1e293b, #0f172a);
            border: 2px solid #334155;
            border-radius: 32px;
            padding: 40px;
            max-width: 400px;
            margin: 100px auto;
            text-align: center;
        }
        
        .login-panel h2 {
            color: #e2e8f0;
            margin-bottom: 30px;
            font-size: 1.8rem;
        }
        
        .login-panel input {
            width: 100%;
            padding: 15px;
            background: #0f172a;
            border: 2px solid #334155;
            border-radius: 30px;
            color: #e2e8f0;
            font-size: 1rem;
            margin-bottom: 20px;
            outline: none;
        }
        
        .login-panel input:focus {
            border-color: #3b82f6;
        }
        
        .login-panel button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            border: none;
            border-radius: 30px;
            color: white;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
        }
        
        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(145deg, #1e293b, #0f172a);
            border-radius: 16px;
            border: 1px solid #334155;
        }
        
        .admin-header h1 {
            font-size: 1.8rem;
            background: linear-gradient(135deg, #60a5fa, #c084fc);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .admin-header .badge {
            background: #f59e0b;
            color: white;
            padding: 8px 16px;
            border-radius: 30px;
            font-size: 0.9rem;
        }
        
        .query-panel {
            background: linear-gradient(145deg, #1e293b, #0f172a);
            border: 1px solid #334155;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .query-panel textarea {
            width: 100%;
            min-height: 150px;
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 12px;
            color: #e2e8f0;
            padding: 15px;
            font-family: monospace;
            margin-bottom: 15px;
            resize: vertical;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            border: none;
            padding: 12px 24px;
            border-radius: 30px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            flex: 1;
            min-width: 120px;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #10b981, #059669);
            border: none;
            padding: 12px 24px;
            border-radius: 30px;
            color: white;
            font-weight: 600;
            cursor: pointer;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            border: none;
            padding: 12px 24px;
            border-radius: 30px;
            color: white;
            font-weight: 600;
            cursor: pointer;
        }
        
        .stats-summary {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin: 20px 0;
        }
        
        .stat-item {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 10px;
            text-align: center;
        }
        
        .stat-label {
            color: #94a3b8;
            font-size: 0.8rem;
        }
        
        .stat-value {
            color: #38bdf8;
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        .progress-container {
            margin-top: 15px;
            padding: 15px;
            background: #1e293b;
            border-radius: 30px;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #334155;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
            transition: width 0.3s ease;
        }
        
        .github-config {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 15px;
            margin: 20px 0;
        }
        
        .github-config input {
            width: 100%;
            padding: 10px;
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 30px;
            color: #e2e8f0;
            margin: 5px 0;
        }
        
        .preview-table {
            max-height: 400px;
            overflow-y: auto;
            background: #1e293b;
            border-radius: 12px;
            padding: 10px;
        }
        
        .preview-table table {
            width: 100%;
            font-size: 0.8rem;
        }
        
        .preview-table th {
            color: #94a3b8;
            padding: 8px;
            text-align: left;
        }
        
        .preview-table td {
            padding: 8px;
            border-bottom: 1px solid #334155;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ç™»å½•é¢æ¿ -->
        <div id="loginPanel" class="login-panel">
            <h2>ğŸ” ç®¡ç†å‘˜ç™»å½•</h2>
            <input type="password" id="adminPassword" placeholder="è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç ">
            <button onclick="adminLogin()">ç™»å½•</button>
        </div>

        <!-- ç®¡ç†é¢æ¿ -->
        <div id="adminPanel" style="display: none;">
            <div class="admin-header">
                <h1>âš™ï¸ GANA æ•°æ®ç®¡ç†åå°</h1>
                <span class="badge">ç®¡ç†å‘˜æ¨¡å¼</span>
            </div>

            <!-- GitHub é…ç½® -->
            <div class="github-config">
                <h4 style="color: #94a3b8; margin-bottom: 10px;">ğŸ“¦ GitHub é…ç½®</h4>
                <input type="text" id="githubOwner" placeholder="GitHubç”¨æˆ·å" value="ä½ çš„ç”¨æˆ·å">
                <input type="text" id="githubRepo" placeholder="ä»“åº“å" value="gana-stake-data">
                <input type="text" id="githubToken" placeholder="Personal Access Token" type="password">
                <input type="text" id="githubPath" placeholder="æ–‡ä»¶è·¯å¾„" value="data/stake-data.json">
                <button class="btn-primary" onclick="testGithubConnection()" style="margin-top: 10px;">æµ‹è¯•è¿æ¥</button>
            </div>

            <!-- æŸ¥è¯¢é¢æ¿ -->
            <div class="query-panel">
                <h4 style="color: #94a3b8; margin-bottom: 10px;">ğŸ” é“¾ä¸ŠæŸ¥è¯¢</h4>
                <textarea id="addressList" placeholder="æ¯è¡Œä¸€ä¸ªåœ°å€ï¼Œæœ€å¤š5000ä¸ª">0x72212F35aC448FE7763aA1BFdb360193Fa098E52</textarea>
                
                <div class="button-group">
                    <button class="btn-primary" onclick="fullQuery()" id="fullQueryBtn">ğŸš€ å…¨é‡æŸ¥è¯¢</button>
                    <button class="btn-primary" onclick="incrementalQuery()" id="incrementalBtn">ğŸ”„ å¢é‡æ›´æ–°</button>
                    <button class="btn-primary" onclick="refreshLPPool()" id="refreshLPBtn">ğŸ’§ åˆ·æ–°LPæ± </button>
                </div>

                <!-- è¿›åº¦æ¡ -->
                <div id="progressContainer" class="progress-container" style="display: none;">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
                    </div>
                    <div style="color: #38bdf8; font-size: 0.9rem; margin-top: 8px; text-align: center;" id="progressText">å‡†å¤‡æŸ¥è¯¢...</div>
                </div>

                <!-- ç»Ÿè®¡æ‘˜è¦ -->
                <div class="stats-summary" id="statsSummary">
                    <div class="stat-item">
                        <div class="stat-label">æ€»è´¨æŠ¼</div>
                        <div class="stat-value" id="statTotal">0.00</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">æ´»è·ƒè®°å½•</div>
                        <div class="stat-value" id="statCount">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">LPæ± </div>
                        <div class="stat-value" id="statLP">0.00</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">åœ°å€æ•°</div>
                        <div class="stat-value" id="statAddresses">0</div>
                    </div>
                </div>
            </div>

            <!-- æ“ä½œæŒ‰é’®ç»„ -->
            <div class="button-group">
                <button class="btn-success" onclick="uploadToGithub()">ğŸ“¤ ä¸Šä¼ åˆ° GitHub</button>
                <button class="btn-primary" onclick="loadFromGithub()">ğŸ“¥ ä» GitHub åŠ è½½</button>
                <button class="btn-danger" onclick="resetData()">ğŸ—‘ï¸ é‡ç½®æ•°æ®</button>
            </div>

            <!-- æ•°æ®é¢„è§ˆ -->
            <div class="query-panel">
                <h4 style="color: #94a3b8; margin-bottom: 10px;">ğŸ‘ï¸ æ•°æ®é¢„è§ˆ (æœ€æ–°20æ¡)</h4>
                <div class="preview-table" id="previewArea">
                    <table>
                        <thead>
                            <tr>
                                <th>åœ°å€</th>
                                <th>é‡‘é¢</th>
                                <th>å‘¨æœŸ</th>
                                <th>çŠ¶æ€</th>
                            </tr>
                        </thead>
                        <tbody id="previewBody">
                            <tr><td colspan="4" style="text-align: center;">æš‚æ— æ•°æ®</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ================= é…ç½® =================
        const ADMIN_PASSWORD = "ä½ çš„ç®¡ç†å‘˜å¯†ç "; // ä¿®æ”¹ä¸ºä½ è‡ªå·±çš„å¯†ç 
        
        const CONFIG = {
            STAKING: "0x72212F35aC448FE7763aA1BFdb360193Fa098E52",
            LP_POOL: "0xa2f464a2462aed49b9b31eb8861bc6b0bbb0483f",
            USDT: "0x55d398326f99059fF775485246999027B3197955",
            MAX_ADDRESSES: 5000,
            BATCH_SIZE: 10,
            RETRY_LIMIT: 3,
            RETRY_DELAY: 1000
        };

        // ABI
        const ABI_STAKING = [{"inputs":[{"internalType":"address","name":"marketingAddress_","type":"address"},{"internalType":"address","name":"devAddress_","type":"address"},{"internalType":"address","name":"threesevenAddress_","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"inputs":[{"internalType":"uint256","name":"x","type":"uint256"},{"internalType":"uint256","name":"y","type":"uint256"}],"name":"PRBMath_MulDiv18_Overflow","type":"error"},{"inputs":[{"internalType":"uint256","name":"x","type":"uint256"},{"internalType":"uint256","name":"y","type":"uint256"},{"internalType":"uint256","name":"denominator","type":"uint256"}],"name":"PRBMath_MulDiv_Overflow","type":"error"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":true,"internalType":"address","name":"newOwner","type":"address"}],"name":"OwnershipTransferred","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"reward","type":"uint256"},{"indexed":false,"internalType":"uint40","name":"timestamp","type":"uint40"},{"indexed":false,"internalType":"uint256","name":"index","type":"uint256"}],"name":"RewardPaid","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"index","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"stakeTime","type":"uint256"}],"name":"Staked","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"Transfer","type":"event"},{"inputs":[],"name":"GANA","outputs":[{"internalType":"contract IGANA","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MIN_STAKE_USDT","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"back_Fee","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"balance","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"balances","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"decimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"devAddress","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"isPreacher","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"market_Fee","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"marketingAddress","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"maxStakeAmount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"network1In","outputs":[{"internalType":"uint256","name":"value","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"},{"internalType":"uint8","name":"index","type":"uint8"}],"name":"principalPlusRewardOfSlot","outputs":[{"internalType":"uint256","name":"reward","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"ratePerSec","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_gana","type":"address"}],"name":"setGANA","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint160","name":"_amount","type":"uint160"},{"internalType":"uint256","name":"amountOutMin","type":"uint256"},{"internalType":"uint8","name":"_stakeIndex","type":"uint8"}],"name":"stake","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"stakeCount","outputs":[{"internalType":"uint256","name":"count","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"sync","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"t_supply","outputs":[{"internalType":"uint40","name":"stakeTime","type":"uint40"},{"internalType":"uint160","name":"tamount","type":"uint160"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"threesevenAddress","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"threeseven_Fee","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"index","type":"uint256"}],"name":"unstake","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"userIndex","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"userStakeRecord","outputs":[{"internalType":"uint40","name":"stakeTime","type":"uint40"},{"internalType":"uint160","name":"amount","type":"uint160"},{"internalType":"bool","name":"status","type":"bool"},{"internalType":"uint8","name":"stakeIndex","type":"uint8"}],"stateMutability":"view","type":"function"}];

        const USDT_ABI = [
            "function balanceOf(address account) view returns (uint256)",
            "function decimals() view returns (uint8)"
        ];

        const STAKE_DURATIONS = {0: 86400, 1: 1296000, 2: 2592000};

        // ================= å…¨å±€å˜é‡ =================
        let stakingContract;
        let isQuerying = false;
        let queryResults = [];
        let allStakeRecords = [];
        let stats = {
            totalStaked: 0, totalStaked1d: 0, totalStaked15d: 0, totalStaked30d: 0,
            count1d: 0, count15d: 0, count30d: 0,
            unlock2d: 0, unlock7d: 0, unlock15d: 0,
            lpWithdrawable: 0
        };

        // ================= ç®¡ç†å‘˜ç™»å½• =================
        function adminLogin() {
            const pwd = document.getElementById('adminPassword').value;
            if (pwd === ADMIN_PASSWORD) {
                document.getElementById('loginPanel').style.display = 'none';
                document.getElementById('adminPanel').style.display = 'block';
                initContract();
                loadLastData();
            } else {
                alert('âŒ å¯†ç é”™è¯¯');
            }
        }

        // ================= åˆå§‹åŒ–åˆçº¦ =================
        async function initContract() {
            try {
                const provider = new ethers.providers.JsonRpcProvider('https://bsc-dataseed1.binance.org');
                stakingContract = new ethers.Contract(CONFIG.STAKING, ABI_STAKING, provider);
                console.log('âœ… åˆçº¦åˆå§‹åŒ–æˆåŠŸ');
            } catch (error) {
                console.error('âŒ åˆçº¦åˆå§‹åŒ–å¤±è´¥:', error);
            }
        }

        // ================= ä»GitHubåŠ è½½ä¸Šæ¬¡æ•°æ® =================
        async function loadLastData() {
            const owner = document.getElementById('githubOwner').value;
            const repo = document.getElementById('githubRepo').value;
            const path = document.getElementById('githubPath').value;
            
            try {
                const response = await fetch(`https://raw.githubusercontent.com/${owner}/${repo}/main/${path}?t=${Date.now()}`);
                if (response.ok) {
                    const data = await response.json();
                    queryResults = data.queryResults || [];
                    allStakeRecords = data.allStakeRecords || [];
                    stats = data.stats || stats;
                    updatePreview();
                    updateStats();
                    console.log('âœ… ä»GitHubåŠ è½½æ•°æ®æˆåŠŸ');
                }
            } catch (e) {
                console.log('æ— å†å²æ•°æ®æˆ–åŠ è½½å¤±è´¥');
            }
        }

        // ================= æµ‹è¯•GitHubè¿æ¥ =================
        async function testGithubConnection() {
            const token = document.getElementById('githubToken').value;
            if (!token) {
                alert('è¯·è¾“å…¥GitHub Token');
                return;
            }

            try {
                const response = await fetch('https://api.github.com/user', {
                    headers: { 'Authorization': `token ${token}` }
                });
                if (response.ok) {
                    alert('âœ… GitHubè¿æ¥æˆåŠŸ');
                } else {
                    alert('âŒ è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥Token');
                }
            } catch (error) {
                alert('âŒ è¿æ¥å¤±è´¥');
            }
        }

        // ================= ä¸Šä¼ åˆ°GitHub =================
        async function uploadToGithub() {
            const token = document.getElementById('githubToken').value;
            const owner = document.getElementById('githubOwner').value;
            const repo = document.getElementById('githubRepo').value;
            const path = document.getElementById('githubPath').value;

            if (!token || !owner || !repo) {
                alert('è¯·å¡«å†™å®Œæ•´çš„GitHubé…ç½®');
                return;
            }

            const data = {
                lastUpdate: new Date().toISOString(),
                stats: stats,
                queryResults: queryResults,
                allStakeRecords: allStakeRecords,
                addressCount: queryResults.length,
                totalRecords: allStakeRecords.length
            };

            try {
                // è·å–å½“å‰æ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                let sha = null;
                const getResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
                    headers: { 'Authorization': `token ${token}` }
                });
                
                if (getResponse.ok) {
                    const file = await getResponse.json();
                    sha = file.sha;
                }

                // ä¸Šä¼ æ–°æ•°æ®
                const content = btoa(unescape(encodeURIComponent(JSON.stringify(data, null, 2))));
                
                const uploadResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: `æ›´æ–°è´¨æŠ¼æ•°æ® ${new Date().toLocaleString()}`,
                        content: content,
                        sha: sha
                    })
                });

                if (uploadResponse.ok) {
                    alert('âœ… æ•°æ®ä¸Šä¼ æˆåŠŸï¼');
                } else {
                    const error = await uploadResponse.json();
                    alert(`âŒ ä¸Šä¼ å¤±è´¥: ${error.message}`);
                }
            } catch (error) {
                console.error('ä¸Šä¼ å¤±è´¥:', error);
                alert('âŒ ä¸Šä¼ å¤±è´¥: ' + error.message);
            }
        }

        // ================= ä»GitHubåŠ è½½ =================
        async function loadFromGithub() {
            const owner = document.getElementById('githubOwner').value;
            const repo = document.getElementById('githubRepo').value;
            const path = document.getElementById('githubPath').value;

            try {
                const response = await fetch(`https://raw.githubusercontent.com/${owner}/${repo}/main/${path}?t=${Date.now()}`);
                if (response.ok) {
                    const data = await response.json();
                    queryResults = data.queryResults || [];
                    allStakeRecords = data.allStakeRecords || [];
                    stats = data.stats || stats;
                    updatePreview();
                    updateStats();
                    alert('âœ… åŠ è½½æˆåŠŸ');
                } else {
                    alert('âŒ åŠ è½½å¤±è´¥');
                }
            } catch (error) {
                alert('âŒ åŠ è½½å¤±è´¥: ' + error.message);
            }
        }

        // ================= é‡ç½®æ•°æ® =================
        function resetData() {
            if (confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰æ•°æ®å—ï¼Ÿ')) {
                queryResults = [];
                allStakeRecords = [];
                stats = {
                    totalStaked: 0, totalStaked1d: 0, totalStaked15d: 0, totalStaked30d: 0,
                    count1d: 0, count15d: 0, count30d: 0,
                    unlock2d: 0, unlock7d: 0, unlock15d: 0,
                    lpWithdrawable: 0
                };
                updatePreview();
                updateStats();
            }
        }

        // ================= æ›´æ–°é¢„è§ˆ =================
        function updatePreview() {
            document.getElementById('statTotal').innerText = stats.totalStaked.toFixed(2);
            document.getElementById('statCount').innerText = queryResults.length;
            document.getElementById('statLP').innerText = stats.lpWithdrawable.toFixed(2);
            
            const addresses = document.getElementById('addressList').value.split('\n').filter(l => l.trim().startsWith('0x'));
            document.getElementById('statAddresses').innerText = addresses.length;

            const previewBody = document.getElementById('previewBody');
            if (queryResults.length === 0) {
                previewBody.innerHTML = '<tr><td colspan="4" style="text-align: center;">æš‚æ— æ•°æ®</td></tr>';
                return;
            }

            const periodLabels = ['1å¤©', '15å¤©', '30å¤©'];
            previewBody.innerHTML = queryResults.slice(0, 20).map(r => `
                <tr>
                    <td>${r.address.slice(0, 6)}...${r.address.slice(-4)}</td>
                    <td>${r.amount.toFixed(2)}</td>
                    <td>${periodLabels[r.stakeIndex]}</td>
                    <td>${r.isRedeemed ? 'å·²èµå›' : 'æ´»è·ƒ'}</td>
                </tr>
            `).join('');
        }

        function updateStats() {
            document.getElementById('statTotal').innerText = stats.totalStaked.toFixed(2);
            document.getElementById('statCount').innerText = queryResults.length;
            document.getElementById('statLP').innerText = stats.lpWithdrawable.toFixed(2);
        }

        // ================= é“¾ä¸ŠæŸ¥è¯¢å‡½æ•° =================
        // è¿™é‡Œå¤ç”¨ä½ ä¹‹å‰çš„ fullQuery, incrementalQuery, refreshLPPool å‡½æ•°
        // ç”±äºä»£ç è¾ƒé•¿ï¼Œè¯·ä»åŸæ–‡ä»¶å¤åˆ¶è¿™äº›å‡½æ•°ï¼š
        // - fullQuery()
        // - incrementalQuery()
        // - refreshLPPool()
        // - queryAddress()
        // - getLPPoolBalance()
        // - callWithRetry()
        
        // ä¸ºäº†èŠ‚çœç¯‡å¹…ï¼Œè¿™é‡Œçœç•¥è¿™äº›å‡½æ•°çš„ä»£ç ï¼Œä½ éœ€è¦ä»åŸHTMLæ–‡ä»¶ä¸­å¤åˆ¶è¿‡æ¥
        // ä½†éœ€è¦ä¿®æ”¹è¿™äº›å‡½æ•°ä¸­çš„æ›´æ–°UIéƒ¨åˆ†ï¼Œæ”¹ä¸ºè°ƒç”¨ updatePreview() å’Œ updateStats()

        async function fullQuery() {
            // ä»åŸæ–‡ä»¶å¤åˆ¶ fullQuery å‡½æ•°ä»£ç 
            // å¹¶å°†æ‰€æœ‰ UI æ›´æ–°æ”¹ä¸ºè°ƒç”¨ updatePreview() å’Œ updateStats()
        }

        async function incrementalQuery() {
            // ä»åŸæ–‡ä»¶å¤åˆ¶ incrementalQuery å‡½æ•°ä»£ç 
        }

        async function refreshLPPool() {
            // ä»åŸæ–‡ä»¶å¤åˆ¶ refreshLPPool å‡½æ•°ä»£ç 
        }

        async function getLPPoolBalance() {
            // ä»åŸæ–‡ä»¶å¤åˆ¶ getLPPoolBalance å‡½æ•°ä»£ç 
        }

        async function callWithRetry(fn, context, retryCount = 0) {
            // ä»åŸæ–‡ä»¶å¤åˆ¶ callWithRetry å‡½æ•°ä»£ç 
        }

        async function queryAddress(address, now, limits) {
            // ä»åŸæ–‡ä»¶å¤åˆ¶ queryAddress å‡½æ•°ä»£ç 
        }
    </script>
</body>
</html>
