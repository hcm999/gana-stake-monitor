<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>drp è´¨æŠ¼ç®¡ç†</title>
    <!-- å¼•å…¥ Bootstrap ç”¨äºå¿«é€Ÿå¸ƒå±€ -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- å¼•å…¥ Ethers.js V6 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .card { background-color: #1e293b; border: 1px solid #334155; }
        .card-title { color: #fff; }
        .btn-primary { background-color: #3b82f6; border: none; }
        .btn-primary:hover { background-color: #2563eb; }
        .btn-success { background-color: #10b981; border: none; }
        .btn-danger { background-color: #ef4444; border: none; }
        .btn-warning { background-color: #f59e0b; border: none; color: #fff; }
        .btn-warning:hover { background-color: #d97706; color: #fff; }
        .warning-box {
            background-color: #450a0a;
            border: 1px solid #ef4444;
            color: #fca5a5;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 0.9rem;
        }
        .stat-value { font-size: 1.25rem; font-weight: bold; color: #38bdf8; }
        .stat-label { font-size: 0.85rem; color: #94a3b8; }
        .table { color: #cbd5e1; font-size: 0.9rem; }
        .table thead th { border-bottom: 1px solid #475569; color: #94a3b8; font-size: 0.8rem; }
        .table td { border-bottom: 1px solid #334155; vertical-align: middle; }
        input.form-control { background-color: #334155; border-color: #475569; color: white; }
        input.form-control:focus { background-color: #334155; color: white; border-color: #38bdf8; box-shadow: none; }
        .staking-btn-group { display: flex; gap: 10px; flex-wrap: wrap; }
        .staking-btn-group .btn { flex: 1; min-width: 120px; }
        .badge-duration { background-color: #374151; color: #9ca3af; padding: 2px 6px; border-radius: 3px; font-size: 0.7rem; }
        .countdown { 
            font-family: 'Courier New', monospace; 
            background-color: #1f2937; 
            padding: 2px 6px; 
            border-radius: 3px; 
            font-size: 0.75rem;
            display: inline-block;
        }
        .countdown-locked { color: #f87171; }
        .countdown-unlocked { color: #34d399; }
        .align-items-end label.form-label { color: wheat; }
        
        /* æ–°æ·»åŠ çš„æ ·å¼ */
        .nav-tabs { border-bottom: 1px solid #334155; }
        .nav-tabs .nav-link { 
            color: #94a3b8; 
            border: 1px solid transparent;
            border-radius: 0.375rem 0.375rem 0 0;
        }
        .nav-tabs .nav-link:hover { 
            color: #cbd5e1; 
            border-color: #475569;
        }
        .nav-tabs .nav-link.active { 
            color: #38bdf8; 
            background-color: #1e293b; 
            border-color: #475569 #475569 #1e293b;
        }
        .tab-content { padding-top: 1rem; }
        .address-short { 
            font-family: 'Courier New', monospace; 
            background-color: #1f2937; 
            padding: 2px 6px; 
            border-radius: 3px; 
            font-size: 0.8rem;
        }
        .total-stats-card { border-left: 4px solid #3b82f6; }
        
        /* æ–°å¢ï¼šè¶…ç´§å‡‘è´¨æŠ¼è®°å½•å¡ç‰‡æ ·å¼ */
        .stake-card-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); /* ç¼©å°æœ€å°å®½åº¦ */
            gap: 12px; /* ç¼©å°é—´è· */
            margin-top: 15px;
        }
        
        .stake-card {
            background: linear-gradient(145deg, #0d9488, #134e4a);
            border-radius: 8px; /* ç¼©å°åœ†è§’ */
            padding: 12px; /* ç¼©å°å†…è¾¹è· */
            position: relative;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .stake-card:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .stake-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 6px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .stake-card-id {
            font-size: 0.9rem; /* è¿›ä¸€æ­¥ç¼©å°å­—ä½“ */
            font-weight: bold;
            color: #fff;
        }
        
        .stake-card-status {
            font-size: 0.7rem; /* è¿›ä¸€æ­¥ç¼©å°å­—ä½“ */
            padding: 2px 8px;
            border-radius: 15px;
            font-weight: 600;
        }
        
        .status-locked {
            background-color: rgba(239, 68, 68, 0.2);
            color: #f87171;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        
        .status-unlocked {
            background-color: rgba(34, 197, 94, 0.2);
            color: #34d399;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }
        
        .status-completed {
            background-color: rgba(156, 163, 175, 0.2);
            color: #9ca3af;
            border: 1px solid rgba(156, 163, 175, 0.3);
        }
        
        .stake-card-info {
            margin-bottom: 10px;
        }
        
        .stake-amount {
            font-size: 1rem; /* è¿›ä¸€æ­¥ç¼©å°å­—ä½“ */
            font-weight: bold;
            color: #fff;
            margin-bottom: 4px;
        }
        
        .stake-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }
        
        .stake-duration {
            color: #94a3b8;
            font-size: 0.8rem; /* è¿›ä¸€æ­¥ç¼©å°å­—ä½“ */
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .stake-time {
            color: #94a3b8;
            font-size: 0.7rem; /* è¿›ä¸€æ­¥ç¼©å°å­—ä½“ */
        }
        
        .stake-progress {
            margin: 10px 0;
        }
        
        .stake-progress-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.75rem; /* è¿›ä¸€æ­¥ç¼©å°å­—ä½“ */
        }
        
        .stake-remaining-time {
            color: #e2e8f0;
        }
        
        .stake-progress-percent {
            color: #38bdf8;
            font-weight: 600;
        }
        
        .stake-progress-bar {
            height: 4px; /* è¿›ä¸€æ­¥ç¼©å°è¿›åº¦æ¡é«˜åº¦ */
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
        }
        
        .stake-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
            border-radius: 2px;
            transition: width 0.5s ease;
        }
        
        .stake-card-actions {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
        }
        
        .stake-empty-state {
            grid-column: 1 / -1;
            text-align: center;
            padding: 30px 15px;
            color: #94a3b8;
            background-color: rgba(30, 41, 59, 0.5);
            border-radius: 8px;
            border: 2px dashed #475569;
        }
        
        .stake-empty-icon {
            font-size: 2rem;
            margin-bottom: 10px;
            color: #475569;
        }
        
        .stake-empty-text {
            font-size: 0.9rem;
            margin-bottom: 6px;
        }
        
        .stake-empty-subtext {
            font-size: 0.8rem;
            color: #64748b;
        }
        
        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 768px) {
            .stake-card-container {
                grid-template-columns: 1fr;
            }
        }
        
        @media (min-width: 769px) and (max-width: 1200px) {
            .stake-card-container {
                grid-template-columns: repeat(3, 1fr); /* ä¸­å±å¹•æ˜¾ç¤º3åˆ— */
            }
        }
        
        @media (min-width: 1201px) {
            .stake-card-container {
                grid-template-columns: repeat(4, 1fr); /* å¤§å±å¹•æ˜¾ç¤º4åˆ— */
            }
        }
        
        /* ä¿®æ”¹è´¨æŠ¼æŒ‰é’®æ ·å¼ */
        .staking-btn-group .btn {
            position: relative;
            overflow: hidden;
            font-size: 0.85rem; /* ç¼©å°æŒ‰é’®å­—ä½“ */
            padding: 6px 10px;
        }
        
        .staking-btn-group .btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 4px;
            height: 4px;
            background: rgba(255, 255, 255, 0.5);
            opacity: 0;
            border-radius: 100%;
            transform: scale(1, 1) translate(-50%);
            transform-origin: 50% 50%;
        }
        
        .staking-btn-group .btn:focus:not(:active)::after {
            animation: ripple 1s ease-out;
        }
        
        @keyframes ripple {
            0% {
                transform: scale(0, 0);
                opacity: 0.5;
            }
            100% {
                transform: scale(20, 20);
                opacity: 0;
            }
        }
        
        /* åŠ è½½åŠ¨ç”» */
        .loading-spinner {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* ç¼©å°æ•´ä½“å­—ä½“ */
        .card-title {
            font-size: 1rem;
        }
        
        .stat-value {
            font-size: 1rem;
        }
        
        .stat-label {
            font-size: 0.75rem;
        }
        
        .warning-box {
            font-size: 0.8rem;
            padding: 10px;
        }
        
        .warning-box h5 {
            font-size: 0.9rem;
        }
        
        .form-label {
            font-size: 0.85rem;
        }
        
        .nav-link {
            font-size: 0.85rem;
        }
        
        .btn-sm {
            font-size: 0.75rem;
            padding: 0.15rem 0.4rem;
        }
        
        /* è°ƒæ•´è¡¨æ ¼å­—ä½“ */
        .table {
            font-size: 0.85rem;
        }
        
        .table thead th {
            font-size: 0.75rem;
        }
        
        /* è°ƒæ•´å®¹å™¨å†…è¾¹è· */
        .container.py-5 {
            padding-top: 1.5rem !important;
            padding-bottom: 1.5rem !important;
        }
        
        .card-body {
            padding: 1rem;
        }
        
        .card.p-3 {
            padding: 0.75rem !important;
        }
        
        /* ç­›é€‰çŠ¶æ€æ ‡ç­¾ */
        .status-filter {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .status-filter-btn {
            font-size: 0.8rem;
            padding: 4px 12px;
            border-radius: 20px;
            border: 1px solid #475569;
            background-color: #1e293b;
            color: #94a3b8;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .status-filter-btn:hover {
            border-color: #3b82f6;
            color: #3b82f6;
        }
        
        .status-filter-btn.active {
            background-color: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
    </style>
</head>
<body>

<div class="container py-5">
    <!-- ç‰¹åˆ«è¯´æ˜åŒºåŸŸ -->
    <div class="warning-box">
        <h5 class="text-danger fw-bold">âš ï¸ ç‰¹åˆ«è¯´æ˜</h5>
        <ol class="mb-0">
            <li>1å¤©æ—¥åŒ–0.5%ï¼Œ15å¤©æ—¥åŒ–0.8%ï¼Œ30å¤©æ—¥åŒ–1.3%ã€‚</li>
            <li>è¦å´©ç›˜å‰2å¤©ä»¥ä¸Šï¼Œé¡µé¢ä¼šå…³é—­è´¨æŠ¼åŠŸèƒ½ï¼Œå¹¶æç¤ºè§£æŠ¼ã€‚</li>
            <li>æç¤ºå´©ç›˜å¯èƒ½ä¸€å‘¨ä»¥ä¸Šæ‰ä¼šå´©ç›˜ï¼Œä½†æ˜¯åˆ«èµšæœ€åä¸€åˆ†é’±ã€‚</li>
            <li>è¯·ç”¨ä¸€ä¸ªæ–°çš„å¹²å‡€é’±åŒ…æ¥å‚ä¸ã€‚</li>
        </ol>
    </div>

    <!-- é’±åŒ…è¿æ¥ -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="fw-bold">drp Staking</h3>
        <button id="connectBtn" class="btn btn-primary" onclick="connectWallet()">è¿æ¥é’±åŒ…</button>
    </div>

    <!-- æ•°æ®ç»Ÿè®¡é¢æ¿ -->
    <div class="row mb-4 text-center g-2">
        <div class="col-6 col-md-3">
            <div class="card p-3 h-100">
                <div class="stat-label">æˆ‘çš„ USDT ä½™é¢</div>
                <div class="stat-value" id="myBalance">0.0000</div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card p-3 h-100">
                <div class="stat-label">å¾…æç°ä½™é¢ (åˆçº¦å†…)</div>
                <div class="stat-value" id="stakedBalance">0.0000</div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card p-3 h-100">
                <div class="stat-label">å¯æç° USDT (æ± å­)</div>
                <div class="stat-value" id="poolBalance">0.0000</div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card p-3 h-100 total-stats-card">
                <div class="stat-label">åˆçº¦æ€»è´¨æŠ¼</div>
                <div class="stat-value" id="totalStaked">0.0000</div>
            </div>
        </div>
    </div>

    <!-- è´¨æŠ¼æ“ä½œåŒºåŸŸ -->
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title mb-3">å‚ä¸è´¨æŠ¼</h5>
            <div class="row g-3 align-items-end">
                <div class="col-md-6">
                    <label class="form-label">è´¨æŠ¼é‡‘é¢ (USDT)</label>
                    <input type="number" class="form-control" id="stakeAmount" value="1000" placeholder="è¾“å…¥é‡‘é¢">
                </div>
                <div class="col-md-6">
                    <label class="form-label d-block">é€‰æ‹©è´¨æŠ¼å‘¨æœŸ</label>
                    <div class="staking-btn-group">
                        <button class="btn btn-success" id="stake1DayBtn">1å¤©</button>
                        <button class="btn btn-success" id="stake15DaysBtn">15å¤©</button>
                        <button class="btn btn-success" id="stake30DaysBtn">30å¤©</button>
                    </div>
                </div>
            </div>
            <div class="mt-2 small text-white">
                * æ³¨æ„ï¼š1å¤©æ—¥åŒ–0.5%ï¼Œ15å¤©æ—¥åŒ–0.8%ï¼Œ30å¤©æ—¥åŒ–1.3%
            </div>
        </div>
    </div>

    <!-- è´¨æŠ¼è®°å½•åŒºåŸŸï¼ˆé€‰é¡¹å¡ï¼‰ -->
    <div class="card">
        <div class="card-body">
            <!-- é€‰é¡¹å¡å¯¼èˆª -->
            <ul class="nav nav-tabs" id="stakeTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="my-stake-tab" data-bs-toggle="tab" data-bs-target="#my-stake" type="button" role="tab" aria-controls="my-stake" aria-selected="true">æˆ‘çš„è´¨æŠ¼è®°å½• (è´¨æŠ¼ä¸­)</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="all-stake-tab" data-bs-toggle="tab" data-bs-target="#all-stake" type="button" role="tab" aria-controls="all-stake" aria-selected="false">åˆçº¦æ€»è´¨æŠ¼è®°å½• (å·²èµå›)</button>
                </li>
            </ul>
            
            <!-- é€‰é¡¹å¡å†…å®¹ -->
            <div class="tab-content" id="stakeTabContent">
                <!-- æˆ‘çš„è´¨æŠ¼è®°å½•ï¼ˆå¡ç‰‡å¼ï¼‰- åªæ˜¾ç¤ºè´¨æŠ¼ä¸­ -->
                <div class="tab-pane fade show active" id="my-stake" role="tabpanel" aria-labelledby="my-stake-tab">
                    <div class="d-flex justify-content-between align-items-center mb-3 mt-3">
                        <h5 class="card-title mb-0">æˆ‘çš„è´¨æŠ¼è®°å½• (è´¨æŠ¼ä¸­)</h5>
                        <div>
                            <button class="btn btn-sm btn-outline-light" onclick="refreshData()">åˆ·æ–°æ•°æ®</button>
                        </div>
                    </div>
                    
                    <!-- çŠ¶æ€ç­›é€‰ -->
                    <div class="status-filter">
                        <button class="status-filter-btn active" onclick="filterMyStakes('active')">è´¨æŠ¼ä¸­</button>
                        <button class="status-filter-btn" onclick="filterMyStakes('completed')">å·²èµå›</button>
                        <button class="status-filter-btn" onclick="filterMyStakes('all')">å…¨éƒ¨è®°å½•</button>
                    </div>
                    
                    <!-- å¡ç‰‡å¼å¸ƒå±€å®¹å™¨ -->
                    <div id="stakeCardsContainer" class="stake-card-container">
                        <div class="stake-empty-state">
                            <div class="stake-empty-icon">ğŸ“Š</div>
                            <div class="stake-empty-text">æš‚æ— è´¨æŠ¼è®°å½•</div>
                            <div class="stake-empty-subtext">è¿æ¥é’±åŒ…åï¼Œæ‚¨çš„è´¨æŠ¼è®°å½•å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</div>
                        </div>
                    </div>
                </div>
                
                <!-- åˆçº¦æ€»è´¨æŠ¼è®°å½• - åªæ˜¾ç¤ºå·²èµå› -->
                <div class="tab-pane fade" id="all-stake" role="tabpanel" aria-labelledby="all-stake-tab">
                    <div class="d-flex justify-content-between align-items-center mb-3 mt-3">
                        <h5 class="card-title mb-0">åˆçº¦æ€»è´¨æŠ¼è®°å½• (å·²èµå›)</h5>
                        <div>
                            <button class="btn btn-sm btn-outline-light" onclick="refreshAllStakeData()">åˆ·æ–°æ€»è´¨æŠ¼</button>
                        </div>
                    </div>
                    
                    <!-- çŠ¶æ€ç­›é€‰ -->
                    <div class="status-filter">
                        <button class="status-filter-btn" onclick="filterAllStakes('completed')">å·²èµå›</button>
                        <button class="status-filter-btn" onclick="filterAllStakes('active')">è´¨æŠ¼ä¸­</button>
                        <button class="status-filter-btn" onclick="filterAllStakes('all')">å…¨éƒ¨è®°å½•</button>
                    </div>
                    
                    <!-- æ€»è´¨æŠ¼ç»Ÿè®¡ -->
                    <div class="row mb-4 text-center g-2">
                        <div class="col-6 col-md-3">
                            <div class="card p-3 h-100">
                                <div class="stat-label">æ€»è´¨æŠ¼ç”¨æˆ·æ•°</div>
                                <div class="stat-value" id="totalUsers">0</div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="card p-3 h-100">
                                <div class="stat-label">å·²èµå›æ•°é‡</div>
                                <div class="stat-value" id="completedStakes">0</div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="card p-3 h-100">
                                <div class="stat-label">å¹³å‡è´¨æŠ¼é‡‘é¢</div>
                                <div class="stat-value" id="avgStakeAmount">0.0000</div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="card p-3 h-100">
                                <div class="stat-label">æ€»è´¨æŠ¼æ¬¡æ•°</div>
                                <div class="stat-value" id="totalStakeCount">0</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- æ€»è´¨æŠ¼åˆ—è¡¨ -->
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>åºå·</th>
                                    <th>ç”¨æˆ·åœ°å€</th>
                                    <th>é‡‘é¢ (USDT)</th>
                                    <th>è´¨æŠ¼å‘¨æœŸ</th>
                                    <th>è´¨æŠ¼æ—¶é—´</th>
                                    <th>çŠ¶æ€</th>
                                </tr>
                            </thead>
                            <tbody id="allStakeListBody">
                                <tr><td colspan="6" class="text-center">ç‚¹å‡»"åˆ·æ–°æ€»è´¨æŠ¼"æŸ¥çœ‹åˆçº¦æ€»è´¨æŠ¼è®°å½•</td></tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- åˆ†é¡µæ§ä»¶ -->
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <div class="text-white small">
                            æ˜¾ç¤º <span id="currentPage">1</span> / <span id="totalPages">1</span> é¡µ
                        </div>
                        <div>
                            <button class="btn btn-sm btn-outline-light" onclick="prevPage()" id="prevPageBtn" disabled>ä¸Šä¸€é¡µ</button>
                            <button class="btn btn-sm btn-outline-light ms-2" onclick="nextPage()" id="nextPageBtn" disabled>ä¸‹ä¸€é¡µ</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- å¼•å…¥ Bootstrap JS ç”¨äºé€‰é¡¹å¡åŠŸèƒ½ -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // ================= é…ç½®åŒºåŸŸ =================
    const CONFIG = {
        STAKING: "0x7E1882b471F627Ba75935BCb12105545Eb8b4227",
        USDT: "0x55d398326f99059fF775485246999027B3197955",
        PAIR: "0xAB71C14094575C6ec8f2e61C708D5f4A3c3d5ca0"
    };
    
    // è´¨æŠ¼å‘¨æœŸé…ç½® (ç§’)
    const STAKE_DURATIONS = {
        0: 86400,      // 1å¤©
        1: 1296000,    // 15å¤© (15 * 86400)
        2: 2592000     // 30å¤© (30 * 86400)
    };
    
    const STAKE_DURATION_LABELS = {
        0: "1å¤©",
        1: "15å¤©", 
        2: "30å¤©"
    };
    // ===========================================

    // ABIs
    const ABI_ERC20 = [
        "function balanceOf(address owner) view returns (uint256)",
        "function decimals() view returns (uint8)",
        "function approve(address spender, uint256 amount) returns (bool)",
        "function allowance(address owner, address spender) view returns (uint256)"
    ];

    const ABI_STAKING = [
        "function totalSupply() view returns (uint256)",
        "function balanceOf(address account) view returns (uint256)",
        "function stake(uint160 _amount, uint256 amountOutMin, uint8 _stakeIndex)",
        "function unstake(uint256 index)",
        "function stakeCount(address user) view returns (uint256)",
        'function maxStakeAmount() view returns (uint256)',
        "function userStakeRecord(address user, uint256 index) view returns (uint40 stakeTime, uint160 amount, bool status, uint8 stakeIndex)"
    ];

    // å…¨å±€å˜é‡
    let provider, signer, userAddress;
    let stakingContract, usdtContract;
    let countdownTimers = {};
    
    // æ€»è´¨æŠ¼è®°å½•ç›¸å…³å˜é‡
    let allStakeData = [];  // å­˜å‚¨æ‰€æœ‰è´¨æŠ¼è®°å½•
    let filteredAllStakeData = []; // å­˜å‚¨ç­›é€‰åçš„æ€»è´¨æŠ¼è®°å½•
    let currentPage = 1;    // å½“å‰é¡µç 
    let totalPages = 1;     // æ€»é¡µæ•°
    
    // æ€»è´¨æŠ¼è®°å½•ç›¸å…³é…ç½®
    const TOTAL_STAKE_PAGE_SIZE = 10;  // æ¯é¡µæ˜¾ç¤ºè®°å½•æ•°
    const SAMPLE_USER_ADDRESSES = [  // ç¤ºä¾‹ç”¨æˆ·åœ°å€åˆ—è¡¨
        "0x1234567890123456789012345678901234567890",
        "0x2345678901234567890123456789012345678901",
        "0x3456789012345678901234567890123456789012",
        "0x4567890123456789012345678901234567890123",
        "0x5678901234567890123456789012345678901234"
    ];
    
    // ç­›é€‰çŠ¶æ€
    let myStakeFilter = 'active'; // æˆ‘çš„è´¨æŠ¼è®°å½•ç­›é€‰ï¼šactive=è´¨æŠ¼ä¸­, completed=å·²èµå›, all=å…¨éƒ¨
    let allStakeFilter = 'completed'; // æ€»è´¨æŠ¼è®°å½•ç­›é€‰ï¼šactive=è´¨æŠ¼ä¸­, completed=å·²èµå›, all=å…¨éƒ¨

    // å·¥å…·ï¼šæ ¼å¼åŒ–é‡‘é¢ä¸º4ä½å°æ•°
    function formatAmount(wei) {
        const val = ethers.formatUnits(wei, 18);
        return parseFloat(val).toFixed(0);
    }

    // æ ¼å¼åŒ–é‡‘é¢ä¸º2ä½å°æ•°
    function formatAmountTwoDecimals(wei) {
        const val = ethers.formatUnits(wei, 18);
        return parseFloat(val).toFixed(2);
    }

    // æ ¼å¼åŒ–æ—¶é—´ï¼šå°†ç§’è½¬æ¢ä¸ºå¤©ã€å°æ—¶ã€åˆ†é’Ÿ
    function formatTimeRemaining(seconds) {
        if (seconds <= 0) return "0ç§’";
        
        const days = Math.floor(seconds / 86400);
        const hours = Math.floor((seconds % 86400) / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const secs = seconds % 60;
        
        let result = "";
        if (days > 0) result += `${days}å¤©`;
        if (hours > 0) result += `${hours}å°æ—¶`;
        if (minutes > 0 && days === 0) result += `${minutes}åˆ†`;
        if (secs > 0 && days === 0 && hours === 0) result += `${secs}ç§’`;
        
        return result || "0ç§’";
    }
    
    // æ ¼å¼åŒ–æ—¶é—´ï¼šå°†ç§’è½¬æ¢ä¸ºå°æ—¶ã€åˆ†é’Ÿã€ç§’ï¼ˆç”¨äºè¿›åº¦æ¡æ˜¾ç¤ºï¼‰
    function formatTimeShort(seconds) {
        if (seconds <= 0) return "0s";
        
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const secs = seconds % 60;
        
        let result = "";
        if (hours > 0) result += `${hours}h`;
        if (minutes > 0) result += `${minutes}m`;
        if (secs > 0 && hours === 0) result += `${secs}s`;
        
        return result || "0s";
    }
    
    // æ ¼å¼åŒ–è´¨æŠ¼æ—¶é—´ï¼šæ˜¾ç¤ºæ›´ç®€æ´çš„æ—¶é—´æ ¼å¼
    function formatStakeTime(timestamp) {
        const date = new Date(timestamp * 1000);
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const day = date.getDate().toString().padStart(2, '0');
        const hour = date.getHours().toString().padStart(2, '0');
        const minute = date.getMinutes().toString().padStart(2, '0');
        
        return `${month}/${day} ${hour}:${minute}`;
    }
    
    // è®¡ç®—è¿›åº¦æ¡ç™¾åˆ†æ¯”
    function calculateProgress(stakeTime, durationSeconds) {
        const now = Math.floor(Date.now() / 1000);
        const elapsedTime = now - stakeTime;
        
        if (elapsedTime >= durationSeconds) {
            return 100;
        }
        
        return Math.min(100, Math.floor((elapsedTime / durationSeconds) * 100));
    }
    
    // ç¼©çŸ­åœ°å€æ˜¾ç¤º
    function shortenAddress(address) {
        if (!address) return '';
        return address.substring(0, 6) + '...' + address.substring(address.length - 4);
    }
    
    // æ¿€æ´»ç­›é€‰æŒ‰é’®
    function activateFilterButton(containerClass, activeIndex) {
        const buttons = document.querySelectorAll(`${containerClass} .status-filter-btn`);
        buttons.forEach((btn, index) => {
            btn.classList.remove('active');
            if (index === activeIndex) {
                btn.classList.add('active');
            }
        });
    }

    // ç­›é€‰æˆ‘çš„è´¨æŠ¼è®°å½•
    function filterMyStakes(filterType) {
        myStakeFilter = filterType;
        renderStakeCards();
        
        // æ¿€æ´»å¯¹åº”çš„ç­›é€‰æŒ‰é’®
        let activeIndex = 0;
        if (filterType === 'completed') activeIndex = 1;
        else if (filterType === 'all') activeIndex = 2;
        activateFilterButton('#my-stake .status-filter', activeIndex);
    }
    
    // ç­›é€‰æ€»è´¨æŠ¼è®°å½•
    function filterAllStakes(filterType) {
        allStakeFilter = filterType;
        applyAllStakeFilter();
        renderAllStakeList();
        updatePagination();
        
        // æ¿€æ´»å¯¹åº”çš„ç­›é€‰æŒ‰é’®
        let activeIndex = 0;
        if (filterType === 'active') activeIndex = 1;
        else if (filterType === 'all') activeIndex = 2;
        activateFilterButton('#all-stake .status-filter', activeIndex);
    }
    
    // åº”ç”¨æ€»è´¨æŠ¼è®°å½•ç­›é€‰
    function applyAllStakeFilter() {
        if (allStakeFilter === 'all') {
            filteredAllStakeData = [...allStakeData];
        } else if (allStakeFilter === 'active') {
            filteredAllStakeData = allStakeData.filter(record => !record.isActive);
        } else { // completed
            filteredAllStakeData = allStakeData.filter(record => record.isActive);
        }
    }

    // 1. è¿æ¥é’±åŒ…
    async function connectWallet() {
        if (!window.ethereum) {
            alert("è¯·å®‰è£… MetaMask!");
            return;
        }
        try {
            provider = new ethers.BrowserProvider(window.ethereum);
            signer = await provider.getSigner();
            userAddress = await signer.getAddress();
            
            // æ›´æ–°UI
            document.getElementById('connectBtn').innerText = userAddress.slice(0, 6) + "..." + userAddress.slice(-4);
            document.getElementById('connectBtn').classList.replace('btn-primary', 'btn-success');

            // åˆå§‹åŒ–åˆçº¦
            stakingContract = new ethers.Contract(CONFIG.STAKING, ABI_STAKING, signer);
            usdtContract = new ethers.Contract(CONFIG.USDT, ABI_ERC20, signer);

            // åŠ è½½æ•°æ®
            await refreshData();
            
            // åˆå§‹åŒ–è´¨æŠ¼æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            initStakeButtons();
        } catch (error) {
            console.error("è¿æ¥å¤±è´¥:", error);
            alert("è¿æ¥é’±åŒ…å¤±è´¥");
        }
    }

    // 2. åˆ·æ–°æ‰€æœ‰æ•°æ®
    async function refreshData() {
        if (!userAddress) return;
        const btn = document.querySelector('button[onclick="refreshData()"]');
        const originalText = btn.innerText;
        btn.innerText = "åŠ è½½ä¸­...";
        
        try {
            // 2.1 è·å–æˆ‘çš„ USDT ä½™é¢
            const myBal = await usdtContract.balanceOf(userAddress);
            document.getElementById('myBalance').innerText = formatAmount(myBal);

            // 2.2 è·å–å¾…æç°ä½™é¢ (åˆçº¦å†…çš„ balanceOf)
            const stakedBal = await stakingContract.balanceOf(userAddress);
            document.getElementById('stakedBalance').innerText = formatAmount(stakedBal);

            // 2.3 è·å–å¯æç°ä½™é¢ (æ± å­é‡Œçš„ USDT)
            const poolBal = await usdtContract.balanceOf(CONFIG.PAIR);
            document.getElementById('poolBalance').innerText = formatAmount(poolBal);
            
            // 2.4 è·å–åˆçº¦æ€»è´¨æŠ¼é‡‘é¢
            const totalStaked = await stakingContract.totalSupply();
            document.getElementById('totalStaked').innerText = formatAmount(totalStaked);

            // 2.5 è·å–è´¨æŠ¼åˆ—è¡¨
            await renderStakeCards();
            btn.innerText = "åˆ·æ–°";
        } catch (error) {
            console.error("æ•°æ®åŠ è½½é”™è¯¯:", error);
        } finally {
            btn.innerText = originalText;
        }
    }

    // 3. æ¸²æŸ“è´¨æŠ¼å¡ç‰‡ï¼ˆè¶…ç´§å‡‘ç‰ˆï¼‰- æ ¹æ®ç­›é€‰æ¡ä»¶æ˜¾ç¤º
    async function renderStakeCards() {
        const container = document.getElementById('stakeCardsContainer');
        container.innerHTML = '<div class="text-center py-3"><div class="loading-spinner"></div> åŠ è½½ä¸­...</div>';

        try {
            const count = await stakingContract.stakeCount(userAddress);
            
            if (Number(count) === 0) {
                container.innerHTML = `
                    <div class="stake-empty-state">
                        <div class="stake-empty-icon">ğŸ“Š</div>
                        <div class="stake-empty-text">æš‚æ— è´¨æŠ¼è®°å½•</div>
                        <div class="stake-empty-subtext">å¼€å§‹æ‚¨çš„ç¬¬ä¸€æ¬¡è´¨æŠ¼å§ï¼</div>
                    </div>
                `;
                return;
            }

            let html = '';
            const now = Math.floor(Date.now() / 1000);
            let activeCount = 0; // è´¨æŠ¼ä¸­æ•°é‡
            let completedCount = 0; // å·²èµå›æ•°é‡
            let displayedCount = 0; // æ˜¾ç¤ºæ•°é‡

            // æ¸…ç©ºæ—§çš„å€’è®¡æ—¶å®šæ—¶å™¨
            Object.keys(countdownTimers).forEach(id => {
                clearInterval(countdownTimers[id]);
                delete countdownTimers[id];
            });

            // å€’åºæ˜¾ç¤ºï¼ˆæœ€æ–°çš„åœ¨å‰é¢ï¼‰
            for (let i = Number(count) - 1; i >= 0; i--) {
                const record = await stakingContract.userStakeRecord(userAddress, i);
                
                const amount = parseFloat(ethers.formatUnits(record[1], 18));
                const stakeTime = Number(record[0]);
                const stakeTimeStr = formatStakeTime(stakeTime);
                const isActive = record[2]; 
                const stakeIndex = Number(record[3]);
                const durationSeconds = STAKE_DURATIONS[stakeIndex] || 86400;
                const durationLabel = STAKE_DURATION_LABELS[stakeIndex] || "æœªçŸ¥";
                
                // è®¡ç®—è§£é”æ—¶é—´
                const unlockTime = stakeTime + durationSeconds;
                const timeRemaining = unlockTime - now;
                
                // è®¡ç®—æ˜¯å¦é”å®š
                const isLocked = timeRemaining > 0 && !isActive;
                const isUnlocked = timeRemaining <= 0 && !isActive;
                
                // è®¡ç®—è¿›åº¦æ¡ç™¾åˆ†æ¯”
                const progressPercent = calculateProgress(stakeTime, durationSeconds);
                
                // ç¡®å®šçŠ¶æ€
                let statusText = '';
                let statusClass = '';
                
                if (isActive) {
                    statusText = 'å·²æå–';
                    statusClass = 'status-completed';
                    completedCount++;
                } else if (isLocked) {
                    statusText = 'é”å®šä¸­';
                    statusClass = 'status-locked';
                    activeCount++;
                } else if (isUnlocked) {
                    statusText = 'å¯èµå›';
                    statusClass = 'status-unlocked';
                    activeCount++;
                } else {
                    statusText = 'æœªçŸ¥';
                    statusClass = 'status-completed';
                }
                
                // æ ¹æ®ç­›é€‰æ¡ä»¶å†³å®šæ˜¯å¦æ˜¾ç¤º
                let shouldDisplay = false;
                if (myStakeFilter === 'all') {
                    shouldDisplay = true;
                } else if (myStakeFilter === 'active') {
                    shouldDisplay = !isActive; // æ˜¾ç¤ºæœªæå–çš„ï¼ˆè´¨æŠ¼ä¸­ï¼‰
                } else if (myStakeFilter === 'completed') {
                    shouldDisplay = isActive; // æ˜¾ç¤ºå·²æå–çš„
                }
                
                if (!shouldDisplay) {
                    continue; // è·³è¿‡ä¸æ˜¾ç¤º
                }
                
                displayedCount++;
                
                // è®¡ç®—å‰©ä½™æ—¶é—´
                const remainingTimeStr = isLocked ? formatTimeShort(timeRemaining) : 
                                          isUnlocked ? 'å·²è§£é”' : 'å·²å®Œæˆ';

                // åˆ›å»ºè¶…ç´§å‡‘ç‰ˆå¡ç‰‡HTML
                html += `
                    <div class="stake-card" id="stake-card-${i}">
                        <div class="stake-card-header">
                            <div class="stake-card-id">No.${i + 1}</div>
                            <div class="stake-card-status ${statusClass}">${statusText}</div>
                        </div>
                        
                        <div class="stake-card-info">
                            <div class="stake-amount">${amount.toFixed(0)} USDT</div>
                            <div class="stake-meta">
                                <div class="stake-duration">
                                    <span class="badge-duration">${durationLabel}</span>
                                </div>
                                <div class="stake-time">${stakeTimeStr}</div>
                            </div>
                        </div>
                        
                        <div class="stake-progress">
                            <div class="stake-progress-info">
                                <div class="stake-remaining-time">å‰©ä½™: ${remainingTimeStr}</div>
                                <div class="stake-progress-percent">${progressPercent}%</div>
                            </div>
                            <div class="stake-progress-bar">
                                <div class="stake-progress-fill" id="progress-${i}" style="width: ${progressPercent}%"></div>
                            </div>
                        </div>
                        
                        <div class="stake-card-actions">
                            ${isUnlocked ? 
                                `<button class="btn btn-warning btn-sm" id="unstake-btn-${i}" onclick="handleUnstake(${i})">èµå›</button>` : 
                                `<button class="btn btn-secondary btn-sm" disabled>${isActive ? 'å·²èµå›' : 'ç­‰å¾…è§£é”'}</button>`
                            }
                        </div>
                    </div>
                `;
                
                // å¦‚æœé”å®šä¸­ï¼Œå¯åŠ¨å€’è®¡æ—¶
                if (isLocked) {
                    startProgressCountdown(i, timeRemaining, durationSeconds);
                }
            }

            if (displayedCount === 0) {
                let emptyText = '';
                if (myStakeFilter === 'active') {
                    emptyText = 'æš‚æ— è´¨æŠ¼ä¸­çš„è®°å½•';
                } else if (myStakeFilter === 'completed') {
                    emptyText = 'æš‚æ— å·²èµå›çš„è®°å½•';
                } else {
                    emptyText = 'æš‚æ— è´¨æŠ¼è®°å½•';
                }
                
                container.innerHTML = `
                    <div class="stake-empty-state">
                        <div class="stake-empty-icon">ğŸ“Š</div>
                        <div class="stake-empty-text">${emptyText}</div>
                        <div class="stake-empty-subtext">${myStakeFilter === 'active' ? 'å¼€å§‹è´¨æŠ¼ä»¥åˆ›å»ºæ–°çš„è´¨æŠ¼è®°å½•' : 'å¼€å§‹æ‚¨çš„ç¬¬ä¸€æ¬¡è´¨æŠ¼å§ï¼'}</div>
                    </div>
                `;
            } else {
                container.innerHTML = html;
            }
        } catch (error) {
            console.error("å¡ç‰‡åŠ è½½å¤±è´¥:", error);
            container.innerHTML = `
                <div class="stake-empty-state">
                    <div class="stake-empty-icon">âŒ</div>
                    <div class="stake-empty-text">åŠ è½½å¤±è´¥</div>
                    <div class="stake-empty-subtext">è¯·åˆ·æ–°é¡µé¢é‡è¯•</div>
                </div>
            `;
        }
    }

    // å¯åŠ¨è¿›åº¦æ¡å€’è®¡æ—¶
    function startProgressCountdown(id, initialSeconds, totalSeconds) {
        let remaining = initialSeconds;
        const progressElement = document.getElementById(`progress-${id}`);
        const timeElement = document.querySelector(`#stake-card-${id} .stake-remaining-time`);
        
        if (!progressElement || !timeElement) return;
        
        const timer = setInterval(() => {
            remaining--;
            
            if (remaining <= 0) {
                clearInterval(timer);
                // åˆ·æ–°æ•´ä¸ªåˆ—è¡¨
                refreshData();
                return;
            }
            
            // æ›´æ–°å‰©ä½™æ—¶é—´æ˜¾ç¤º
            timeElement.textContent = `å‰©ä½™: ${formatTimeShort(remaining)}`;
            
            // æ›´æ–°è¿›åº¦æ¡
            const elapsedSeconds = totalSeconds - remaining;
            const progressPercent = Math.min(100, Math.floor((elapsedSeconds / totalSeconds) * 100));
            progressElement.style.width = `${progressPercent}%`;
            
            // æ›´æ–°ç™¾åˆ†æ¯”æ˜¾ç¤º
            const percentElement = document.querySelector(`#stake-card-${id} .stake-progress-percent`);
            if (percentElement) {
                percentElement.textContent = `${progressPercent}%`;
            }
            
        }, 1000);
        
        countdownTimers[id] = timer;
    }

    // 4. åˆå§‹åŒ–è´¨æŠ¼æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    function initStakeButtons() {
        const stake1DayBtn = document.getElementById('stake1DayBtn');
        const stake15DaysBtn = document.getElementById('stake15DaysBtn');
        const stake30DaysBtn = document.getElementById('stake30DaysBtn');
        
        if (stake1DayBtn) {
            stake1DayBtn.addEventListener('click', function() {
                handleStake(0, 1, this);
            });
        }
        
        if (stake15DaysBtn) {
            stake15DaysBtn.addEventListener('click', function() {
                handleStake(1, 15, this);
            });
        }
        
        if (stake30DaysBtn) {
            stake30DaysBtn.addEventListener('click', function() {
                handleStake(2, 30, this);
            });
        }
        
        // æ·»åŠ æŒ‰é’®æç¤º - ä½¿ç”¨DRPçš„æ—¥åŒ–ç‡é…ç½®
        const buttons = [stake1DayBtn, stake15DaysBtn, stake30DaysBtn];
        const durations = [1, 15, 30];
        const dailyRates = [0.5, 0.8, 1.3]; // DRPçš„æ—¥åŒ–ç‡é…ç½®
        
        buttons.forEach((btn, index) => {
            if (btn) {
                const totalProfit = (dailyRates[index] * durations[index]).toFixed(1);
                btn.setAttribute('title', `æ—¥åŒ–: ${dailyRates[index]}%, æ€»æ”¶ç›Š: ${totalProfit}%`);
            }
        });
    }

    // 5. è´¨æŠ¼é€»è¾‘
    async function handleStake(stakeIndex, durationDays, btnElement) {
        if (!userAddress) {
            alert("è¯·å…ˆè¿æ¥é’±åŒ…");
            return;
        }
        
        const amountStr = document.getElementById('stakeAmount').value;
        if (!amountStr || parseFloat(amountStr) <= 0) {
            alert("è¯·è¾“å…¥æœ‰æ•ˆçš„è´¨æŠ¼é‡‘é¢");
            return;
        }
        
        // é‡‘é¢éªŒè¯
        const amount = parseFloat(amountStr);
        if (amount < 0.1) { // æœ€å°è´¨æŠ¼é‡‘é¢æ£€æŸ¥
            alert("è´¨æŠ¼é‡‘é¢ä¸èƒ½å°äº0.1 USDT");
            return;
        }
        
        if (amount > 1000000) { // æœ€å¤§è´¨æŠ¼é‡‘é¢æ£€æŸ¥
            alert("è´¨æŠ¼é‡‘é¢ä¸èƒ½è¶…è¿‡1,000,000 USDT");
            return;
        }
        
        try {
            const amountWei = ethers.parseUnits(amountStr, 18);
            
            // è·å–æ‰€æœ‰è´¨æŠ¼æŒ‰é’®
            const buttons = document.querySelectorAll('.staking-btn-group .btn');
            const originalTexts = [];
            
            // ç¦ç”¨æ‰€æœ‰è´¨æŠ¼æŒ‰é’®å¹¶ä¿å­˜åŸå§‹æ–‡æœ¬
            buttons.forEach(btn => {
                originalTexts.push(btn.textContent);
                btn.disabled = true;
                btn.classList.add('disabled');
            });
            
            // è®¾ç½®å½“å‰æŒ‰é’®çš„æ–‡æœ¬
            const currentBtn = btnElement;
            const originalCurrentText = currentBtn.textContent;
            
            try {
                // 0. æ£€æŸ¥ç½‘ç»œ
                await checkNetwork();
                
                // 1. æ£€æŸ¥ç”¨æˆ·ä½™é¢æ˜¯å¦è¶³å¤Ÿ
                currentBtn.textContent = "æ£€æŸ¥ä½™é¢...";
                const myBal = await usdtContract.balanceOf(userAddress);
                if (myBal < amountWei) {
                    alert("USDTä½™é¢ä¸è¶³ï¼Œè¯·å…ˆå……å€¼");
                    throw new Error("ä½™é¢ä¸è¶³");
                }
                
                // 2. æ£€æŸ¥æœ€å¤§è´¨æŠ¼é™é¢
                currentBtn.textContent = "æ£€æŸ¥é™é¢...";
                try {
                    const maxStakeAmount = await stakingContract.maxStakeAmount();
                    if (maxStakeAmount !== undefined && amountWei > maxStakeAmount) {
                        alert(`è´¨æŠ¼é‡‘é¢è¶…è¿‡æœ€å¤§é™é¢ ${ethers.formatUnits(maxStakeAmount, 18)} USDT`);
                        throw new Error("è¶…è¿‡æœ€å¤§é™é¢");
                    }
                } catch (maxStakeError) {
                    console.log("maxStakeAmountå‡½æ•°å¯èƒ½ä¸å­˜åœ¨ï¼Œè·³è¿‡é™é¢æ£€æŸ¥");
                }
                
                // 3. æ£€æŸ¥å¹¶æˆæƒ USDT
                currentBtn.textContent = "æ£€æŸ¥æˆæƒ...";
                const allowance = await usdtContract.allowance(userAddress, CONFIG.STAKING);
                
                if (allowance < amountWei) {
                    currentBtn.textContent = "æ­£åœ¨æˆæƒ USDT...";
                    try {
                        const txApprove = await usdtContract.approve(CONFIG.STAKING, ethers.MaxUint256);
                        
                        console.log("æˆæƒäº¤æ˜“å“ˆå¸Œ:", txApprove.hash);
                        
                        // ç­‰å¾…æˆæƒç¡®è®¤
                        currentBtn.textContent = "ç­‰å¾…æˆæƒç¡®è®¤...";
                        const receipt = await txApprove.wait();
                        console.log("æˆæƒç¡®è®¤ï¼ŒåŒºå—:", receipt.blockNumber);
                        
                        // æˆæƒåç­‰å¾…å‡ ç§’
                        await new Promise(resolve => setTimeout(resolve, 2000));
                    } catch (approveError) {
                        console.error("æˆæƒå¤±è´¥:", approveError);
                        
                        if (approveError.code === 4001) {
                            alert("ç”¨æˆ·æ‹’ç»æˆæƒ");
                        } else if (approveError.code === -32603) {
                            alert("ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥Gasè®¾ç½®");
                        } else {
                            alert(`æˆæƒå¤±è´¥: ${approveError.reason || approveError.message || "æœªçŸ¥é”™è¯¯"}`);
                        }
                        throw approveError;
                    }
                }
                
                // 4. è®¡ç®—é¢„è®¡æ”¶ç›Š - ä½¿ç”¨DRPçš„æ—¥åŒ–ç‡é…ç½®
                const dailyRates = [0.5, 0.8, 1.3]; // DRPçš„æ—¥åŒ–ç‡é…ç½®
                const dailyRate = dailyRates[stakeIndex];
                const expectedProfit = (amount * (dailyRate / 100) * durationDays).toFixed(4);
                
                // 5. ç¡®è®¤å¯¹è¯æ¡†
                const confirmStake = confirm(
                    `ç¡®è®¤è´¨æŠ¼ ${amountStr} USDT\n` +
                    `è´¨æŠ¼å‘¨æœŸ: ${durationDays}å¤©\n` +
                    `æ—¥åŒ–åˆ©ç‡: ${dailyRate}%\n` +
                    `é¢„è®¡æ”¶ç›Š: ${expectedProfit} USDT\n` +
                    `\næ˜¯å¦ç»§ç»­ï¼Ÿ`
                );
                
                if (!confirmStake) {
                    console.log("ç”¨æˆ·å–æ¶ˆè´¨æŠ¼");
                    throw new Error("ç”¨æˆ·å–æ¶ˆ");
                }
                
                // 6. å‘èµ·è´¨æŠ¼
                currentBtn.textContent = "æ­£åœ¨è´¨æŠ¼...";
                
                try {
                    // è°ƒç”¨è´¨æŠ¼å‡½æ•°
                    const txStake = await stakingContract.stake(
                        amountWei, 
                        0, // amountOutMinè®¾ç½®ä¸º0
                        stakeIndex,
                        { gasLimit: 500000 } // å¢åŠ gasé™åˆ¶
                    );
                    
                    console.log("è´¨æŠ¼äº¤æ˜“å·²å‘é€ï¼Œå“ˆå¸Œ:", txStake.hash);
                    
                    // æ˜¾ç¤ºäº¤æ˜“å·²å‘é€
                    currentBtn.textContent = "ç­‰å¾…ç¡®è®¤...";
                    alert(`è´¨æŠ¼äº¤æ˜“å·²å‘é€ï¼Œè¯·ç­‰å¾…ç¡®è®¤\näº¤æ˜“å“ˆå¸Œ: ${txStake.hash.substring(0, 10)}...`);
                    
                    // ç­‰å¾…äº¤æ˜“ç¡®è®¤
                    const receipt = await txStake.wait();
                    console.log("è´¨æŠ¼ç¡®è®¤ï¼ŒåŒºå—:", receipt.blockNumber);
                    
                    // æ£€æŸ¥äº¤æ˜“çŠ¶æ€
                    if (receipt.status === 1) {
                        alert(`è´¨æŠ¼æˆåŠŸï¼å‘¨æœŸï¼š${durationDays}å¤©\né¢„è®¡æ”¶ç›Š: ${expectedProfit} USDT\näº¤æ˜“ç¡®è®¤ï¼ŒåŒºå—: ${receipt.blockNumber}`);
                        
                        // åˆ·æ–°æ•°æ®
                        await refreshData();
                        
                        // æ˜¾ç¤ºçŸ­æš‚çš„"æˆåŠŸ"çŠ¶æ€
                        currentBtn.textContent = "æˆåŠŸï¼";
                        currentBtn.classList.add('btn-success');
                        
                        setTimeout(() => {
                            currentBtn.textContent = originalCurrentText;
                            currentBtn.classList.remove('disabled');
                        }, 2000);
                        
                    } else {
                        throw new Error("äº¤æ˜“å¤±è´¥ï¼ŒçŠ¶æ€ä¸º0");
                    }
                    
                } catch (stakeError) {
                    console.error("è´¨æŠ¼äº¤æ˜“é”™è¯¯:", stakeError);
                    
                    if (stakeError.code === 4001) {
                        alert("ç”¨æˆ·æ‹’ç»è´¨æŠ¼äº¤æ˜“");
                    } else if (stakeError.reason) {
                        if (stakeError.reason.includes("insufficient allowance")) {
                            alert("æˆæƒä¸è¶³ï¼Œè¯·é‡æ–°æˆæƒ");
                        } else if (stakeError.reason.includes("transfer amount exceeds balance")) {
                            alert("ä½™é¢ä¸è¶³ï¼Œè¯·æ£€æŸ¥USDTä½™é¢");
                        } else if (stakeError.reason.includes("stake amount too high")) {
                            alert("è´¨æŠ¼é‡‘é¢è¶…è¿‡é™åˆ¶");
                        } else if (stakeError.reason.includes("Invalid stake index")) {
                            alert("æ— æ•ˆçš„è´¨æŠ¼å‘¨æœŸ");
                        } else {
                            alert(`è´¨æŠ¼å¤±è´¥: ${stakeError.reason}`);
                        }
                    } else if (stakeError.message?.includes("insufficient funds")) {
                        alert("Gasè´¹ç”¨ä¸è¶³ï¼Œè¯·ç¡®ä¿é’±åŒ…ä¸­æœ‰è¶³å¤Ÿçš„BNB/ETH");
                    } else {
                        alert(`è´¨æŠ¼å¤±è´¥: ${stakeError.message || "æœªçŸ¥é”™è¯¯"}`);
                    }
                    throw stakeError;
                }
                
            } catch (error) {
                console.error("è´¨æŠ¼è¿‡ç¨‹é”™è¯¯:", error);
                throw error;
            } finally {
                // æ¢å¤æ‰€æœ‰æŒ‰é’®çŠ¶æ€
                buttons.forEach((btn, index) => {
                    btn.disabled = false;
                    btn.classList.remove('disabled');
                    btn.textContent = originalTexts[index];
                });
            }
            
        } catch (error) {
            console.error("è´¨æŠ¼å¤±è´¥:", error);
            
            // é€šç”¨é”™è¯¯å¤„ç†
            if (error.code === 4001) {
                alert("ç”¨æˆ·æ‹’ç»äº†äº¤æ˜“");
            } else if (error.code === -32603) {
                alert("ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å’ŒGasè®¾ç½®");
            } else if (error.reason) {
                alert(`åˆçº¦é”™è¯¯: ${error.reason}`);
            } else if (error.message === "ç”¨æˆ·å–æ¶ˆ") {
                // ç”¨æˆ·å–æ¶ˆï¼Œä¸æ˜¾ç¤ºé”™è¯¯
            } else if (error.message) {
                alert(`é”™è¯¯: ${error.message}`);
            } else {
                alert("è´¨æŠ¼å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°è·å–è¯¦ç»†ä¿¡æ¯");
            }
        }
    }

    // 6. èµå›é€»è¾‘
    async function handleUnstake(index) {
        if (!userAddress) return;
        
        const btn = document.getElementById(`unstake-btn-${index}`);
        if(btn) {
            btn.disabled = true;
            btn.innerText = "å¤„ç†ä¸­...";
        }

        try {
            const tx = await stakingContract.unstake(index);
            console.log("Transaction sent:", tx.hash);
            
            await tx.wait();
            alert("èµå›æˆåŠŸï¼");
            refreshData();

        } catch (error) {
            console.error(error);
            if(btn) {
                btn.disabled = false;
                btn.innerText = "èµå›";
            }
            
            if(error.reason) alert("åˆçº¦é”™è¯¯: " + error.reason);
            else if(error.message.includes("User denied")) alert("ç”¨æˆ·å–æ¶ˆäº¤æ˜“");
            else alert("èµå›å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°");
        }
    }

    // 7. åˆ·æ–°æ€»è´¨æŠ¼æ•°æ®
    async function refreshAllStakeData() {
        if (!stakingContract) {
            alert("è¯·å…ˆè¿æ¥é’±åŒ…");
            return;
        }
        
        const btn = document.querySelector('button[onclick="refreshAllStakeData()"]');
        const originalText = btn.innerText;
        btn.disabled = true;
        btn.innerText = "åŠ è½½ä¸­...";
        
        try {
            // æ¸…ç©ºç°æœ‰æ•°æ®
            allStakeData = [];
            
            // è·å–åˆçº¦æ€»è´¨æŠ¼é‡‘é¢
            const totalStaked = await stakingContract.totalSupply();
            document.getElementById('totalStaked').innerText = formatAmount(totalStaked);
            
            // æ¨¡æ‹Ÿè·å–ç”¨æˆ·è´¨æŠ¼è®°å½•
            // æ³¨æ„ï¼šå®é™…åº”ç”¨ä¸­åº”è¯¥ä»äº‹ä»¶æ—¥å¿—ä¸­è·å–æ‰€æœ‰ç”¨æˆ·çš„è´¨æŠ¼è®°å½•
            // è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ç¤ºä¾‹æ•°æ®å’Œå½“å‰ç”¨æˆ·çš„æ•°æ®æ¥æ¨¡æ‹Ÿ
            
            // 1. å…ˆè·å–å½“å‰ç”¨æˆ·çš„è´¨æŠ¼è®°å½•
            await addUserStakeRecords(userAddress);
            
            // 2. æ·»åŠ ç¤ºä¾‹ç”¨æˆ·çš„è´¨æŠ¼è®°å½•
            for (const address of SAMPLE_USER_ADDRESSES) {
                await addUserStakeRecords(address);
            }
            
            // 3. è®¡ç®—ç»Ÿè®¡ä¿¡æ¯
            calculateTotalStats();
            
            // 4. åº”ç”¨ç­›é€‰
            applyAllStakeFilter();
            
            // 5. æ¸²æŸ“æ€»è´¨æŠ¼åˆ—è¡¨
            renderAllStakeList();
            
            // 6. æ›´æ–°åˆ†é¡µæ§ä»¶
            updatePagination();
            
            btn.innerText = "åˆ·æ–°æˆåŠŸ";
            setTimeout(() => {
                btn.innerText = originalText;
                btn.disabled = false;
            }, 1500);
            
        } catch (error) {
            console.error("è·å–æ€»è´¨æŠ¼æ•°æ®å¤±è´¥:", error);
            btn.innerText = "åˆ·æ–°å¤±è´¥";
            btn.disabled = false;
        }
    }
    
    // æ·»åŠ ç”¨æˆ·è´¨æŠ¼è®°å½•
    async function addUserStakeRecords(address) {
        try {
            // è·å–ç”¨æˆ·çš„è´¨æŠ¼æ•°é‡
            const stakeCount = await stakingContract.stakeCount(address);
            
            // éå†æ¯ä¸ªè´¨æŠ¼è®°å½•
            for (let i = 0; i < Number(stakeCount); i++) {
                try {
                    const record = await stakingContract.userStakeRecord(address, i);
                    
                    const stakeData = {
                        userAddress: address,
                        stakeId: i,
                        amount: record[1],
                        stakeTime: Number(record[0]),
                        isActive: record[2],
                        stakeIndex: Number(record[3])
                    };
                    
                    allStakeData.push(stakeData);
                } catch (err) {
                    console.error(`è·å–ç”¨æˆ· ${address} çš„ç¬¬ ${i} æ¡è®°å½•å¤±è´¥:`, err);
                }
            }
        } catch (error) {
            console.error(`è·å–ç”¨æˆ· ${address} çš„è´¨æŠ¼è®°å½•å¤±è´¥:`, error);
        }
    }
    
    // è®¡ç®—æ€»è´¨æŠ¼ç»Ÿè®¡ä¿¡æ¯
    function calculateTotalStats() {
        if (allStakeData.length === 0) {
            document.getElementById('totalUsers').textContent = '0';
            document.getElementById('completedStakes').textContent = '0';
            document.getElementById('avgStakeAmount').textContent = '0.0000';
            document.getElementById('totalStakeCount').textContent = '0';
            return;
        }
        
        // è®¡ç®—å”¯ä¸€ç”¨æˆ·æ•°
        const uniqueUsers = new Set();
        allStakeData.forEach(record => uniqueUsers.add(record.userAddress));
        document.getElementById('totalUsers').textContent = uniqueUsers.size;
        
        // è®¡ç®—å·²èµå›æ•°é‡
        const completedStakes = allStakeData.filter(record => record.isActive).length;
        document.getElementById('completedStakes').textContent = completedStakes;
        
        // è®¡ç®—æ€»è´¨æŠ¼æ¬¡æ•°
        document.getElementById('totalStakeCount').textContent = allStakeData.length;
        
        // è®¡ç®—å¹³å‡è´¨æŠ¼é‡‘é¢
        const totalAmount = allStakeData.reduce((sum, record) => {
            return sum + parseFloat(ethers.formatUnits(record.amount, 18));
        }, 0);
        
        const avgAmount = totalAmount / allStakeData.length;
        document.getElementById('avgStakeAmount').textContent = avgAmount.toFixed(2);
    }
    
    // æ¸²æŸ“æ€»è´¨æŠ¼åˆ—è¡¨
    function renderAllStakeList() {
        const tbody = document.getElementById('allStakeListBody');
        
        if (filteredAllStakeData.length === 0) {
            let emptyText = 'æš‚æ— è´¨æŠ¼è®°å½•';
            if (allStakeFilter === 'completed') {
                emptyText = 'æš‚æ— å·²èµå›çš„è®°å½•';
            } else if (allStakeFilter === 'active') {
                emptyText = 'æš‚æ— è´¨æŠ¼ä¸­çš„è®°å½•';
            }
            
            tbody.innerHTML = `<tr><td colspan="6" class="text-center">${emptyText}</td></tr>`;
            return;
        }
        
        // æŒ‰è´¨æŠ¼æ—¶é—´å€’åºæ’åº
        filteredAllStakeData.sort((a, b) => b.stakeTime - a.stakeTime);
        
        // è®¡ç®—åˆ†é¡µ
        const startIndex = (currentPage - 1) * TOTAL_STAKE_PAGE_SIZE;
        const endIndex = Math.min(startIndex + TOTAL_STAKE_PAGE_SIZE, filteredAllStakeData.length);
        const pageData = filteredAllStakeData.slice(startIndex, endIndex);
        
        let html = '';
        
        pageData.forEach((record, index) => {
            const globalIndex = startIndex + index;
            const amount = formatAmount(record.amount);
            const stakeTimeStr = formatStakeTime(record.stakeTime);
            const durationLabel = STAKE_DURATION_LABELS[record.stakeIndex] || "æœªçŸ¥";
            const status = record.isActive ? "å·²èµå›" : "è´¨æŠ¼ä¸­";
            const statusClass = record.isActive ? "text-muted" : "text-success";
            const isCurrentUser = record.userAddress.toLowerCase() === (userAddress || '').toLowerCase();
            
            html += `
                <tr>
                    <td>${globalIndex + 1}</td>
                    <td>
                        <span class="address-short">${shortenAddress(record.userAddress)}</span>
                        ${isCurrentUser ? '<span class="badge bg-info ms-2">æˆ‘</span>' : ''}
                    </td>
                    <td>${amount}</td>
                    <td><span class="badge-duration">${durationLabel}</span></td>
                    <td class="stake-time-cell">${stakeTimeStr}</td>
                    <td class="status-cell"><span class="${statusClass}">${status}</span></td>
                </tr>
            `;
        });
        
        tbody.innerHTML = html;
    }
    
    // æ›´æ–°åˆ†é¡µæ§ä»¶
    function updatePagination() {
        totalPages = Math.ceil(filteredAllStakeData.length / TOTAL_STAKE_PAGE_SIZE);
        
        document.getElementById('currentPage').textContent = currentPage;
        document.getElementById('totalPages').textContent = totalPages;
        
        document.getElementById('prevPageBtn').disabled = currentPage <= 1;
        document.getElementById('nextPageBtn').disabled = currentPage >= totalPages;
    }
    
    // ä¸Šä¸€é¡µ
    function prevPage() {
        if (currentPage > 1) {
            currentPage--;
            renderAllStakeList();
            updatePagination();
        }
    }
    
    // ä¸‹ä¸€é¡µ
    function nextPage() {
        if (currentPage < totalPages) {
            currentPage++;
            renderAllStakeList();
            updatePagination();
        }
    }

    // æ·»åŠ ç½‘ç»œæ£€æŸ¥å‡½æ•°
    async function checkNetwork() {
        if (!window.ethereum) {
            throw new Error("æœªæ£€æµ‹åˆ°ä»¥å¤ªåŠé’±åŒ…");
        }
        
        try {
            const chainId = await window.ethereum.request({ method: 'eth_chainId' });
            const bscChainId = '0x38'; // BSCä¸»ç½‘
            const bscTestnetChainId = '0x61'; // BSCæµ‹è¯•ç½‘
            
            if (chainId !== bscChainId && chainId !== bscTestnetChainId) {
                const switchConfirm = confirm("å½“å‰ç½‘ç»œä¸æ˜¯BSCç½‘ç»œï¼Œæ˜¯å¦åˆ‡æ¢åˆ°BSCä¸»ç½‘ï¼Ÿ");
                if (switchConfirm) {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: bscChainId }],
                        });
                    } catch (switchError) {
                        // å¦‚æœç½‘ç»œæœªæ·»åŠ ï¼Œå°è¯•æ·»åŠ BSCç½‘ç»œ
                        if (switchError.code === 4902) {
                            await window.ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [{
                                    chainId: bscChainId,
                                    chainName: 'BNB Smart Chain Mainnet',
                                    nativeCurrency: {
                                        name: 'BNB',
                                        symbol: 'BNB',
                                        decimals: 18
                                    },
                                    rpcUrls: ['https://bsc-dataseed.binance.org/'],
                                    blockExplorerUrls: ['https://bscscan.com/']
                                }]
                            });
                        } else {
                            throw switchError;
                        }
                    }
                } else {
                    throw new Error("è¯·åœ¨BSCç½‘ç»œä¸­è¿›è¡Œæ“ä½œ");
                }
            }
        } catch (error) {
            console.error("ç½‘ç»œæ£€æŸ¥å¤±è´¥:", error);
            if (error.code === 4001) {
                throw new Error("ç”¨æˆ·æ‹’ç»åˆ‡æ¢ç½‘ç»œ");
            } else {
                throw error;
            }
        }
    }
    
    // é¡µé¢å¸è½½æ—¶æ¸…ç†å®šæ—¶å™¨
    window.addEventListener('beforeunload', () => {
        Object.keys(countdownTimers).forEach(id => {
            clearInterval(countdownTimers[id]);
        });
    });

    // åˆå§‹è¿æ¥é’±åŒ…
    window.addEventListener('load', () => {
        if (typeof window.ethereum !== 'undefined') {
            // æ£€æŸ¥æ˜¯å¦å·²è¿æ¥
            window.ethereum.request({ method: 'eth_accounts' })
                .then(accounts => {
                    if (accounts.length > 0) {
                        connectWallet();
                    }
                });
        }
    });
</script>
<script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon='{"version":"2024.11.0","token":"65a056423e6e441d8a24f89a02024cd8","r":1,"server_timing":{"name":{"cfCacheStatus":true,"cfEdge":true,"cfExtPri":true,"cfL4":true,"cfOrigin":true,"cfSpeedBrain":true},"location_startswith":null}}' crossorigin="anonymous"></script>
</body>
</html>