<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DRPæ–°ç‰ˆè´¨æŠ¼ç®¡ç†</title>
    <!-- å¼•å…¥ Bootstrap ç”¨äºå¿«é€Ÿå¸ƒå±€ -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- å¼•å…¥ Ethers.js V6 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <style>
        /* ================= ã€å…¨å±€æ ·å¼è®¾ç½®ã€‘ ================= */
        body { 
            background-color: #0f172a; 
            color: #e2e8f0; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
        }
        .card { 
            background-color: #1e293b; 
            border: 1px solid #334155; 
        }
        .card-title { 
            color: #fff; 
        }
        .btn-primary { 
            background-color: #3b82f6; 
            border: none; 
        }
        .btn-primary:hover { 
            background-color: #2563eb; 
        }
        .btn-success { 
            background-color: #10b981; 
            border: none; 
        }
        .btn-warning { 
            background-color: #f59e0b; 
            border: none; 
            color: #fff; 
        }
        .stat-value { 
            font-size: 1.25rem; 
            font-weight: bold; 
            color: #38bdf8; 
        }
        .stat-label { 
            font-size: 0.85rem; 
            color: #94a3b8; 
        }
        
        /* ================= ã€è´¨æŠ¼æ“ä½œåŒºåŸŸç¾åŒ–æ ·å¼ã€‘ ================= */
        .stake-operation-card {
            background: linear-gradient(145deg, #0d2739, #123047);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .stake-operation-title {
            font-size: 1.1rem;
            font-weight: bold;
            color: #fff;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .stake-input-group {
            margin-bottom: 15px;
        }
        
        .stake-input-label {
            font-size: 0.9rem;
            color: #94a3b8;
            margin-bottom: 8px;
            display: block;
        }
        
        .stake-amount-input {
            width: 100%;
            padding: 12px;
            background-color: #1e293b;
            border: 1px solid #475569;
            border-radius: 8px;
            color: white;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .stake-amount-input:focus {
            outline: none;
            border-color: #0d9488;
            box-shadow: 0 0 0 2px rgba(13, 148, 136, 0.2);
        }
        
        .duration-buttons {
            display: flex;
            gap: 6px;
            margin-bottom: 10px;
        }
        
        /* ================= ã€è´¨æŠ¼å‘¨æœŸæŒ‰é’®æ ·å¼ - æ‰‹æœºç«¯ä¼˜åŒ–ã€‘ ================= */
        .duration-btn {
            flex: 1;
            padding: 10px 4px;
            background: linear-gradient(145deg, #1e293b, #0f172a);
            border: 2px solid #334155;
            border-radius: 8px;
            color: #94a3b8;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            min-width: 60px; /* ã€è°ƒæ•´ç‚¹ï¼šæŒ‰é’®æœ€å°å®½åº¦ã€‘ */
        }
        
        .duration-btn:hover {
            border-color: #0d9488;
            color: #0d9488;
            transform: translateY(-2px);
        }
        
        .duration-btn.active {
            background: linear-gradient(90deg, #0d9488, #0a6c5f);
            border-color: #0d9488;
            color: white;
            box-shadow: 0 4px 12px rgba(13, 148, 136, 0.3);
        }
        
        .stake-action-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(90deg, #0d9488, #0a6c5f);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .stake-action-btn:hover {
            background: linear-gradient(90deg, #0a6c5f, #0d9488);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(13, 148, 136, 0.4);
        }
        
        /* ================= ã€è´¨æŠ¼è®°å½•å¡ç‰‡æ ·å¼ - åŸºäºæ–‡æ¡£1çš„é»„è‰²ä¸»é¢˜ä¼˜åŒ–ã€‘ ================= */
        /* å¡ç‰‡å®¹å™¨ç½‘æ ¼å¸ƒå±€ */
        .cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 15px; /* å‡å°‘å¡ç‰‡ä¹‹é—´çš„è¡Œé—´éš™ */
            margin-top: 15px; /* å‡å°‘é¡¶éƒ¨é—´è· */
        }
        
        /* å¡ç‰‡æ•´ä½“æ ·å¼ */
        .stake-card {
            background: linear-gradient(145deg, #0d9488, #134e4a);
            border-radius: 12px;
            padding: 18px; /* ç¨å¾®å‡å°‘å†…è¾¹è· */
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
            position: relative;
            overflow: hidden;
            border: 1px solid #14b8a6;
            line-height: 1.4; /* è°ƒæ•´è¡Œè·ï¼Œè®©æ–‡å­—æ›´ç´§å‡‘ */
        }
        
        /* é¡¶éƒ¨åŒºåŸŸï¼šç¼–å· | æœŸé™ | é‡‘é¢ */
        .card-top-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px; /* å‡å°‘åº•éƒ¨é—´è· */
            padding-bottom: 12px; /* å‡å°‘padding */
            border-bottom: 1px solid rgba(255, 255, 255, 0.15);
        }
        
        .card-id {
            font-size: 0.85rem; /* ç¨å¾®å‡å°å­—ä½“ */
            color: #cbd5e1;
            font-weight: 500;
            background: rgba(0, 0, 0, 0.2);
            padding: 4px 10px; /* å‡å°‘å†…è¾¹è· */
            border-radius: 20px;
        }
        
        .card-duration {
            font-size: 1.3rem; /* ç¨å¾®å‡å°å­—ä½“ */
            font-weight: 600;
            color: #ffffff;
        }
        
        .card-amount {
            font-size: 1.3rem; /* ç¨å¾®å‡å°å­—ä½“ */
            font-weight: 600;
            color: #ffffff;
        }
        
        /* ä¸­é—´åŒºåŸŸï¼šæ—¶é—´å’Œå‰©ä½™æ—¶é—´ */
        .card-middle-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px; /* å‡å°‘é—´è· */
        }
        
        .stake-time {
            font-size: 1.1rem; /* ç¨å¾®å‡å°å­—ä½“ */
            color: #ffffff;
            font-weight: 500;
        }
        
        .remaining-time {
            font-size: 0.95rem; /* ç¨å¾®å‡å°å­—ä½“ */
            color: #ffffff;
        }
        
        /* è¿›åº¦æ¡åŒºåŸŸ - æ”¹ä¸ºé»„è‰² */
        .progress-container {
            margin-bottom: 20px; /* å‡å°‘é—´è· */
        }
        
        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px; /* å‡å°‘é—´è· */
        }
        
        .progress-label {
            font-size: 0.85rem; /* ç¨å¾®å‡å°å­—ä½“ */
            color: #cbd5e1;
        }
        
        .progress-percentage {
            font-size: 0.85rem; /* ç¨å¾®å‡å°å­—ä½“ */
            color: #ffffff;
            font-weight: 500;
        }
        
        .progress-bar {
            height: 8px; /* ç¨å¾®å‡å°é«˜åº¦ */
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            border-radius: 4px;
        }
        
        /* æŒ‰é’®åŒºåŸŸ - è°ƒæ•´å®½åº¦ */
        .button-container {
            display: flex;
            justify-content: space-between;
            gap: 12px; /* å‡å°‘æŒ‰é’®é—´éš™ */
        }
        
        .btn {
            flex: none;
            width: 130px; /* ç¨å¾®å‡å°å®½åº¦ */
            color: white;
            border: none;
            padding: 10px 0; /* å‡å°‘å†…è¾¹è· */
            border-radius: 8px;
            font-size: 0.95rem; /* ç¨å¾®å‡å°å­—ä½“ */
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        /* é”å®šä¸­æŒ‰é’®æ ·å¼ - çº¢è‰² */
        .btn-locked {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }
        
        .btn-locked:hover:not(:disabled) {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            transform: translateY(-2px);
        }
        
        /* å¯èµå›æŒ‰é’®æ ·å¼ - ç»¿è‰² */
        .btn-redeemable {
            background: linear-gradient(135deg, #10b981, #059669);
        }
        
        .btn-redeemable:hover:not(:disabled) {
            background: linear-gradient(135deg, #059669, #047857);
            transform: translateY(-2px);
        }
        
        /* å·²æå–æŒ‰é’®æ ·å¼ - ç°è‰² */
        .btn-extracted {
            background: linear-gradient(135deg, #6b7280, #4b5563);
            cursor: not-allowed;
        }
        
        /* ç­‰å¾…è§£é”æŒ‰é’®æ ·å¼ - ç°è‰² */
        .btn-waiting {
            background: linear-gradient(135deg, #6b7280, #4b5563);
            cursor: not-allowed;
        }
        
        /* ç«‹å³èµå›æŒ‰é’®æ ·å¼ - æ”¹ä¸ºé»„è‰²ï¼Œæ›´æ˜¾çœ¼ */
        .btn-redeem-now {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: #1c1917;
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
        }
        
        .btn-redeem-now:hover:not(:disabled) {
            background: linear-gradient(135deg, #d97706, #b45309);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(245, 158, 11, 0.4);
        }
        
        /* å·²èµå›æŒ‰é’®æ ·å¼ - ç°è‰² */
        .btn-redeemed {
            background: linear-gradient(135deg, #6b7280, #4b5563);
            cursor: not-allowed;
        }
        
        /* ç¦ç”¨çŠ¶æ€ */
        .btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none !important;
        }
        
        /* ç©ºçŠ¶æ€æ ·å¼ */
        .stake-empty-state {
            grid-column: 1 / -1;
            text-align: center;
            padding: 25px 12px; /* å‡å°‘å†…è¾¹è· */
            color: #94a3b8;
            background-color: rgba(30, 41, 59, 0.5);
            border-radius: 8px;
            border: 2px dashed #475569;
        }
        
        .stake-empty-icon {
            font-size: 1.8rem; /* ç¨å¾®å‡å°å›¾æ ‡ */
            margin-bottom: 8px; /* å‡å°‘é—´è· */
            color: #475569;
        }
        
        .stake-empty-text {
            font-size: 0.85rem; /* ç¨å¾®å‡å°å­—ä½“ */
            margin-bottom: 4px; /* å‡å°‘é—´è· */
        }
        
        .stake-empty-subtext {
            font-size: 0.75rem; /* ç¨å¾®å‡å°å­—ä½“ */
            color: #64748b;
        }
        
        /* ã€çŠ¶æ€ç­›é€‰æŒ‰é’®æ ·å¼ã€‘ */
        .status-filter {
            display: flex;
            gap: 6px; /* å‡å°‘ç­›é€‰æŒ‰é’®é—´éš™ */
            margin-bottom: 12px; /* å‡å°‘åº•éƒ¨é—´è· */
            flex-wrap: wrap;
        }
        
        .status-filter-btn {
            font-size: 0.95rem;  /* è°ƒæ•´æ­¤å€¼æ”¹å˜å­—ä½“å¤§å° */
            padding: 3px 10px; /* å‡å°‘å†…è¾¹è· */
            border-radius: 20px;
            border: 1px solid #475569;
            background-color: #1e293b;
            color: #94a3b8;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .status-filter-btn:hover {
            border-color: #3b82f6;
            color: #3b82f6;
        }
        
        .status-filter-btn.active {
            background-color: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        
        /* ================= ã€å“åº”å¼è°ƒæ•´ - æ‰‹æœºç«¯ä¼˜åŒ–ã€‘ ================= */
        @media (max-width: 768px) {
            /* æ‰‹æœºç«¯å¡ç‰‡å¸ƒå±€ */
            .cards-container {
                grid-template-columns: 1fr;
            }
            
            /* æ‰‹æœºç«¯æŒ‰é’®è¿›ä¸€æ­¥ç¼©å° */
            .duration-buttons {
                flex-wrap: nowrap; /* ç¡®ä¿ä¸æ¢è¡Œ */
                gap: 4px; /* å‡å°‘é—´è· */
            }
            
            .duration-btn {
                padding: 8px 3px;
                font-size: 0.8rem;
                min-width: 50px; /* æ‰‹æœºç«¯è¿›ä¸€æ­¥ç¼©å° */
            }
            
            /* æ‰‹æœºç«¯å¡ç‰‡å†…å­—ä½“å¤§å° */
            .card-duration, .card-amount {
                font-size: 1.1rem; /* æ‰‹æœºç«¯å­—ä½“å¤§å°è°ƒæ•´ */
            }
            
            .stake-time {
                font-size: 0.95rem; /* æ‰‹æœºç«¯å­—ä½“å¤§å°è°ƒæ•´ */
            }
            
            /* æ‰‹æœºç«¯è¿›ä¸€æ­¥ç¼©å°æŒ‰é’® */
            .btn {
                width: 110px; /* æ‰‹æœºç«¯æŒ‰é’®å®½åº¦è¿›ä¸€æ­¥è°ƒæ•´ */
                font-size: 0.9rem;
                padding: 8px 0;
            }
            
            .button-container {
                gap: 8px; /* æ‰‹æœºç«¯æŒ‰é’®é—´è·è¿›ä¸€æ­¥å‡å° */
            }
        }
        
        @media (min-width: 769px) and (max-width: 1200px) {
            /* å¹³æ¿ç«¯æ˜¾ç¤ºåˆ—æ•° */
            .cards-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (min-width: 1201px) {
            /* æ¡Œé¢ç«¯æ˜¾ç¤ºåˆ—æ•° */
            .cards-container {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        /* ã€æ€»ç»Ÿè®¡æ•°æ®å¡ç‰‡æ ·å¼ã€‘ */
        .total-stats-card { 
            border-left: 4px solid #3b82f6; 
        }
    </style>
</head>
<body>

<div class="container py-4">
    <!-- ã€é’±åŒ…è¿æ¥åŒºåŸŸã€‘ -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="fw-bold">DRP Staking</h3>
        <button id="connectBtn" class="btn btn-primary" onclick="connectWallet()">è¿æ¥é’±åŒ…</button>
    </div>

    <!-- ã€æ•°æ®ç»Ÿè®¡é¢æ¿ã€‘ -->
    <div class="row mb-4 text-center g-2">
        <div class="col-6 col-md-3">
            <div class="card p-3 h-100">
                <div class="stat-label">æˆ‘çš„ USDT ä½™é¢</div>
                <div class="stat-value" id="myBalance">0.0000</div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card p-3 h-100">
                <div class="stat-label">å¾…æç°ä½™é¢ (åˆçº¦å†…)</div>
                <div class="stat-value" id="stakedBalance">0.0000</div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card p-3 h-100">
                <div class="stat-label">å¯æç° USDT (æ± å­)</div>
                <div class="stat-value" id="poolBalance">0.0000</div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card p-3 h-100 total-stats-card">
                <div class="stat-label">åˆçº¦æ€»è´¨æŠ¼</div>
                <div class="stat-value" id="totalStaked">0.0000</div>
            </div>
        </div>
    </div>

    <!-- ã€è´¨æŠ¼æ“ä½œåŒºåŸŸ - ç®€åŒ–ç‰ˆæ ·å¼ã€‘ -->
    <div class="stake-operation-card">
        <div class="stake-operation-title">å‚ä¸è´¨æŠ¼</div>
        
        <div class="stake-input-group">
            <label class="stake-input-label">è´¨æŠ¼é‡‘é¢ (USDT)</label>
            <input type="number" class="stake-amount-input" id="stakeAmount" value="1000" placeholder="è¾“å…¥é‡‘é¢">
        </div>
        
        <div class="duration-selection">
            <label class="stake-input-label">é€‰æ‹©è´¨æŠ¼å‘¨æœŸ</label>
            <div class="duration-buttons">
                <button class="duration-btn active" onclick="selectDuration(1, this)">1å¤©</button>
                <button class="duration-btn" onclick="selectDuration(15, this)">15å¤©</button>
                <button class="duration-btn" onclick="selectDuration(30, this)">30å¤©</button>
            </div>
        </div>
        
        <button class="stake-action-btn" onclick="handleStake()">ç«‹å³è´¨æŠ¼</button>
    </div>

    <!-- ã€æˆ‘çš„è´¨æŠ¼è®°å½•åŒºåŸŸ - ä½¿ç”¨æ–‡æ¡£1çš„é»„è‰²ä¸»é¢˜ä¼˜åŒ–å¸ƒå±€ã€‘ -->
    <div class="card">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="card-title mb-0">æˆ‘çš„è´¨æŠ¼è®°å½•</h5>
                <div>
                    <button class="btn btn-sm btn-outline-light" onclick="refreshData()">åˆ·æ–°æ•°æ®</button>
                </div>
            </div>
            
            <!-- ã€çŠ¶æ€ç­›é€‰ã€‘ -->
            <div class="status-filter">
                <button class="status-filter-btn active" onclick="filterMyStakes('active')">è´¨æŠ¼ä¸­</button>
                <button class="status-filter-btn" onclick="filterMyStakes('completed')">å·²èµå›</button>
                <button class="status-filter-btn" onclick="filterMyStakes('all')">å…¨éƒ¨è®°å½•</button>
            </div>
            
            <!-- ã€å¡ç‰‡å¼å¸ƒå±€å®¹å™¨ - ä½¿ç”¨æ–‡æ¡£1çš„æ ·å¼ã€‘ -->
            <div id="stakeCardsContainer" class="cards-container">
                <div class="stake-empty-state">
                    <div class="stake-empty-icon">ğŸ“Š</div>
                    <div class="stake-empty-text">æš‚æ— è´¨æŠ¼è®°å½•</div>
                    <div class="stake-empty-subtext">è¿æ¥é’±åŒ…åï¼Œæ‚¨çš„è´¨æŠ¼è®°å½•å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- å¼•å…¥ Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // ================= ã€é…ç½®åŒºåŸŸ - éœ€è¦æ›¿æ¢çš„åœ°æ–¹ã€‘ =================
    // ã€æ³¨æ„ï¼šå¦‚æœè¦æ›´æ¢åˆçº¦åœ°å€ï¼Œéœ€è¦ä¿®æ”¹ä»¥ä¸‹ä¸‰ä¸ªåœ°å€ã€‘
    const CONFIG = {
        STAKING: "0x7E1882b471F627Ba75935BCb12105545Eb8b4227",  // ã€DRPè´¨æŠ¼åˆçº¦åœ°å€ã€‘
        USDT: "0x55d398326f99059fF775485246999027B3197955",    // ã€USDTä»£å¸åœ°å€ã€‘
        PAIR: "0xAB71C14094575C6ec8f2e61C708D5f4A3c3d5ca0"     // ã€æµåŠ¨æ€§æ± åœ°å€ã€‘
    };
    
    // ã€è´¨æŠ¼å‘¨æœŸé…ç½® (ç§’)ã€‘
    const STAKE_DURATIONS = {
        0: 86400,      // 1å¤©
        1: 1296000,    // 15å¤© (15 * 86400)
        2: 2592000     // 30å¤© (30 * 86400)
    };
    
    const STAKE_DURATION_LABELS = {
        0: "1å¤©",
        1: "15å¤©", 
        2: "30å¤©"
    };
    // ============================================================

    // ================= ã€ABIé…ç½® - éœ€è¦æ›¿æ¢çš„åœ°æ–¹ã€‘ =================
    // ã€USDTä»£å¸ABIã€‘
    const ABI_ERC20 = [
        "function balanceOf(address owner) view returns (uint256)",
        "function decimals() view returns (uint8)",
        "function approve(address spender, uint256 amount) returns (bool)",
        "function allowance(address owner, address spender) view returns (uint256)"
    ];

    // ã€DRPè´¨æŠ¼åˆçº¦ABIã€‘
    const ABI_STAKING = [
        "function totalSupply() view returns (uint256)",
        "function balanceOf(address account) view returns (uint256)",
        "function stake(uint160 _amount, uint256 amountOutMin, uint8 _stakeIndex)",
        "function unstake(uint256 index)",
        "function stakeCount(address user) view returns (uint256)",
        'function maxStakeAmount() view returns (uint256)',
        "function userStakeRecord(address user, uint256 index) view returns (uint40 stakeTime, uint160 amount, bool status, uint8 stakeIndex)"
    ];
    // ============================================================

    // å…¨å±€å˜é‡
    let provider, signer, userAddress;
    let stakingContract, usdtContract;
    let countdownTimers = {};
    let selectedDuration = 1; // é»˜è®¤é€‰æ‹©1å¤©
    
    // ç­›é€‰çŠ¶æ€
    let myStakeFilter = 'active'; // æˆ‘çš„è´¨æŠ¼è®°å½•ç­›é€‰ï¼šactive=è´¨æŠ¼ä¸­, completed=å·²èµå›, all=å…¨éƒ¨

    // å·¥å…·å‡½æ•°
    function formatAmount(wei) {
        const val = ethers.formatUnits(wei, 18);
        return parseFloat(val).toFixed(0);
    }

    function formatTimeRemaining(seconds) {
        if (seconds <= 0) return "0ç§’";
        const days = Math.floor(seconds / 86400);
        const hours = Math.floor((seconds % 86400) / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        let result = "";
        if (days > 0) result += `${days}å¤©`;
        if (hours > 0) result += `${hours}å°æ—¶`;
        if (minutes > 0 && days === 0) result += `${minutes}åˆ†`;
        return result || "0ç§’";
    }

    function formatStakeTime(timestamp) {
        const date = new Date(timestamp * 1000);
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const day = date.getDate().toString().padStart(2, '0');
        const hour = date.getHours().toString().padStart(2, '0');
        const minute = date.getMinutes().toString().padStart(2, '0');
        return `${month}/${day} ${hour}:${minute}`;
    }

    function calculateProgress(stakeTime, durationSeconds) {
        const now = Math.floor(Date.now() / 1000);
        const elapsedTime = now - stakeTime;
        if (elapsedTime >= durationSeconds) return 100;
        return Math.min(100, Math.floor((elapsedTime / durationSeconds) * 100));
    }

    // æ ¹æ®çŠ¶æ€è·å–æŒ‰é’®é…ç½®
    function getButtonConfig(status) {
        switch(status) {
            case "locked":
                return {
                    leftBtn: {
                        text: "é”å®šä¸­",
                        class: "btn btn-locked",
                        disabled: false
                    },
                    rightBtn: {
                        text: "ç­‰å¾…è§£é”",
                        class: "btn btn-waiting",
                        disabled: true
                    },
                    progressColor: "linear-gradient(90deg, #fbbf24, #f59e0b)" // é»„è‰²æ¸å˜
                };
            case "redeemable":
                return {
                    leftBtn: {
                        text: "å¯èµå›",
                        class: "btn btn-redeemable",
                        disabled: false
                    },
                    rightBtn: {
                        text: "ç«‹å³èµå›",
                        class: "btn btn-redeem-now",
                        disabled: false
                    },
                    progressColor: "linear-gradient(90deg, #fbbf24, #f59e0b)" // é»„è‰²æ¸å˜
                };
            case "redeemed":
                return {
                    leftBtn: {
                        text: "å·²æå–",
                        class: "btn btn-extracted",
                        disabled: true
                    },
                    rightBtn: {
                        text: "å·²èµå›",
                        class: "btn btn-redeemed",
                        disabled: true
                    },
                    progressColor: "linear-gradient(90deg, #a1a1aa, #71717a)" // ç°è‰²æ¸å˜
                };
            default:
                return getButtonConfig("locked");
        }
    }

    // é€‰æ‹©è´¨æŠ¼å‘¨æœŸ
    function selectDuration(days, element) {
        selectedDuration = days;
        document.querySelectorAll('.duration-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        element.classList.add('active');
    }

    // ç­›é€‰æˆ‘çš„è´¨æŠ¼è®°å½•
    function filterMyStakes(filterType) {
        myStakeFilter = filterType;
        renderStakeCards();
    }

    // 1. è¿æ¥é’±åŒ…
    async function connectWallet() {
        if (!window.ethereum) {
            alert("è¯·å®‰è£… MetaMask!");
            return;
        }
        try {
            provider = new ethers.BrowserProvider(window.ethereum);
            signer = await provider.getSigner();
            userAddress = await signer.getAddress();
            
            document.getElementById('connectBtn').innerText = userAddress.slice(0, 6) + "..." + userAddress.slice(-4);
            document.getElementById('connectBtn').classList.replace('btn-primary', 'btn-success');

            stakingContract = new ethers.Contract(CONFIG.STAKING, ABI_STAKING, signer);
            usdtContract = new ethers.Contract(CONFIG.USDT, ABI_ERC20, signer);

            await refreshData();
        } catch (error) {
            console.error("è¿æ¥å¤±è´¥:", error);
            alert("è¿æ¥é’±åŒ…å¤±è´¥");
        }
    }

    // 2. åˆ·æ–°æ‰€æœ‰æ•°æ®
    async function refreshData() {
        if (!userAddress) return;
        const btn = document.querySelector('button[onclick="refreshData()"]');
        const originalText = btn.innerText;
        btn.innerText = "åŠ è½½ä¸­...";
        
        try {
            const myBal = await usdtContract.balanceOf(userAddress);
            document.getElementById('myBalance').innerText = formatAmount(myBal);

            const stakedBal = await stakingContract.balanceOf(userAddress);
            document.getElementById('stakedBalance').innerText = formatAmount(stakedBal);

            const poolBal = await usdtContract.balanceOf(CONFIG.PAIR);
            document.getElementById('poolBalance').innerText = formatAmount(poolBal);
            
            const totalStaked = await stakingContract.totalSupply();
            document.getElementById('totalStaked').innerText = formatAmount(totalStaked);

            await renderStakeCards();
            btn.innerText = "åˆ·æ–°";
        } catch (error) {
            console.error("æ•°æ®åŠ è½½é”™è¯¯:", error);
        } finally {
            btn.innerText = originalText;
        }
    }

    // 3. æ¸²æŸ“è´¨æŠ¼å¡ç‰‡ - ä½¿ç”¨æ–‡æ¡£1çš„å¸ƒå±€
    async function renderStakeCards() {
        const container = document.getElementById('stakeCardsContainer');
        container.innerHTML = '<div class="text-center py-3"><div class="loading-spinner"></div> åŠ è½½ä¸­...</div>';

        try {
            const count = await stakingContract.stakeCount(userAddress);
            
            if (Number(count) === 0) {
                container.innerHTML = `
                    <div class="stake-empty-state">
                        <div class="stake-empty-icon">ğŸ“Š</div>
                        <div class="stake-empty-text">æš‚æ— è´¨æŠ¼è®°å½•</div>
                        <div class="stake-empty-subtext">å¼€å§‹æ‚¨çš„ç¬¬ä¸€æ¬¡è´¨æŠ¼å§ï¼</div>
                    </div>
                `;
                return;
            }

            let html = '';
            const now = Math.floor(Date.now() / 1000);

            Object.keys(countdownTimers).forEach(id => {
                clearInterval(countdownTimers[id]);
                delete countdownTimers[id];
            });

            for (let i = Number(count) - 1; i >= 0; i--) {
                const record = await stakingContract.userStakeRecord(userAddress, i);
                
                const amount = parseFloat(ethers.formatUnits(record[1], 18));
                const stakeTime = Number(record[0]);
                const stakeTimeStr = formatStakeTime(stakeTime);
                const isActive = record[2]; 
                const stakeIndex = Number(record[3]);
                const durationSeconds = STAKE_DURATIONS[stakeIndex] || 86400;
                const durationLabel = STAKE_DURATION_LABELS[stakeIndex] || "æœªçŸ¥";
                
                const unlockTime = stakeTime + durationSeconds;
                const timeRemaining = unlockTime - now;
                const isLocked = timeRemaining > 0 && !isActive;
                const isUnlocked = timeRemaining <= 0 && !isActive;
                const progressPercent = calculateProgress(stakeTime, durationSeconds);
                
                let status = "locked";
                if (isActive) {
                    status = "redeemed";
                } else if (isUnlocked) {
                    status = "redeemable";
                }
                
                let shouldDisplay = false;
                if (myStakeFilter === 'all') shouldDisplay = true;
                else if (myStakeFilter === 'active') shouldDisplay = !isActive;
                else if (myStakeFilter === 'completed') shouldDisplay = isActive;
                
                if (!shouldDisplay) continue;

                const remainingTimeStr = isLocked ? formatTimeRemaining(timeRemaining) : 
                                          isUnlocked ? 'å·²è§£é”' : 'å·²å®Œæˆ';

                const btnConfig = getButtonConfig(status);

                html += `
                    <div class="stake-card" id="stake-card-${i}">
                        <!-- é¡¶éƒ¨åŒºåŸŸï¼šç¼–å· | æœŸé™ | é‡‘é¢ -->
                        <div class="card-top-row">
                            <div class="card-id">No.${i + 1}</div>
                            <div class="card-duration">${durationLabel}</div>
                            <div class="card-amount">${amount.toFixed(0)} USDT</div>
                        </div>
                        
                        <!-- ä¸­é—´åŒºåŸŸï¼šæ—¶é—´å’Œå‰©ä½™æ—¶é—´ -->
                        <div class="card-middle-row">
                            <div class="stake-time">${stakeTimeStr}</div>
                            <div class="remaining-time">${remainingTimeStr}</div>
                        </div>
                        
                        <!-- è¿›åº¦æ¡åŒºåŸŸ - ä½¿ç”¨é»„è‰² -->
                        <div class="progress-container">
                            <div class="progress-header">
                                <div class="progress-label">è´¨æŠ¼è¿›åº¦</div>
                                <div class="progress-percentage">${progressPercent}%</div>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="progress-${i}" style="width: ${progressPercent}%; background: ${btnConfig.progressColor};"></div>
                            </div>
                        </div>
                        
                        <!-- æŒ‰é’®åŒºåŸŸ -->
                        <div class="button-container">
                            <button class="${btnConfig.leftBtn.class}" ${btnConfig.leftBtn.disabled ? 'disabled' : ''} data-card-id="${i}" data-action="left">
                                ${btnConfig.leftBtn.text}
                            </button>
                            <button class="${btnConfig.rightBtn.class}" ${btnConfig.rightBtn.disabled ? 'disabled' : ''} data-card-id="${i}" data-action="right">
                                ${btnConfig.rightBtn.text}
                            </button>
                        </div>
                    </div>
                `;
                
                if (isLocked) {
                    startProgressCountdown(i, timeRemaining, durationSeconds);
                }
            }

            if (html === '') {
                let emptyText = 'æš‚æ— è´¨æŠ¼è®°å½•';
                if (myStakeFilter === 'active') emptyText = 'æš‚æ— è´¨æŠ¼ä¸­çš„è®°å½•';
                else if (myStakeFilter === 'completed') emptyText = 'æš‚æ— å·²èµå›çš„è®°å½•';
                
                container.innerHTML = `
                    <div class="stake-empty-state">
                        <div class="stake-empty-icon">ğŸ“Š</div>
                        <div class="stake-empty-text">${emptyText}</div>
                        <div class="stake-empty-subtext">${myStakeFilter === 'active' ? 'å¼€å§‹è´¨æŠ¼ä»¥åˆ›å»ºæ–°çš„è´¨æŠ¼è®°å½•' : 'å¼€å§‹æ‚¨çš„ç¬¬ä¸€æ¬¡è´¨æŠ¼å§ï¼'}</div>
                    </div>
                `;
            } else {
                container.innerHTML = html;
                attachButtonEvents();
            }
        } catch (error) {
            console.error("å¡ç‰‡åŠ è½½å¤±è´¥:", error);
            container.innerHTML = `
                <div class="stake-empty-state">
                    <div class="stake-empty-icon">âŒ</div>
                    <div class="stake-empty-text">åŠ è½½å¤±è´¥</div>
                    <div class="stake-empty-subtext">è¯·åˆ·æ–°é¡µé¢é‡è¯•</div>
                </div>
            `;
        }
    }

    // æ·»åŠ æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    function attachButtonEvents() {
        document.querySelectorAll('.btn:not(:disabled)').forEach(button => {
            button.addEventListener('click', function() {
                const cardId = this.getAttribute('data-card-id');
                const action = this.getAttribute('data-action');
                const buttonText = this.textContent;
                
                // ä¿å­˜åŸå§‹æ–‡æœ¬
                const originalText = this.textContent;
                
                // æ ¹æ®æŒ‰é’®æ–‡æœ¬æ‰§è¡Œä¸åŒæ“ä½œ
                if (buttonText === "é”å®šä¸­") {
                    this.textContent = "å¤„ç†ä¸­...";
                    setTimeout(() => {
                        this.textContent = originalText;
                        alert(`å¡ç‰‡ No.${parseInt(cardId)+1} çš„é”å®šçŠ¶æ€æ— æ³•æ›´æ”¹ï¼Œè¯·ç­‰å¾…è§£é”ã€‚`);
                    }, 1000);
                } else if (buttonText === "å¯èµå›") {
                    this.textContent = "æ£€æŸ¥ä¸­...";
                    setTimeout(() => {
                        this.textContent = originalText;
                        alert(`å¡ç‰‡ No.${parseInt(cardId)+1} çš„å¯èµå›çŠ¶æ€ç¡®è®¤ï¼Œè¯·ç‚¹å‡»"ç«‹å³èµå›"æŒ‰é’®è¿›è¡Œèµå›æ“ä½œã€‚`);
                    }, 1000);
                } else if (buttonText === "ç«‹å³èµå›") {
                    this.textContent = "èµå›ä¸­...";
                    handleUnstake(cardId);
                }
            });
        });
    }

    // å¯åŠ¨è¿›åº¦æ¡å€’è®¡æ—¶
    function startProgressCountdown(id, initialSeconds, totalSeconds) {
        let remaining = initialSeconds;
        const progressElement = document.getElementById(`progress-${id}`);
        const timeElement = document.querySelector(`#stake-card-${id} .remaining-time`);
        
        if (!progressElement || !timeElement) return;
        
        const timer = setInterval(() => {
            remaining--;
            
            if (remaining <= 0) {
                clearInterval(timer);
                refreshData();
                return;
            }
            
            timeElement.textContent = `å‰©ä½™: ${formatTimeRemaining(remaining)}`;
            
            const elapsedSeconds = totalSeconds - remaining;
            const progressPercent = Math.min(100, Math.floor((elapsedSeconds / totalSeconds) * 100));
            progressElement.style.width = `${progressPercent}%`;
            
            const percentElement = document.querySelector(`#stake-card-${id} .progress-percentage`);
            if (percentElement) percentElement.textContent = `${progressPercent}%`;
            
        }, 1000);
        
        countdownTimers[id] = timer;
    }

    // 4. è´¨æŠ¼é€»è¾‘
    async function handleStake() {
        if (!userAddress) {
            alert("è¯·å…ˆè¿æ¥é’±åŒ…");
            return;
        }
        
        const amountStr = document.getElementById('stakeAmount').value;
        if (!amountStr || parseFloat(amountStr) <= 0) {
            alert("è¯·è¾“å…¥æœ‰æ•ˆçš„è´¨æŠ¼é‡‘é¢");
            return;
        }
        
        const amount = parseFloat(amountStr);
        if (amount < 0.1) {
            alert("è´¨æŠ¼é‡‘é¢ä¸èƒ½å°äº0.1 USDT");
            return;
        }
        
        if (amount > 1000000) {
            alert("è´¨æŠ¼é‡‘é¢ä¸èƒ½è¶…è¿‡1,000,000 USDT");
            return;
        }
        
        try {
            const amountWei = ethers.parseUnits(amountStr, 18);
            const stakeBtn = document.querySelector('.stake-action-btn');
            const originalText = stakeBtn.textContent;
            
            try {
                stakeBtn.disabled = true;
                stakeBtn.textContent = "å¤„ç†ä¸­...";
                
                const myBal = await usdtContract.balanceOf(userAddress);
                if (myBal < amountWei) {
                    alert("USDTä½™é¢ä¸è¶³ï¼Œè¯·å…ˆå……å€¼");
                    throw new Error("ä½™é¢ä¸è¶³");
                }
                
                const allowance = await usdtContract.allowance(userAddress, CONFIG.STAKING);
                
                if (allowance < amountWei) {
                    stakeBtn.textContent = "æ­£åœ¨æˆæƒ USDT...";
                    const txApprove = await usdtContract.approve(CONFIG.STAKING, ethers.MaxUint256);
                    const receipt = await txApprove.wait();
                    await new Promise(resolve => setTimeout(resolve, 2000));
                }
                
                const dailyRates = {1: 0.5, 15: 0.8, 30: 1.3};
                const dailyRate = dailyRates[selectedDuration] || 0.5;
                const expectedProfit = (amount * (dailyRate / 100) * selectedDuration).toFixed(4);
                
                const confirmStake = confirm(
                    `ç¡®è®¤è´¨æŠ¼ ${amountStr} USDT\n` +
                    `è´¨æŠ¼å‘¨æœŸ: ${selectedDuration}å¤©\n` +
                    `æ—¥åŒ–åˆ©ç‡: ${dailyRate}%\n` +
                    `é¢„è®¡æ”¶ç›Š: ${expectedProfit} USDT\n` +
                    `\næ˜¯å¦ç»§ç»­ï¼Ÿ`
                );
                
                if (!confirmStake) throw new Error("ç”¨æˆ·å–æ¶ˆ");
                
                let stakeIndex = 0;
                if (selectedDuration === 1) stakeIndex = 0;
                else if (selectedDuration === 15) stakeIndex = 1;
                else if (selectedDuration === 30) stakeIndex = 2;
                
                stakeBtn.textContent = "æ­£åœ¨è´¨æŠ¼...";
                const txStake = await stakingContract.stake(amountWei, 0, stakeIndex, { gasLimit: 500000 });
                const receipt = await txStake.wait();
                
                if (receipt.status === 1) {
                    alert(`è´¨æŠ¼æˆåŠŸï¼å‘¨æœŸï¼š${selectedDuration}å¤©\né¢„è®¡æ”¶ç›Š: ${expectedProfit} USDT`);
                    await refreshData();
                } else {
                    throw new Error("äº¤æ˜“å¤±è´¥");
                }
                
            } catch (error) {
                console.error("è´¨æŠ¼è¿‡ç¨‹é”™è¯¯:", error);
                throw error;
            } finally {
                stakeBtn.disabled = false;
                stakeBtn.textContent = originalText;
            }
            
        } catch (error) {
            console.error("è´¨æŠ¼å¤±è´¥:", error);
            if (error.code === 4001) alert("ç”¨æˆ·æ‹’ç»äº†äº¤æ˜“");
            else if (error.reason) alert(`åˆçº¦é”™è¯¯: ${error.reason}`);
            else if (error.message !== "ç”¨æˆ·å–æ¶ˆ") alert(`é”™è¯¯: ${error.message || "æœªçŸ¥é”™è¯¯"}`);
        }
    }

    // 5. èµå›é€»è¾‘
    async function handleUnstake(index) {
        if (!userAddress) return;
        
        const btn = document.querySelector(`button[data-card-id="${index}"][data-action="right"]`);
        if(btn) {
            btn.disabled = true;
            btn.innerText = "å¤„ç†ä¸­...";
        }

        try {
            const tx = await stakingContract.unstake(index);
            await tx.wait();
            alert("èµå›æˆåŠŸï¼");
            refreshData();

        } catch (error) {
            console.error(error);
            if(btn) {
                btn.disabled = false;
                btn.innerText = "ç«‹å³èµå›";
            }
            if(error.reason) alert("åˆçº¦é”™è¯¯: " + error.reason);
            else alert("èµå›å¤±è´¥");
        }
    }

    // é¡µé¢å¸è½½æ—¶æ¸…ç†å®šæ—¶å™¨
    window.addEventListener('beforeunload', () => {
        Object.keys(countdownTimers).forEach(id => {
            clearInterval(countdownTimers[id]);
        });
    });

    // åˆå§‹è¿æ¥é’±åŒ…
    window.addEventListener('load', () => {
        if (typeof window.ethereum !== 'undefined') {
            window.ethereum.request({ method: 'eth_accounts' })
                .then(accounts => {
                    if (accounts.length > 0) connectWallet();
                });
        }
    });
</script>
</body>
</html>
